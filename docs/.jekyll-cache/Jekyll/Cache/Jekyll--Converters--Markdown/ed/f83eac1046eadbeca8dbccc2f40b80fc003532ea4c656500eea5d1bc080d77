I"¼i<p><span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    SemanticSegmentation
</span></p>

<h1 id="semantic-segmentationì—ì„œ-label-image-ìƒì„±í•˜ê¸°">Semantic Segmentationì—ì„œ Label Image ìƒì„±í•˜ê¸°</h1>

<p>semantic segmentationì€ ê°„ë‹¨í•˜ê²Œ ë³´ìë©´ <em>â€œ<strong>Image</strong>â€ - â€œ<strong>Image</strong>â€œ</em> ê´€ê³„ì˜ í•™ìŠµì…ë‹ˆë‹¤.</p>

<p>X ì…ë ¥ì—ëŠ” ë³´í†µ jpgë“  pngë“  ì½ì„ ìˆ˜ ìˆëŠ” Image fileì´ ë†“ì´ê³ ,<br />
Y ì…ë ¥(ì •ë‹µ)ì—ëŠ” ë³´í†µ png íŒŒì¼ì´ ì˜µë‹ˆë‹¤.</p>

<p>ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” <em><strong>ì–´ë–»ê²Œ í•˜ë©´ ë¼ë²¨ì— í•´ë‹¹ë˜ëŠ” Image file(.png)ë¥¼ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€?</strong></em> ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="0-intro"><strong>0. Intro</strong></h2>

<p>Semantic Segmentation Taskë¥¼ í•™ìŠµí•˜ëŠ”ë°ëŠ” 2ê°€ì§€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤:
<strong><em>(Input) X Data : í•™ìŠµí•  Image dataset
(Input) Y Data : í•™ìŠµí•  Imageì— ëŒ€ì‘ë˜ëŠ” Color Map Image file</em></strong></p>

<p>íŠ¹íˆ, Y Data ì˜ ê²½ìš°ì— â€œ<strong>JPG</strong>â€ í¬ë§·ì´ ì•„ë‹Œ â€œ<strong>PNG</strong>â€ í¬ë§·ì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>JPG í¬ë§·ì€ ì†ì‹¤ ì••ì¶•ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ìš©ëŸ‰ì´ ì‘ë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ
_<strong>ì‚¬ìš©ìì˜ ëˆˆì— ì¡íˆì§€ ì•ŠëŠ” íŠ¹ì • ë¶€ë¶„ì˜ Color ê°’ì´ ë³€ê²½ëœë‹¤ëŠ” íŠ¹ì§•</strong>_ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” Semantic Segmentationì˜ Label Imageë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ê³¼ ì¼ë°˜ì ì¸ Image Data ì™€ì˜ ì°¨ì´ì ì„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="1-about-semantic-segmentation"><strong>1. About Semantic Segmentation</strong></h2>
<p>ì‹œì‘í•˜ê¸°ì— ì•ì„œ, Semantic Segmentation Taskê°€ ì •í™•íˆ ì–´ë–¤ Taskì¸ì§€ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.
Semantic Segmentation Taskì˜ ê²½ìš°, 
<strong>ì „ì²´ ì´ë¯¸ì§€ì— ëŒ€í•´ ê°ê°ì˜ í”½ì…€ì´ ì–´ëŠ Label(=Category)ì— ì†í•˜ëŠ”ì§€ ë¶„ë¥˜í•˜ëŠ” ë¬¸ì œ</strong>ì…ë‹ˆë‹¤.</p>

<p>ì •êµí•œ ë¶„ë¥˜ë¥¼ í•´ë‚´ì•¼ í•˜ê¸° ë•Œë¬¸ì— <strong>Atrous Convolution</strong>ê³¼ ê°™ì€ <strong>Receptive Field(ìˆ˜ìš© ì˜ì—­, í•„í„°ê°€ í•œ ë²ˆì— ë³¼ ìˆ˜ ìˆëŠ” ì˜ì—­)</strong>ê°€ ë„“ì€ í•©ì„± ê³± ì—°ì‚°ì„ ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<dl>
  <dt><strong>DeepLab V3+</strong> ì½”ë“œ ì¤‘ì—ì„œ, ê°€ì¥ ì¤‘ìš”í•œ Loss Function êµ¬í˜„ ë¶€ë¶„ì„ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</dt>
  <dt>(Github Repository</dt>
  <dd>https://github.com/jfzhang95/pytorch-deeplab-xception)</dd>
</dl>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="k">class</span> <span class="nc">SegmentationLosses</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">batch_average</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ignore_index</span> <span class="o">=</span> <span class="n">ignore_index</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_average</span> <span class="o">=</span> <span class="n">batch_average</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cuda</span> <span class="o">=</span> <span class="n">cuda</span>

    <span class="k">def</span> <span class="nf">build_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'ce'</span><span class="p">):</span>
        <span class="s">"""Choices: ['ce' or 'focal']"""</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'ce'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">CrossEntropyLoss</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'focal'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">FocalLoss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">CrossEntropyLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">logit</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ignore_index</span><span class="p">,</span>
                                        <span class="n">reduction</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">cuda</span><span class="p">:</span>
            <span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_average</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">FocalLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">logit</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ignore_index</span><span class="p">,</span>
                                        <span class="n">reduction</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">cuda</span><span class="p">:</span>
            <span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="n">logpt</span> <span class="o">=</span> <span class="o">-</span><span class="n">criterion</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logpt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">logpt</span> <span class="o">*=</span> <span class="n">alpha</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pt</span><span class="p">)</span> <span class="o">**</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">logpt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_average</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></div>

<p>ìœ„ì˜ DeepLab V3+ Repositoryì— êµ¬í˜„ë˜ì–´ ìˆëŠ” Loss Function ì…ë‹ˆë‹¤.</p>

<p>ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” í•µì‹¬ì ì¸ ì½”ì–´ í•¨ìˆ˜ê°€ <strong>nn.CrossEntropyLoss</strong> ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Cross-Entropy Loss Function(ì´í•˜ <strong>CE Loss</strong>)ì€ Semantic Segmentation Task(ì´í•˜ <strong>ë¶„í•  ë¬¸ì œ</strong>)ì´ì „ì— ë¶„ë¥˜ ë¬¸ì œ(Classification)ì—ì„œ ìì£¼ ì“°ì´ëŠ” ì†ì‹¤ í•¨ìˆ˜ì…ë‹ˆë‹¤.</p>

<p>ê·¸ëŸ¼ ì™œ ë¶„ë¥˜ ë¬¸ì œì™€ ë¶„í•  ë¬¸ì œëŠ” ë‘˜ë‹¤ CE Lossë¥¼ ì“°ëŠ” ê²ƒì¼ê¹Œìš”?</p>

<blockquote>
  <p>1) ë¶„ë¥˜ ë¬¸ì œ(Classification) ì—ì„œëŠ” ì´ë¯¸ì§€ 1ì¥ ì „ì²´ì— ëŒ€í•œ Labelì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.
(ex. ì´ ì‚¬ì§„ì€ ê³ ì–‘ì´ ì‚¬ì§„ì…ë‹ˆë‹¤!)</p>

  <p>2) ë¶„í•  ë¬¸ì œ(Semantic Segmentation) ì—ì„œëŠ” ì´ë¯¸ì§€ 1ì¥ ë‚´ì˜ 1ê°œ í”½ì…€ì— ëŒ€í•œ Labelì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.
(ex. ì´ í”½ì…€ì€ ê³ ì–‘ì´ì— í•´ë‹¹í•˜ëŠ” í”½ì…€ì…ë‹ˆë‹¤!)</p>
</blockquote>

<p>ìœ„ì—ì„œ ì„œìˆ  í•˜ì˜€ë“¯ì´, ë‘ ë¬¸ì œ ëª¨ë‘ ë¶„ë¥˜ë¥¼ í•˜ê¸´ í•˜ì§€ë§Œ Classification ë¬¸ì œì˜ ê²½ìš°ëŠ” ì´ë¯¸ì§€ ì „ì²´ë¥¼ ë¶„ë¥˜í•˜ê³ ,
<strong>Semantic Segmentation ë¬¸ì œì˜ ê²½ìš°ëŠ” 1ê°œ í”½ì…€ì— ëŒ€í•´ì„œë§Œ ë¶„ë¥˜í•©ë‹ˆë‹¤.</strong></p>

<p>(ë¶„ë¥˜ ë¬¸ì œ ì‹ ê²½ë§ì—ì„œ, Batch Sizeê°€ 1ì´ë¼ê³  ê°€ì •í•œë‹¤ë©´ ë‹¨ìˆœíˆ 
True-Label 1ê°œì™€ Predicted-Label 1ê°œë¥¼ ë¹„êµí•˜ëŠ” ê²ƒì²˜ëŸ¼, 
True-Labelâ€™s 1â€“pixelê³¼ Predicted-Labelâ€™s 1-pixelì„ ë¹„êµí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
ì´ëŠ” ì´ë¯¸ì§€ì˜ width * height ìˆ˜ë§Œí¼ ë°˜ë³µë©ë‹ˆë‹¤.)</p>

<p>1ê°œ í”½ì…€ì´ë¼ê³  í•œë‹¤ë©´?
ì¼ë°˜ì ì¸ Color ImageëŠ” <strong>3ì±„ë„ì˜ RGB</strong> ê°’ì´ ë“¤ì–´ì˜¤ì§€ë§Œ, 
CE Lossë¥¼ ì‚¬ìš©í•˜ëŠ” ë¶„í•  ë¬¸ì œ íŠ¹ì„± ìƒ <strong>1ê°œ ì±„ë„ì˜ ê°’</strong>ì´ ë“¤ì–´ì˜¤ëŠ”ë° ì´ ê°’ì´ ë°”ë¡œ <strong>Label Value</strong>ê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>ìµœì¢…ì ìœ¼ë¡œ, Semantic Segmentation Taskì˜ í•™ìŠµ ë°©ì‹ì€</p>

<blockquote>
  <ol>
    <li>1ê°œ í”½ì…€ ë³„ë¡œ Label ê°’ì„ ë‹¤ë¥´ê²Œ ì¤€ë‹¤.(Dataset ì¸¡ë©´)</li>
    <li>CE Lossë¥¼ í†µí•´ ì†ì‹¤ ê°’ì„ êµ¬í•œë‹¤.</li>
    <li>Optimizer(SGD, Adam etc.)ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ì†ì‹¤ ê°’ì„ backward ë°©í–¥ìœ¼ë¡œ ê°€ì¤‘ì¹˜ë¥¼ ê°±ì‹ í•œë‹¤.</li>
  </ol>
</blockquote>

<p>3ë‹¨ê³„ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="2-cv2imwrite--vs-pascal-voc-annotation">2. cv2.imwrite( ) vs Pascal VOC Annotation</h2>
<p>Label Image ì œì‘ì— ì•ì„œ, ì‹¤ì œë¡œ</p>

<ul>
  <li>ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ cv2.imwriteë¥¼ ì‚¬ìš©í•˜ì—¬ ì €ì¥í•œ Label Image</li>
  <li>Pascal VOCì˜ Semantic Segmentation Taskì˜ Annotation Label Image</li>
</ul>

<p>ë¥¼ ë¹„êµí•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
(Pascal VOC Dataset : host.robots.ox.ac.uk/pascal/VOC/voc2007)</p>

<p><strong><em>Mac OS â€” file command in terminal</em></strong>
<img src="https://images.velog.io/images/bolero2/post/bf3c4130-3bc6-4d4e-bdd8-c013ff4cbeb0/command.png" alt="file command in terminal" /></p>

<p>ìœ„ ì´ë¯¸ì§€ëŠ” 2ê°œì˜ ì´ë¯¸ì§€ë¥¼ Terminal ìƒì—ì„œ file commandë¡œ ì½ì–´ì˜¨ ê²°ê³¼ì…ë‹ˆë‹¤.</p>

<p><strong><em>2009_001625.png â€” RAW Image file</em></strong><br />
<img src="https://images.velog.io/images/bolero2/post/166417ed-1203-4b76-a7c9-563b1ef34d5d/bottle1.png" alt="2009_001625.png" /></p>

<p><strong>2009_001625.png</strong> íŒŒì¼ì€ Pascal VOC Datasetì—ì„œ ê°€ì ¸ì˜¨ íŒŒì¼ì´ê³ ,
<strong>2009_001625_RGB.png</strong> íŒŒì¼ì€ cv2.imwrite( ) í•¨ìˆ˜ë¡œ ì €ì¥í•œ íŒŒì¼ì…ë‹ˆë‹¤.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">2009_001625.png(VOC IMAGE)</th>
      <th style="text-align: center">2009_001625_RGB.png(cv2.imwrite IMAGE)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://images.velog.io/images/bolero2/post/5a20712b-14a2-4374-a4b4-72e31dc1683d/bottle1.png" alt="2009_001625.png" /></td>
      <td style="text-align: center"><img src="https://images.velog.io/images/bolero2/post/5b4e2800-04c5-4cbb-a3d7-de24198f7da1/bottle1_RGB.png" alt="2009_001625_RGB.png" /></td>
    </tr>
  </tbody>
</table>

<p>ëª…ë ¹ì–´ ê²°ê³¼ë¥¼ ë³´ë©´, VOC ImageëŠ” 8-bit colormap íŒŒì¼ì´ì§€ë§Œ cv2.imwriteë¡œ ì €ì¥í•œ ImageëŠ” 8-bit/color RGB íŒŒì¼ì…ë‹ˆë‹¤.
ì‚¬ëŒì´ ë³´ê¸°ì—”, ìœ¡ì•ˆìƒìœ¼ë¡œëŠ” ì–´ë–¤ ì°¨ì´ê°€ ìˆì„ê¹Œìš”?</p>

<p>ì–´ë–¤ ì´ë¯¸ì§€ê°€ Pascal VOCì¸ì§€ ëª¨ë¥¼ ì •ë„ë¡œ ë„ˆë¬´ ìœ ì‚¬í•©ë‹ˆë‹¤â€¦
ìœ¡ì•ˆìƒìœ¼ë¡œë„ ì „í˜€ ì°¨ì´ì ì´ ì—†ìŠµë‹ˆë‹¤. 
ì°¨ì´ì ì´ë¼ê³ ëŠ” ìœ„ì—ì„œ ì–¸ê¸‰í•œ 8-bit colormapì´ëƒ, 8-bit/color RGB íŒŒì¼ì´ëƒ ì°¨ì´ì…ë‹ˆë‹¤.
ìš°ë¦¬ëŠ” ì—¬ê¸°ì„œ PNG í¬ë§·ì˜ íŠ¹ì„±ê³¼ Label Imageì™€ì˜ ê´€ê³„ì— ëŒ€í•´ ì•Œì•„ë³¼ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="3-png-format-and-segmentation-label-image">3. PNG Format <em>and</em> Segmentation Label Image</h2>
<p>PNG í¬ë§·ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” JPGì™€ ê°™ì€ ì†ì‹¤ì••ì¶• ë°©ì‹ì´ ì•„ë‹Œ,
ì›ë³¸ ê·¸ëŒ€ë¡œì˜ Color ê°’ì„ ì €ì¥í•©ë‹ˆë‹¤.</p>

<p>ê·¸ë¦¬ê³  ì•„ì£¼ ì¤‘ìš”í•œ íŠ¹ì§•ì´ í•˜ë‚˜ ë” ìˆëŠ”ë°, ë°”ë¡œ
<strong>Palette ì •ë³´ë¥¼ ë„£ì„ ìˆ˜ ìˆë‹¤ëŠ” ì </strong>ì…ë‹ˆë‹¤.</p>

<p>Palette ì •ë³´ê°€ ì´ë¯¸ì§€ì— ë“¤ì–´ê°€ê²Œ ë˜ë©´ Image ArrayëŠ” ë” ì´ìƒ 3ì±„ë„ì´ì–´ì•¼ í•  í•„ìš”ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤. ì´ë¥¼</p>

<blockquote>
  <p><strong>â€œIndexed Imageâ€</strong></p>
</blockquote>

<p>ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.</p>

<p>ë§ ê·¸ëŒ€ë¡œ <strong>â€œìƒ‰ì¸í™” ëœ ì´ë¯¸ì§€â€</strong> ì¸ ê²ƒì´ì£ .</p>

<p>Index ì •ë³´ëŠ” Paletteê°€ ë˜ëŠ” ê²ƒì´ê³ , Image Arrayì—ëŠ” ë‹¨ìˆœíˆ 1ì±„ë„ì˜ ê³µê°„ì— ìƒ‰ì¸ ì •ë³´(Index value)ë§Œ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.
ì¶”í›„ì— Paletteë¥¼ ë°”ê¾¸ê²Œ ë˜ë©´, Imageì˜ ìƒ‰ìƒ ê°’ë„ ë°”ë€Œê²Œ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p><strong>Semantic Segmentationì€ Pixelì— ëŒ€í•œ ë¼ë²¨ ê°’ì„ í•™ìŠµí•  ë•Œ, ì´ Index valueë¥¼ í•™ìŠµí•˜ê²Œ ë©ë‹ˆë‹¤.</strong></p>

<hr />

<h2 id="4-how-create-label-image">4. <em>How create</em>â€¦ Label Image?</h2>
<p>ìœ„ì—ì„œ 
<em>1) ì™œ PNG í¬ë§·ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€,</em>
<em>2) Indexed Imageë€ ë¬´ì—‡ì¸ì§€,</em>
<em>3) ì™œ cv2.imwrite( )ì™€ ê°™ì€ ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ë¡œ ì €ì¥í•˜ë©´ ì•ˆë˜ëŠ”ì§€</em>
ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.</p>

<p>ì´ì œëŠ” Polygon íƒ€ì…ì˜ Label Image (for Segmentation)ë¥¼ ì œì‘í•´ë³´ê² ìŠµë‹ˆë‹¤.
ì¤€ë¹„ë¬¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<blockquote>
  <ol>
    <li>Color Mapê³¼ Palette ì •ë³´</li>
    <li>ì €ì¥í•  Image ì •ë³´(file í˜•ì‹, numpy.ndarray í˜•ì‹ ëª¨ë‘ ìƒê´€ ì—†ìŠµë‹ˆë‹¤.)</li>
  </ol>
</blockquote>

<hr />

<p><strong><em>Color Mapì„ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</em></strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
 
<span class="k">def</span> <span class="nf">make_colormap</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">bit_get</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
       <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
 
   <span class="n">colormap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
   <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
 
   <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))):</span>
       <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
           <span class="n">colormap</span><span class="p">[:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">|=</span> <span class="n">bit_get</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span>
       <span class="n">ind</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span>
 
   <span class="k">return</span> <span class="n">colormap</span>
 
<span class="n">cmap</span> <span class="o">=</span> <span class="n">make_colormap</span><span class="p">(</span><span class="mi">256</span><span class="p">).</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">cmap</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">color</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">palette</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ì½”ë“œëŠ” Color Mapì„ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</p>

<p>Pascal VOCì—ì„œ í•´ë‹¹ ë°©ì‹ìœ¼ë¡œ Color Mapì„ ìƒì„±í•˜ì—¬ [20ê°œ ë¼ë²¨ + background] ê¹Œì§€ í•˜ì—¬ ì´ 21ê°œì˜ ìƒ‰ìƒ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>ìš°ë¦¬ê°€ ì € ì½”ë“œì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ëŠ” <strong>cmap</strong> ê³¼ <strong>palette</strong> ê°€ ìˆìŠµë‹ˆë‹¤.
<strong>cmap</strong> ì€ Imageì— ìƒ‰ì¸ ì •ë³´ë¥¼ ë„£ì–´ì¤„ ë•Œ ì‚¬ìš©í•  ê²ƒì´ê³ , 
<strong>palette</strong> ëŠ” PNG í¬ë§·ìœ¼ë¡œ ì €ì¥í•  ë•Œ ë„£ì–´ì¤„ íŒ”ë ˆíŠ¸ ì •ë³´ì…ë‹ˆë‹¤.</p>

<p>í•´ë‹¹ ì½”ë“œ ë™ì‘ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<blockquote>
  <p>[0, 0, 0, 128, 0, 0, 0, 128, 0, 128, 128, 0, 0, 0, 128, 128, 0, 128, 0, 128, 128, â€¦ ]</p>
</blockquote>

<p>ë³´ì‹œë‹¤ì‹œí”¼ ì•ì—ì„œ 3ê°œì”© ëŠì–´ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, 0ë²ˆ ë¼ë²¨(background)ì˜ ê²½ìš° RGB ê°’ì€ [0, 0, 0]ì´ ë  ê²ƒì´ê³ ,
1ë²ˆ ë¼ë²¨(aeroplane)ì˜ ê²½ìš° RGB ê°’ì€ [128, 0, 0]ì´ ë  ê²ƒì´ë©°, 
2ë²ˆ ë¼ë²¨(bicycle)ì˜ ê²½ìš° RGB ê°’ì€ [0, 128, 0]ì´ ë  ê²ƒì…ë‹ˆë‹¤.</p>

<p>(ì´ëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ê°’ì„ ë„£ì–´ì¤˜ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤. ë³¸ë¬¸ì—ì„œëŠ” Pascal VOC Datasetì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í—˜í•˜ì˜€ê¸° ë•Œë¬¸ì—, Pascal VOC Datasetì˜ Category ì •ë³´ì™€ ìƒ‰ìƒ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.)</p>

<hr />

<p>Color Mapê³¼ Palette ì •ë³´ë¥¼ ìƒì„±í•˜ì˜€ë‹¤ë©´, ì´ë¯¸ì§€ì— ìƒ‰ì¸ ì •ë³´ì™€ Paletteë¥¼ í•¨ê»˜ ë„£ì–´ì£¼ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<p><em><strong>Label Image ìƒì„± ì½”ë“œ</strong></em></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="c1"># Image data to save = image_data(numpy.ndarray)
</span><span class="n">label_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
 
<span class="c1"># if image array has BGR order
</span><span class="n">label_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">label_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<span class="c1"># Create an unsigned-int (8bit) empty numpy.ndarray of the same size (shape)
</span><span class="n">img_png</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">label_img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label_img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
 
<span class="c1"># Assign index to empty ndarray. Finding pixel location using np.where.
# If you don't use np.where, you have to run a double for-loop for each row/column.
</span><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">val_col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmap</span><span class="p">):</span>
    <span class="n">img_png</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">all</span><span class="p">(</span><span class="n">label_img</span> <span class="o">==</span> <span class="n">val_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="n">index</span>
 
<span class="c1"># Convert ndarray with index into Image object (P mode) of PIL package
</span><span class="n">img_png</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_png</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'P'</span><span class="p">)</span>
<span class="c1"># Palette information injection
</span><span class="n">img_png</span><span class="p">.</span><span class="n">putpalette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
<span class="c1"># save image
</span><span class="n">img_png</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="s">'output.png'</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ì½”ë“œëŠ” ì‹¤ì œë¡œ Label Imageë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</p>

<p>ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<blockquote>
  <ol>
    <li>image dataë¥¼ numpy.ndarray íƒ€ì…ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.</li>
    <li>BGR ìˆœì„œë¼ë©´ RGB ìˆœì„œë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤.</li>
    <li>ë™ì¼í•œ í¬ê¸°ì˜ unsigned-int (8bit) ndarrayë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
    <li><strong>ê° Color Mapì˜ ìƒ‰ìƒ ì •ë³´ë¥¼ ì°¾ì•„ì„œ, ìƒ‰ì¸í™” ê³¼ì •ì„ í•©ë‹ˆë‹¤.</strong>
(ì´ë¯¸ì§€ì˜ í”½ì…€ì„ ëŒë©° ë¹„êµí•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, Color Mapì˜ 1-Rowì— í•´ë‹¹í•˜ëŠ” ê°’ì„ í•œë²ˆì— ë°”ê¿”ì£¼ëŠ” í˜•ì‹ìœ¼ë¡œ í•©ë‹ˆë‹¤.)</li>
    <li>ìƒ‰ì¸í™” ëœ ì´ë¯¸ì§€ í–‰ë ¬ì„ â€˜Pâ€™ modeë¡œ ì €ì¥í•©ë‹ˆë‹¤.(<strong>P</strong> modeëŠ” <strong>Palette</strong> ëª¨ë“œì…ë‹ˆë‹¤.)</li>
    <li>ìœ„ì—ì„œ ìƒì„±í•œ Paletteë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤.</li>
    <li>png formatìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</li>
  </ol>
</blockquote>

<p>ì´ë ‡ê²Œ í•˜ë©´ Palette ì •ë³´ê°€ ìˆëŠ” ìƒ‰ì¸í™” ëœ ì´ë¯¸ì§€ íŒŒì¼ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë ‡ê²Œ ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼ì€ ë°”ë¡œ Semantic Segmentationì˜ í•™ìŠµì— ì‚¬ìš© ê°€ëŠ¥í•˜ë©°, Predict í•¨ìˆ˜ì—ì„œ ì¶œë ¥ëœ ê²°ê³¼ë¥¼ ì €ì¥í•  ë•Œë„ ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ì €ì¥í•˜ì—¬ ì„±ëŠ¥ ì¸¡ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<hr />

<h2 id="5-result">5. Result</h2>
<ol>
  <li>Semantic Segmentationì˜ Label Image ìƒì„± ì‹œ, ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ì €ì¥ ë°©ì‹ìœ¼ë¡œ ì €ì¥í•˜ë©´ ì•ˆë©ë‹ˆë‹¤.</li>
  <li>Color Mapê³¼ Palette ì •ë³´ê°€ í¬í•¨ëœ, Indexed Imageë¥¼ ì œì‘í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ê·¸ ì´ìœ ëŠ” Segmentation í•™ìŠµì´ CE Lossë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì—¬ê¸°ì„œ 1-Pixelì— ëŒ€í•´ 1ê°œì˜ ê°’(=label value)ì„ ë¹„êµí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ì‚¬ìš©ìê°€ Augmentation í˜¹ì€ Annotation ì‹œì—, íŠ¹ì • Color Mapì„ ìƒì„± í›„ì— Pixelì˜ Label Valueì— ìƒ‰ì¸í™” ì‹œì¼œì£¼ëŠ” ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤. 
(ìƒë‹¨ ì†ŒìŠ¤ì½”ë“œ ì°¸ì¡°)</li>
</ol>
:ET