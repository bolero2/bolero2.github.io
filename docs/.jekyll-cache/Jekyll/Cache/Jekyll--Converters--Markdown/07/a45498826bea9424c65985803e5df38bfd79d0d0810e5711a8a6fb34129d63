I"ù<p><span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    ObjectDetection
</span></p>

<h2 id="0-intro">0. Intro</h2>

<p>NMSë€? Non-maximum Suppressionì˜ ì•½ìë¡œì¨, <strong>ë¹„ìµœëŒ€ ì–µì œ ì•Œê³ ë¦¬ì¦˜</strong>ìœ¼ë¡œ ìƒê°í•˜ë©´ ëœë‹¤.
ë§ ê·¸ëŒ€ë¡œ, ìµœëŒ€ê°€ ì•„ë‹Œ ë°•ìŠ¤ë“¤(=Bounding Box)ì„ ì‚­ì œí•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ë‹¤.</p>

<p><strong>Object Detection</strong> Taskì—ì„œ ê°ì²´ì— ëŒ€í•œ ìµœì¢… Bounding Boxë¥¼ ê²°ì •ì§€ì„ ë•Œ ì‚¬ìš©í•œë‹¤.</p>

<hr />

<h2 id="1-principle">1. Principle</h2>

<p>ì‘ë™ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<blockquote>
  <ol>
    <li>Predictioní•  ì´ë¯¸ì§€ë¥¼ Networkì— Forward ì‹œí‚¨ë‹¤.</li>
    <li>ì¶œë ¥ ê°€ëŠ¥í•œ ëª¨ë“  ë°•ìŠ¤ë¥¼ êµ¬í•œë‹¤. (NMS ì´ì „ì´ë¯€ë¡œ, ìˆ˜ì‹­~ìˆ˜ë°±ê°œì˜ ë°•ìŠ¤ ì •ë³´ê°€ ë‚˜ì˜¨ë‹¤.)</li>
    <li>í•´ë‹¹ ë°•ìŠ¤ ì •ë³´ë“¤ì„ <strong>Confidence Score</strong> ìˆœìœ¼ë¡œ ì •ë ¬í•œë‹¤.</li>
    <li>ë°•ìŠ¤ ì •ë³´ë“¤ì˜ <strong>Confidence Score</strong>ì™€, ê° ë°•ìŠ¤ ê°„ì˜ <strong>IoU</strong>ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•˜ì—¬ NMSë¥¼ ì ìš©í•œë‹¤.</li>
    <li>NMS ì ìš© í›„ì—ëŠ”, ì•Œë§ëŠ” ë°•ìŠ¤ë¼ê³  ì—¬ê²¨ì§€ëŠ” ê°’ë“¤ë§Œ ì¶œë ¥ëœë‹¤.</li>
  </ol>
</blockquote>

<p>í•µì‹¬ í‚¤ì›Œë“œë¥¼ ë½‘ìë©´, <strong>Confidence Score</strong>ì™€ <strong>IoU</strong>ë¼ê³  ìƒê°í•œë‹¤. (ì´ ë‘ ë‹¨ì–´ë¡œ êµ¬í˜„ì´ ê°€ëŠ¥í•¨.)</p>

<h3 id="1-1-confidence-score">1-1. Confidence-Score?</h3>

<p>ì—¬ê¸°ì„œ <strong>Confidence Score(ì‹ ë¢°ë„, ì‹ ë¢° ì ìˆ˜)</strong>ë¼ê³  í•˜ëŠ” ê²ƒì€
<strong>ë„¤íŠ¸ì›Œí¬ê°€ ì •ë‹µì„ ë„ì¶œí•´ëƒˆì„ ë•Œ, ê·¸ ì •ë‹µì— ëŒ€í•´ n%ì˜ í™•ì‹ ë„ë¥¼ ê°–ëŠ”ë‹¤ëŠ” ì˜ë¯¸</strong>ì´ë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, A ë°•ìŠ¤ì— ëŒ€í•œ Confidence Scoreê°€ 0.75ë¼ë©´,
ë„¤íŠ¸ì›Œí¬ê°€ ìƒê°í–ˆì„ ë•Œ â€œì•„, ì´ ë°•ìŠ¤ë¥¼ ë‚´ê°€ ë„ì¶œí•˜ê¸´ í–ˆëŠ”ë°, ì´ ë°•ìŠ¤ê°€ ì •ë‹µì¼ í™•ë¥ ì€ <strong>75%</strong> ì •ë„ì•¼.â€ ë¼ëŠ” ì˜ë¯¸ì´ë‹¤.</p>

<h3 id="1-2-iou">1-2. IoU?</h3>

<p>IoUëŠ” <strong>Intersection Over Union</strong>ì˜ ì•½ìì´ë‹¤.
<img src="https://images.velog.io/images/bolero2/post/93cd3e8c-b77f-4de9-a3f4-d7683c4e6838/iou.png" alt="iou.png" /></p>

<p>(Object Detection ì„ ë‹¤ë¤„ë³¸ ê°œë°œìë¼ë©´ ë§ì´ ì ‘í•´ë´¤ì„ ë“¯í•œ ê·¸ë¦¼.)</p>

<p>ì‰½ê²Œ ë§í•´ì„œ, ë‘ ë°•ìŠ¤ì˜ <strong>êµì§‘í•©</strong> / ë‘ ë°•ìŠ¤ì˜ <strong>í•©ì§‘í•©</strong> ì´ë‹¤.
ì½”ë“œë¡œ ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>			<span class="c1"># area of box n.
</span>        <span class="k">return</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># intersection area
</span>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">area_a</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
        <span class="n">area_b</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inter_area</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_a</span> <span class="o">+</span> <span class="n">area_b</span> <span class="o">-</span> <span class="n">inter_area</span><span class="p">)</span>    

    <span class="c1"># if boxes do not intersect
</span>    <span class="k">if</span> <span class="n">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="n">inter_area</span><span class="p">)</span>
    
    <span class="c1"># intersection over union
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">if</span> <span class="n">iou</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">iou</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Measure is wrong! : IoU Value is [</span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s">]."</span>
    <span class="k">return</span> <span class="n">iou</span>
</code></pre></div></div>

<p>box1ê³¼ box2ê°€ ì…ë ¥ìœ¼ë¡œ ì™”ì„ ë•Œ, ë‘ ë°•ìŠ¤ì˜ IoUë¥¼ ê³„ì‚°í•´ì£¼ëŠ” ì½”ë“œì´ë‹¤.
boxì˜ ì¢Œí‘œ ì²´ê³„ëŠ” <strong>[center_x, center_y, width, height]</strong> ì´ê³ , <strong>ìƒëŒ€ ì¢Œí‘œ</strong> ì´ë‹¤.
(YOLOì˜ ë¼ë²¨ë§ ë°©ë²•ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.)</p>

<hr />

<h2 id="2-sample-code">2. Sample Code</h2>

<p>ì½”ë“œë¡œ ì‚´í´ë³´ì.
ì„ì˜ë¡œ ë°•ìŠ¤ ì •ë³´ë“¤ì„ ìƒì„±í•´ì£¼ê³ , Confidence Score ê°’ë„ ë„£ì–´ì£¼ì—ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colorset</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>		<span class="c1"># Red
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Green
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Blue
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Cyan
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>		<span class="c1"># Magenta
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>		<span class="c1"># Yellow
</span><span class="p">]</span>

<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span>

<span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># left sector boxes
</span>    <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>        <span class="c1"># Red
</span>    <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>    <span class="c1"># Green
</span>    <span class="p">[</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>    <span class="c1"># Blue
</span>
    <span class="c1"># right sector boxes
</span>    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>     <span class="c1"># cyan
</span>    <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>    <span class="c1"># magenta
</span>    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">],</span>   <span class="c1"># yellow
</span><span class="p">]</span>
</code></pre></div></div>
<p><strong>ë°•ìŠ¤ ì •ë³´ëŠ” [center_x, center_y, width, height, conf_score] ìˆœìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆê³ ,
ì ˆëŒ€ ì¢Œí‘œì´ë‹¤. (0~1 ì‚¬ì´ë¡œ ìŠ¤ì¼€ì¼ë§ ëœ ê°’)</strong></p>

<p>í•´ë‹¹ ë°•ìŠ¤ë“¤ì„ 600 * 600ì˜ ë¹ˆ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ë³´ë©´, ë‹¤ìŒê³¼ ê°™ì€ ë°•ìŠ¤ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p><img src="https://images.velog.io/images/bolero2/post/c166b00b-67ec-4c8c-a644-40a47109769e/before_nms.jpg" alt="before_nms.jpg" /></p>

<p><strong>(ë°•ìŠ¤ ê·¸ë ¤ì£¼ëŠ” ì½”ë“œ)</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>			<span class="c1"># empty canvas
</span><span class="n">canvas_copy</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>						<span class="c1"># for after nms
</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                          <span class="n">colorset</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>ì„ì˜ë¡œ ë§Œë“  ë°•ìŠ¤ë“¤ì´ê¸° ë•Œë¬¸ì—, ìš°ë¦¬ëŠ” ì–´ë–¤ ê²ƒì´ NMS í†µê³¼ í›„ì— ë‚¨ì•„ì•¼ í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤.
ë°”ë¡œ <strong>Red</strong>ì™€ <strong>Cyan</strong> ìƒ‰ìƒì˜ ë°•ìŠ¤ë§Œ ë‚¨ì•„ì•¼ í•œë‹¤.
<em>(ì´ìœ ëŠ”, ì¢Œ/ìš°ì¸¡ ì„¹í„° ê¸°ì¤€ìœ¼ë¡œ ì‹ ë¢° ì ìˆ˜ê°€ ê°€ì¥ ë†’ê¸° ë•Œë¬¸ì´ë‹¤.)</em></p>

<p>ê·¸ë¦¬ê³ , <strong>NMS(boxes, iou_thres=0.4)</strong> í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ì£¼ì—ˆë‹¤. (ì¤‘ê°„ì— ì¶œë ¥ì„ ë””ë²„ê¹…í•´ë³¼ ìˆ˜ ìˆëŠ” printë¬¸ì´ ìˆë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># sorting
</span>    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">)</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span>
</code></pre></div></div>

<p>ìˆœì„œëŠ” <strong>1. ì›ë¦¬</strong>ì—ì„œ ë³¸ ê²ƒê³¼ ë™ì¼í•˜ë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>
</code></pre></div></div>
<p>ì—¬ê¸° ë¶€ë¶„ì—ì„œ Confidence Score ìˆœìœ¼ë¡œ box ì •ë³´ë“¤ì„ ì •ë ¬í•˜ê³ ,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>
</code></pre></div></div>
<p>ë¶€ë¶„ì—ì„œ ì‹¤ì œë¡œ IoU ê°’ì„ êµ¬í•˜ë©´ì„œ, íƒˆë½ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.</p>

<p>IoU Thresholdë¥¼ 0.4ë¡œ ì„¤ì •í•˜ì˜€ê¸° ë•Œë¬¸ì—,
ë°•ìŠ¤ ê°„ì˜ IoU ê°’ì´ 0.4 ì´ìƒì¸ ê²½ìš°ì—ëŠ”, <strong>Confidence Scoreê°€ ë‚®ì€ ë°•ìŠ¤ê°€ íƒˆë½í•œë‹¤.</strong></p>

<p>íƒˆë½ ì—¬ë¶€ëŠ” <code class="language-plaintext highlighter-rouge">answer = [True for x in range(sorted_boxes.shape[0])]</code> ë¡œ ë¯¸ë¦¬ ë°•ìŠ¤ ê°œìˆ˜ë§Œí¼ Trueë¥¼ ì ì–´ë‘ê³ ,
íƒˆë½ëœ ë°•ìŠ¤ ìë¦¬ì— <code class="language-plaintext highlighter-rouge">False</code>ë¥¼ ê¸°ë¡í•œë‹¤.</p>

<hr />

<p>ë””ë²„ê¹… ì¶œë ¥ë¬¼ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ul>
  <li>** ì •ë ¬ ì´ì „ì˜ box ì •ë³´ë“¤**
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Before</span> <span class="n">Arrange</span>
<span class="p">[[</span><span class="mf">0.3</span>  <span class="mf">0.3</span>  <span class="mf">0.1</span>  <span class="mf">0.1</span>  <span class="mf">0.9</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.31</span> <span class="mf">0.28</span> <span class="mf">0.14</span> <span class="mf">0.13</span> <span class="mf">0.5</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.28</span> <span class="mf">0.28</span> <span class="mf">0.09</span> <span class="mf">0.11</span> <span class="mf">0.3</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.65</span> <span class="mf">0.2</span>  <span class="mf">0.2</span>  <span class="mf">0.99</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.7</span>  <span class="mf">0.63</span> <span class="mf">0.22</span> <span class="mf">0.18</span> <span class="mf">0.35</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.62</span> <span class="mf">0.22</span> <span class="mf">0.22</span> <span class="mf">0.77</span><span class="p">]]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>ì •ë ¬ ì´í›„ì˜ box ì •ë³´ë“¤</strong> (confidence score ìˆœì„œë¡œ ì˜ ì •ë ¬ë˜ì—ˆë‹¤.)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">After</span> <span class="n">Arrange</span>
<span class="p">[[</span><span class="mf">0.75</span> <span class="mf">0.65</span> <span class="mf">0.2</span>  <span class="mf">0.2</span>  <span class="mf">0.99</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.3</span>  <span class="mf">0.3</span>  <span class="mf">0.1</span>  <span class="mf">0.1</span>  <span class="mf">0.9</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.62</span> <span class="mf">0.22</span> <span class="mf">0.22</span> <span class="mf">0.77</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.31</span> <span class="mf">0.28</span> <span class="mf">0.14</span> <span class="mf">0.13</span> <span class="mf">0.5</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.7</span>  <span class="mf">0.63</span> <span class="mf">0.22</span> <span class="mf">0.18</span> <span class="mf">0.35</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.28</span> <span class="mf">0.28</span> <span class="mf">0.09</span> <span class="mf">0.11</span> <span class="mf">0.3</span> <span class="p">]]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Answerë¼ëŠ” ë³€ìˆ˜ë¥¼ ë‘ê³ , íƒˆë½ ì—¬ë¶€ë¥¼ ìœ„í•œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í–ˆë‹¤.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Before</span> <span class="n">NMS</span> <span class="n">Answer</span> <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>NMS ë™ì‘ ê³¼ì •, íƒˆë½í•˜ë©´ Answer[index]ì— Falseë¥¼ ê¸°ë¡í•œë‹¤.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span> <span class="n">vs</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">1.0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">2</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.754</span>
<span class="n">Index</span> <span class="mi">2</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">3</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.519</span>
<span class="n">Index</span> <span class="mi">4</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">1.0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">2</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">3</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.469</span>
<span class="n">Index</span> <span class="mi">3</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.463</span>
<span class="n">Index</span> <span class="mi">5</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
</code></pre></div>    </div>
    <p>: ì›ë˜ëŠ” ìê¸° ìì‹ ê³¼ëŠ” ë¹„êµí•˜ë©´ ì•ˆë˜ëŠ”ë°, ê·¸ëƒ¥ ë¹„êµí•˜ê²Œ ì§°ë‹¤. (ì‹¬í”Œí•˜ê²Œ)
ê·¸ ë¶€ë¶„ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì½”ë“œì— <code class="language-plaintext highlighter-rouge">int(iou_val) != 1</code>ì¸ ì¡°ê±´ì„ ì¶”ê°€í•˜ì˜€ë‹¤.
<strong>(iou_valì´ 1ì´ë¼ëŠ” ëœ»ì€, ìê¸° ìì‹ ê³¼ ë¹„êµí•œ ê²½ìš°ì´ë‹¤.)</strong></p>
  </li>
</ul>

<p>ì´ì œ ë³´ë©´, 2ê°œì˜ ê²½ìš°ê°€ ìˆë‹¤.</p>
<ul>
  <li><strong>IoUê°€ 0.4ë³´ë‹¤ ì‘ì„ ê²½ìš°</strong></li>
  <li><strong>IoUê°€ 0.4ë³´ë‹¤ í´ ê²½ìš°</strong></li>
</ul>

<p>1) ì‘ì„ ê²½ìš°ëŠ”, <strong>ì‚´ì•„ë‚¨ëŠ” ë°•ìŠ¤</strong>ì´ë‹¤.
2) í´ ê²½ìš°ëŠ”, <strong>íƒˆë½í•˜ëŠ” ë°•ìŠ¤</strong>ì´ë‹¤.
(0.9 confì˜ ë°•ìŠ¤ì™€ 0.4 confì˜ ë°•ìŠ¤ë¥¼ ë¹„êµí•˜ì—¬ iou_val == 0.5ë¼ê³  í•œë‹¤ë©´, 0.4 confì˜ ë°•ìŠ¤ê°€ íƒˆë½í•œë‹¤.)</p>

<ul>
  <li><strong>NMS ì´í›„ì— ì‚´ì•„ë‚¨ëŠ” ë°•ìŠ¤ì˜ index, Answer ë³€ìˆ˜ì— boolean ê°’ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆë‹¤.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">After</span> <span class="n">NMS</span> <span class="n">Answer</span> <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>return ë˜ëŠ” ê°’ì€, Answer ë³€ìˆ˜ì™€ sorted_boxes, sorted_indexë¥¼ ë°˜í™˜í•´ì£¼ì—ˆë‹¤.
main ë¬¸ì—ì„œ ë°•ìŠ¤ë¥¼ ì˜ ë³¼ ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•¨ì´ë‹¤.</p>

<hr />

<h2 id="3-result">3. Result</h2>

<p>main ë¬¸ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ NMS í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>ì—¬ê¸°ì„œ boxesëŠ” before Arrange ë°•ìŠ¤ë“¤ì´ë‹¤.</strong></p>

<p>ê·¸ë¦¬ê³ , answerê³¼ sorted_boxes, sorted_index ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ,
ìƒˆë¡œìš´ ë¹„ì–´ìˆëŠ” canvasì— ê·¸ë ¤ì¤€ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span><span class="p">)):</span>
    <span class="n">sbox</span><span class="p">,</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">datum</span>
    <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas_copy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="n">colorset</span><span class="p">[</span><span class="n">sidx</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>(Answer ë³€ìˆ˜ê°€ <em>True</em> ì¸ boxë§Œ ê·¸ë ¤ì¤€ë‹¤.)</strong></p>

<p>ê·¸ëŸ¬ë©´, ë‹¤ìŒê³¼ ê°™ì´ Redì™€ Cyan ìƒ‰ìƒì˜ ë°•ìŠ¤ë§Œ ë‚¨ì€ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
<img src="https://images.velog.io/images/bolero2/post/509a537d-77a4-41c6-8c59-b5bb0fa6e2a0/after_nms.jpg" alt="after_nms.py" /></p>

<hr />

<h2 id="4-full-code">4. Full Code</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>			<span class="c1"># area of box n.
</span>        <span class="k">return</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># intersection area
</span>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">area_a</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
        <span class="n">area_b</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inter_area</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_a</span> <span class="o">+</span> <span class="n">area_b</span> <span class="o">-</span> <span class="n">inter_area</span><span class="p">)</span>    

    <span class="c1"># if boxes do not intersect
</span>    <span class="k">if</span> <span class="n">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="n">inter_area</span><span class="p">)</span>
    
    <span class="c1"># intersection over union
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">if</span> <span class="n">iou</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">iou</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Measure is wrong! : IoU Value is [</span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s">]."</span>
    <span class="k">return</span> <span class="n">iou</span>


<span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># sorting
</span>    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">)</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">colorset</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span>

    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># left boxes
</span>        <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>                  <span class="c1"># Red
</span>        <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>              <span class="c1"># Green
</span>        <span class="p">[</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>              <span class="c1"># Blue
</span>
        <span class="c1"># right boxes
</span>        <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>               <span class="c1"># cyan
</span>        <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>              <span class="c1"># magenta
</span>        <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">],</span>             <span class="c1"># yellow
</span>    <span class="p">]</span>

    <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>
    <span class="n">canvas_copy</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                              <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                              <span class="n">colorset</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span><span class="p">)):</span>
        <span class="n">sbox</span><span class="p">,</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">datum</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas_copy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                       <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                       <span class="n">colorset</span><span class="p">[</span><span class="n">sidx</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># print(canvas)
</span>    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Before NMS"</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"After NMS"</span><span class="p">,</span> <span class="n">canvas_copy</span><span class="p">)</span>

    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"before_nms.jpg"</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"after_nms.jpg"</span><span class="p">,</span> <span class="n">canvas_copy</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>
:ET