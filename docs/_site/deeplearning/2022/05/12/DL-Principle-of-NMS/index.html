<!DOCTYPE html>




<html
 dir="ltr"
 lang="en"
 class="has-navbar-fixed-lrt">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content=#ffffff>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" type="image/png"
           href="/favicon.png" 
    />
    <script defer src="https://unpkg.com/alpinejs@3.9.0/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-social@1/bin/bulma-social.min.css">
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[DL] NMS, Non-Maximum Suppression 파헤치기 | bolero2.log</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="[DL] NMS, Non-Maximum Suppression 파헤치기" />
<meta name="author" content="bolero2" />
<meta property="og:locale" content="en" />
<meta name="description" content="Object Detection에서 사용하는 NMS(Non-Maximum Suppression, 비 최대 억제 알고리즘)에 대해 알아보고, 간단한 코드를 작성하여 실습해봅니다." />
<meta property="og:description" content="Object Detection에서 사용하는 NMS(Non-Maximum Suppression, 비 최대 억제 알고리즘)에 대해 알아보고, 간단한 코드를 작성하여 실습해봅니다." />
<link rel="canonical" href="http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/" />
<meta property="og:url" content="http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/" />
<meta property="og:site_name" content="bolero2.log" />
<meta property="og:image" content="http://localhost:4000/img/thumbnail-nms.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-12T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/img/thumbnail-nms.jpg" />
<meta property="twitter:title" content="[DL] NMS, Non-Maximum Suppression 파헤치기" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"bolero2"},"dateModified":"2022-05-12T00:00:00+09:00","datePublished":"2022-05-12T00:00:00+09:00","description":"Object Detection에서 사용하는 NMS(Non-Maximum Suppression, 비 최대 억제 알고리즘)에 대해 알아보고, 간단한 코드를 작성하여 실습해봅니다.","headline":"[DL] NMS, Non-Maximum Suppression 파헤치기","image":"http://localhost:4000/img/thumbnail-nms.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/"},"url":"http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/"}</script>
<!-- End Jekyll SEO tag -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=3563142385"></script>
<script>
  window['ga-disable-3563142385'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '3563142385');
</script><!-- head scripts --></head>

  <body>
    <nav class="navbar is-primary  is-fixed-lrt " x-data="{ openNav: false }">
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="navbar-item">
                bolero2.log
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu" :class="{ 'is-active': openNav }" x-on:click="openNav = !openNav">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu" :class="{ 'is-active': openNav }">
            <div class="navbar-start">
                <a href="/" class="navbar-item ">Home</a>
                
                
                    
                    <a href="/blog/" class="navbar-item ">Blog</a>
                    
                
                    
                    <div class="navbar-item has-dropdown is-hoverable ">
                        <a href="/" class="navbar-link ">My works</a>
                        <div class="navbar-dropdown">
                            
                            <a href="https://github.com/bolero2/vggnet-torch" class="navbar-item ">vggnet-pytorch</a>
                            
                            <a href="https://github.com/bolero2/deeplab-v3-torch" class="navbar-item ">deeplab-v3-pytorch</a>
                            
                        </div>
                    </div>
                    
                
                    
                    <div class="navbar-item has-dropdown is-hoverable ">
                        <a href="/" class="navbar-link ">Published papers</a>
                        <div class="navbar-dropdown">
                            
                            <a href="https://www.kci.go.kr/kciportal/ci/sereArticleSearch/ciSereArtiView.kci?sereArticleSearchBean.artiId=ART002429571" class="navbar-item ">이중흐름 3차원 합성곱 신경망 구조를 이용한 효율적인 손 제스처 인식 방법</a>
                            
                            <a href="https://github.com/bolero2/bolero2/blob/main/papers/%5BKSC2018%5D%20실시간%20손%20제스처%20인식을%20위한%20덴스넷%20기반%20이중흐름%203차원%20합성곱%20신경망%20구조.pdf" class="navbar-item ">실시간 손 제스처 인식을 위한 덴스넷 기반 이중흐름 3차원 합성곱 신경망 구조</a>
                            
                            <a href="https://www.kci.go.kr/kciportal/ci/sereArticleSearch/ciSereArtiView.kci?sereArticleSearchBean.artiId=ART002529690" class="navbar-item ">Atrous Convolution과 Grad-CAM을 통한 손 끝 탐지</a>
                            
                            <a href="https://www.earticle.net/Article/A379292" class="navbar-item ">실시간 손끝 탐지를 위한 VGGNet 기반 객체 탐지 네트워크</a>
                            
                        </div>
                    </div>
                    
                
                    
                    <a href="https://github.com/bolero2" class="navbar-item ">Github Profile</a>
                    
                
                
            </div>

            <div class="navbar-end">
                
                <a class="navbar-item" href="https://github.com/sponsors/bolero2">
                    <span class="icon gh-sponsor"><i class="fas fa-heart"></i></span>
                    <span>Sponsor</span>
                </a>
                
            </div>

        </div>
    </div>
</nav>

    
        <section class="hero  is-medium  is-bold is-primary" >
    <div class="hero-body ">
        <div class="container">
            <h1 class="title is-2">[DL] NMS, Non-Maximum Suppression 파헤치기</h1>
            <p class="subtitle is-3"></p>
            
        </div>
    </div>
</section>
    
    


    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                
                <div class="column is-4-desktop is-4-tablet">
                    
                    

<div class="contents">
    <div class="menu">
        <p class="menu-label">Contents</p>
        <ul class="menu-list">
  <li><a href="#0-intro">0. Intro</a></li>
  <li><a href="#1-principle">1. Principle</a>
    <ul>
      <li><a href="#1-1-confidence-score">1-1. Confidence-Score?</a></li>
      <li><a href="#1-2-iou">1-2. IoU?</a></li>
    </ul>
  </li>
  <li><a href="#2-sample-code">2. Sample Code</a></li>
  <li><a href="#3-result">3. Result</a></li>
  <li><a href="#4-full-code">4. Full Code</a></li>
</ul>
    </div>
</div>



                </div>
                
                <div class="column is-8">
                    
                    
                    
                    
                    <div class="content">

    <p><b>Published:</b> May 12, 2022 : by <b>bolero2</b></p>

    
        


<p class="title is-5 is-spaced">Deep Learning</p>






    <p class="title is-6"></p>


<ul class="block-list is-small is-outlined">
    
        

        
            <li class="is-highlighted is-dark">
                <p>[DL] NMS, Non-Maximum Suppression 파헤치기</p>
            </li>
        

    
        

        
            <li>
                <a href="/deeplearning/2022/01/15/DL-Semantic-Segmentation-Create-Label-Image/" class="is-flex" >[DL] Semantic Segmentation에서 Label Image 생성하기</a>
            </li>
        

    
</ul>


    

    <p><span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    ObjectDetection
</span></p>

<h2 id="0-intro">0. Intro</h2>

<p>NMS란? Non-maximum Suppression의 약자로써, <strong>비최대 억제 알고리즘</strong>으로 생각하면 된다.
말 그대로, 최대가 아닌 박스들(=Bounding Box)을 삭제하는 알고리즘이다.</p>

<p><strong>Object Detection</strong> Task에서 객체에 대한 최종 Bounding Box를 결정지을 때 사용한다.</p>

<hr />

<h2 id="1-principle">1. Principle</h2>

<p>작동 방식은 다음과 같다.</p>

<blockquote>
  <ol>
    <li>Prediction할 이미지를 Network에 Forward 시킨다.</li>
    <li>출력 가능한 모든 박스를 구한다. (NMS 이전이므로, 수십~수백개의 박스 정보가 나온다.)</li>
    <li>해당 박스 정보들을 <strong>Confidence Score</strong> 순으로 정렬한다.</li>
    <li>박스 정보들의 <strong>Confidence Score</strong>와, 각 박스 간의 <strong>IoU</strong>를 바탕으로 하여 NMS를 적용한다.</li>
    <li>NMS 적용 후에는, 알맞는 박스라고 여겨지는 값들만 출력된다.</li>
  </ol>
</blockquote>

<p>핵심 키워드를 뽑자면, <strong>Confidence Score</strong>와 <strong>IoU</strong>라고 생각한다. (이 두 단어로 구현이 가능함.)</p>

<h3 id="1-1-confidence-score">1-1. Confidence-Score?</h3>

<p>여기서 <strong>Confidence Score(신뢰도, 신뢰 점수)</strong>라고 하는 것은
<strong>네트워크가 정답을 도출해냈을 때, 그 정답에 대해 n%의 확신도를 갖는다는 의미</strong>이다.</p>

<p>예를 들어, A 박스에 대한 Confidence Score가 0.75라면,
네트워크가 생각했을 때 “아, 이 박스를 내가 도출하긴 했는데, 이 박스가 정답일 확률은 <strong>75%</strong> 정도야.” 라는 의미이다.</p>

<h3 id="1-2-iou">1-2. IoU?</h3>

<p>IoU는 <strong>Intersection Over Union</strong>의 약자이다.
<img src="https://images.velog.io/images/bolero2/post/93cd3e8c-b77f-4de9-a3f4-d7683c4e6838/iou.png" alt="iou.png" /></p>

<p>(Object Detection 을 다뤄본 개발자라면 많이 접해봤을 듯한 그림.)</p>

<p>쉽게 말해서, 두 박스의 <strong>교집합</strong> / 두 박스의 <strong>합집합</strong> 이다.
코드로 보자면 다음과 같다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>			<span class="c1"># area of box n.
</span>        <span class="k">return</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># intersection area
</span>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">area_a</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
        <span class="n">area_b</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inter_area</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_a</span> <span class="o">+</span> <span class="n">area_b</span> <span class="o">-</span> <span class="n">inter_area</span><span class="p">)</span>    

    <span class="c1"># if boxes do not intersect
</span>    <span class="k">if</span> <span class="n">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="n">inter_area</span><span class="p">)</span>
    
    <span class="c1"># intersection over union
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">if</span> <span class="n">iou</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">iou</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Measure is wrong! : IoU Value is [</span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s">]."</span>
    <span class="k">return</span> <span class="n">iou</span>
</code></pre></div></div>

<p>box1과 box2가 입력으로 왔을 때, 두 박스의 IoU를 계산해주는 코드이다.
box의 좌표 체계는 <strong>[center_x, center_y, width, height]</strong> 이고, <strong>상대 좌표</strong> 이다.
(YOLO의 라벨링 방법이라고 생각하면 된다.)</p>

<hr />

<h2 id="2-sample-code">2. Sample Code</h2>

<p>코드로 살펴보자.
임의로 박스 정보들을 생성해주고, Confidence Score 값도 넣어주었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colorset</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>		<span class="c1"># Red
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Green
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Blue
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Cyan
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>		<span class="c1"># Magenta
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>		<span class="c1"># Yellow
</span><span class="p">]</span>

<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span>

<span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># left sector boxes
</span>    <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>        <span class="c1"># Red
</span>    <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>    <span class="c1"># Green
</span>    <span class="p">[</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>    <span class="c1"># Blue
</span>
    <span class="c1"># right sector boxes
</span>    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>     <span class="c1"># cyan
</span>    <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>    <span class="c1"># magenta
</span>    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">],</span>   <span class="c1"># yellow
</span><span class="p">]</span>
</code></pre></div></div>
<p><strong>박스 정보는 [center_x, center_y, width, height, conf_score] 순으로 구성되어 있고,
절대 좌표이다. (0~1 사이로 스케일링 된 값)</strong></p>

<p>해당 박스들을 600 * 600의 빈 캔버스에 그려보면, 다음과 같은 박스를 볼 수 있다.</p>

<p><img src="https://images.velog.io/images/bolero2/post/c166b00b-67ec-4c8c-a644-40a47109769e/before_nms.jpg" alt="before_nms.jpg" /></p>

<p><strong>(박스 그려주는 코드)</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>			<span class="c1"># empty canvas
</span><span class="n">canvas_copy</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>						<span class="c1"># for after nms
</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                          <span class="n">colorset</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>임의로 만든 박스들이기 때문에, 우리는 어떤 것이 NMS 통과 후에 남아야 하는지 알 수 있다.
바로 <strong>Red</strong>와 <strong>Cyan</strong> 색상의 박스만 남아야 한다.
<em>(이유는, 좌/우측 섹터 기준으로 신뢰 점수가 가장 높기 때문이다.)</em></p>

<p>그리고, <strong>NMS(boxes, iou_thres=0.4)</strong> 함수를 작성해주었다. (중간에 출력을 디버깅해볼 수 있는 print문이 있다.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># sorting
</span>    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">)</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span>
</code></pre></div></div>

<p>순서는 <strong>1. 원리</strong>에서 본 것과 동일하다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>
</code></pre></div></div>
<p>여기 부분에서 Confidence Score 순으로 box 정보들을 정렬하고,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>
</code></pre></div></div>
<p>부분에서 실제로 IoU 값을 구하면서, 탈락 여부를 결정한다.</p>

<p>IoU Threshold를 0.4로 설정하였기 때문에,
박스 간의 IoU 값이 0.4 이상인 경우에는, <strong>Confidence Score가 낮은 박스가 탈락한다.</strong></p>

<p>탈락 여부는 <code class="language-plaintext highlighter-rouge">answer = [True for x in range(sorted_boxes.shape[0])]</code> 로 미리 박스 개수만큼 True를 적어두고,
탈락된 박스 자리에 <code class="language-plaintext highlighter-rouge">False</code>를 기록한다.</p>

<hr />

<p>디버깅 출력물은 다음과 같다.</p>

<ul>
  <li>** 정렬 이전의 box 정보들**
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Before</span> <span class="n">Arrange</span>
<span class="p">[[</span><span class="mf">0.3</span>  <span class="mf">0.3</span>  <span class="mf">0.1</span>  <span class="mf">0.1</span>  <span class="mf">0.9</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.31</span> <span class="mf">0.28</span> <span class="mf">0.14</span> <span class="mf">0.13</span> <span class="mf">0.5</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.28</span> <span class="mf">0.28</span> <span class="mf">0.09</span> <span class="mf">0.11</span> <span class="mf">0.3</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.65</span> <span class="mf">0.2</span>  <span class="mf">0.2</span>  <span class="mf">0.99</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.7</span>  <span class="mf">0.63</span> <span class="mf">0.22</span> <span class="mf">0.18</span> <span class="mf">0.35</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.62</span> <span class="mf">0.22</span> <span class="mf">0.22</span> <span class="mf">0.77</span><span class="p">]]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>정렬 이후의 box 정보들</strong> (confidence score 순서로 잘 정렬되었다.)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">After</span> <span class="n">Arrange</span>
<span class="p">[[</span><span class="mf">0.75</span> <span class="mf">0.65</span> <span class="mf">0.2</span>  <span class="mf">0.2</span>  <span class="mf">0.99</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.3</span>  <span class="mf">0.3</span>  <span class="mf">0.1</span>  <span class="mf">0.1</span>  <span class="mf">0.9</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.62</span> <span class="mf">0.22</span> <span class="mf">0.22</span> <span class="mf">0.77</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.31</span> <span class="mf">0.28</span> <span class="mf">0.14</span> <span class="mf">0.13</span> <span class="mf">0.5</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.7</span>  <span class="mf">0.63</span> <span class="mf">0.22</span> <span class="mf">0.18</span> <span class="mf">0.35</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.28</span> <span class="mf">0.28</span> <span class="mf">0.09</span> <span class="mf">0.11</span> <span class="mf">0.3</span> <span class="p">]]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Answer라는 변수를 두고, 탈락 여부를 위한 리스트를 생성했다.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Before</span> <span class="n">NMS</span> <span class="n">Answer</span> <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>NMS 동작 과정, 탈락하면 Answer[index]에 False를 기록한다.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span> <span class="n">vs</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">1.0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">2</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.754</span>
<span class="n">Index</span> <span class="mi">2</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">3</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.519</span>
<span class="n">Index</span> <span class="mi">4</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">1.0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">2</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">3</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.469</span>
<span class="n">Index</span> <span class="mi">3</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.463</span>
<span class="n">Index</span> <span class="mi">5</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
</code></pre></div>    </div>
    <p>: 원래는 자기 자신과는 비교하면 안되는데, 그냥 비교하게 짰다. (심플하게)
그 부분 처리를 위해 코드에 <code class="language-plaintext highlighter-rouge">int(iou_val) != 1</code>인 조건을 추가하였다.
<strong>(iou_val이 1이라는 뜻은, 자기 자신과 비교한 경우이다.)</strong></p>
  </li>
</ul>

<p>이제 보면, 2개의 경우가 있다.</p>
<ul>
  <li><strong>IoU가 0.4보다 작을 경우</strong></li>
  <li><strong>IoU가 0.4보다 클 경우</strong></li>
</ul>

<p>1) 작을 경우는, <strong>살아남는 박스</strong>이다.
2) 클 경우는, <strong>탈락하는 박스</strong>이다.
(0.9 conf의 박스와 0.4 conf의 박스를 비교하여 iou_val == 0.5라고 한다면, 0.4 conf의 박스가 탈락한다.)</p>

<ul>
  <li><strong>NMS 이후에 살아남는 박스의 index, Answer 변수에 boolean 값으로 알 수 있다.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">After</span> <span class="n">NMS</span> <span class="n">Answer</span> <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>return 되는 값은, Answer 변수와 sorted_boxes, sorted_index를 반환해주었다.
main 문에서 박스를 잘 볼 수 있게 하기 위함이다.</p>

<hr />

<h2 id="3-result">3. Result</h2>

<p>main 문에서 다음과 같이 NMS 함수를 호출한다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>여기서 boxes는 before Arrange 박스들이다.</strong></p>

<p>그리고, answer과 sorted_boxes, sorted_index 정보를 바탕으로,
새로운 비어있는 canvas에 그려준다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span><span class="p">)):</span>
    <span class="n">sbox</span><span class="p">,</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">datum</span>
    <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas_copy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="n">colorset</span><span class="p">[</span><span class="n">sidx</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>(Answer 변수가 <em>True</em> 인 box만 그려준다.)</strong></p>

<p>그러면, 다음과 같이 Red와 Cyan 색상의 박스만 남은 것을 알 수 있다.
<img src="https://images.velog.io/images/bolero2/post/509a537d-77a4-41c6-8c59-b5bb0fa6e2a0/after_nms.jpg" alt="after_nms.py" /></p>

<hr />

<h2 id="4-full-code">4. Full Code</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>			<span class="c1"># area of box n.
</span>        <span class="k">return</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># intersection area
</span>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">area_a</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
        <span class="n">area_b</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inter_area</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_a</span> <span class="o">+</span> <span class="n">area_b</span> <span class="o">-</span> <span class="n">inter_area</span><span class="p">)</span>    

    <span class="c1"># if boxes do not intersect
</span>    <span class="k">if</span> <span class="n">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="n">inter_area</span><span class="p">)</span>
    
    <span class="c1"># intersection over union
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">if</span> <span class="n">iou</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">iou</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Measure is wrong! : IoU Value is [</span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s">]."</span>
    <span class="k">return</span> <span class="n">iou</span>


<span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># sorting
</span>    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">)</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">colorset</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span>

    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># left boxes
</span>        <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>                  <span class="c1"># Red
</span>        <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>              <span class="c1"># Green
</span>        <span class="p">[</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>              <span class="c1"># Blue
</span>
        <span class="c1"># right boxes
</span>        <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>               <span class="c1"># cyan
</span>        <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>              <span class="c1"># magenta
</span>        <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">],</span>             <span class="c1"># yellow
</span>    <span class="p">]</span>

    <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>
    <span class="n">canvas_copy</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                              <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                              <span class="n">colorset</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span><span class="p">)):</span>
        <span class="n">sbox</span><span class="p">,</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">datum</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas_copy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                       <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                       <span class="n">colorset</span><span class="p">[</span><span class="n">sidx</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># print(canvas)
</span>    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Before NMS"</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"After NMS"</span><span class="p">,</span> <span class="n">canvas_copy</span><span class="p">)</span>

    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"before_nms.jpg"</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"after_nms.jpg"</span><span class="p">,</span> <span class="n">canvas_copy</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

</div>

<div class="tags">
    
</div>


<p><strong>Share</strong></p>
<div class="buttons ">
    <a class="button is-medium is-facebook"
       onclick="window.open('https://www.facebook.com/share.php?u=http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/');">
        <span class="icon"><i class="fab fa-facebook fa-lg"></i></span>
    </a>
    <a class="button is-medium is-twitter"
       onclick="window.open('https://twitter.com/intent/tweet?text=http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/');">
        <span class="icon"><i class="fab fa-twitter fa-lg"></i></span>
    </a>
    <a class="button is-medium is-linkedin"
       onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/&title=%5BDL%5D+NMS%2C+Non-Maximum+Suppression+%ED%8C%8C%ED%97%A4%EC%B9%98%EA%B8%B0&summary=&source=');">
        <span class="icon"><i class="fab fa-linkedin fa-lg"></i></span>
    </a>
    <a class="button is-medium is-reddit"
       onclick="window.open('https://reddit.com/submit?url=http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/');">
        <span class="icon"><i class="fab fa-reddit fa-lg"></i></span>
    </a>
</div>



  


                </div>
                
            </div>
        </div>
    </section>
    
        <footer class="footer">
    <div class="container">
        
        
        <div class="columns is-multiline">
            
            <div class="column has-text-centered">
                <div>
                    <a href="/" class="link">Home</a>
                </div>
            </div>
            
            <div class="column has-text-centered">
                <div>
                    <a href="/blog/" class="link">Blog</a>
                </div>
            </div>
            
            <div class="column has-text-centered">
                <div>
                    <a href="https://github.com/bolero2" class="link">Github Profile</a>
                </div>
            </div>
            
        </div>
        

        <div class="content is-small has-text-centered">
            <p class="">Contact ME : <a href="sheocjf1025@gmail.com">sheocjf1025@gmail.com</a></p>
        </div>
    </div>
</footer>

    
    <script src="/assets/js/app.js" type="text/javascript"></script><!-- footer scripts --></body>
</html>
