<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" hreflang="en" /><updated>2022-06-08T13:32:13+09:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">bolero2.log</title><subtitle>&quot;&quot;
</subtitle><entry><title type="html">Apple Silicon(M1) ì— Anaconda &amp;amp; PyTorch ì„¤ì¹˜í•˜ê¸° + ì„±ëŠ¥ ì¸¡ì •</title><link href="http://localhost:4000/deeplearning/2022/06/01/install-anaconda-pytorch-on-m1/" rel="alternate" type="text/html" title="Apple Silicon(M1) ì— Anaconda &amp;amp; PyTorch ì„¤ì¹˜í•˜ê¸° + ì„±ëŠ¥ ì¸¡ì •" /><published>2022-06-01T00:00:00+09:00</published><updated>2022-06-01T00:00:00+09:00</updated><id>http://localhost:4000/deeplearning/2022/06/01/install-anaconda-pytorch-on-m1</id><content type="html" xml:base="http://localhost:4000/deeplearning/2022/06/01/install-anaconda-pytorch-on-m1/"><![CDATA[<p><span class="tag  is-primary ">
    DeepLearning
</span></p>

<h1 id="apple-siliconì—-pytorch-ì„¤ì¹˜í•˜ê¸°">Apple Siliconì— PyTorch ì„¤ì¹˜í•˜ê¸°</h1>

<p>ì•„ë§ˆ 2020ë…„ì´ì—ˆë‚˜â€¦ ì• í”Œ ì‹¤ë¦¬ì½˜ ì•„í‚¤í…ì³ì˜ Macbookì´ ì¶œì‹œë˜ì—ˆë‹¤.</p>

<p>ë‚˜ëŠ” í˜„ì¬ M1 macbook proë¥¼ ì“°ê³ ìˆëŠ”ë°, ì´ì „ì—ëŠ” anacondaë„ ì•ˆë˜ì„œ mini-forgeë¼ëŠ” ê±¸ ì‚¬ìš©í–ˆì—ˆë‹¤.</p>

<p>ê·¸ë¦¬ê³  ê·¸ mini-forgeì—ëŠ” ë§ë„ ì•ˆë˜ëŠ” ë°˜ìª½ì§œë¦¬ pytorchë¥¼ ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í–ˆì—ˆë‹¤.</p>

<p>ì´ pytorchê°€ êµ¬ë™ì´ ì•ˆë˜ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. ì–´ì°Œì–´ì°Œí•´ì„œ ì„¤ì¹˜í•´ì„œ í•˜ë©´ ë­”ê°€ ë˜ê¸´í–ˆì—ˆëŠ”ë° GPU ê°€ì†ë„ ì•ˆë˜ê³  ì—¬ëŸ¬ ì œì•½ì‚¬í•­ì´ ìˆì—ˆë‹¤.
(ë¬¼ë¡  ê°œë°œì€ ì„œë²„ê°€ ìˆê¸° ë•Œë¬¸ì— ë”±íˆ ìƒê´€ì€ ì—†ì—ˆëŠ”ë°â€¦ ê°€ë²¼ìš´ ê²ƒì´ë¼ë„ ì˜ ëŒë¦¬ê³  ì‹¶ê¸´ í•˜ë‹ˆê¹Œ?!)</p>

<p>í•˜ì§€ë§Œ! ë“œë””ì–´</p>

<blockquote>
  <p>ğŸ’¡ <strong>Apple Silicon(M1) ì„ ìœ„í•œ Anaconda ì™€ PyTorchê°€ ì •ì‹ ì¶œì‹œë˜ì—ˆë‹¤!</strong></p>
</blockquote>

<ul>
  <li>Pytorch ê´€ë ¨ ê¸°ì‚¬ : <a href="https://pytorch.org/blog/introducing-accelerated-pytorch-training-on-mac/?fbclid=IwAR25rWBO7pCnLzuOLNb2rRjQLP_oOgLZmkJUg2wvBdYqzL72S5nppjg9Rvc">Introducing Accelerated PyTorch Training on Mac</a></li>
</ul>

<p>ì•„ì§ Preview ë²„ì „ì´ë¼ëŠ”ê±°ë‹ˆê¹Œ ì •ì‹(?)ì€ ì•„ë‹Œê±¸ë¡œâ€¦</p>

<h2 id="1-anaconda-ì„¤ì¹˜">1. Anaconda ì„¤ì¹˜</h2>

<p>Anaconda ì„¤ì¹˜ëŠ” ë§¤ìš° ì‰½ë‹¤. Anaconda ê³µì‹ í™ˆí˜ì´ì§€ì—ì„œ pkg íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ í•˜ì—¬ ê·¸ëƒ¥ ë”ë¸”í´ë¦­í•˜ê³  ì„¤ì¹˜í•˜ë©´ ëœë‹¤.</p>

<ol>
  <li>
    <table>
      <tbody>
        <tr>
          <td><strong>Anaconda download page ë¥¼ ë“¤ì–´ê°„ë‹¤.</strong> : [Anaconda</td>
          <td>Anaconda Distribution](https://www.anaconda.com/products/distribution)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><strong>ì‚¬ê³¼ ì•„ì´ì½˜ì„ í´ë¦­í•œë‹¤. (ë§¨ ì•„ë˜ë¡œ ì´ë™ë¨.)</strong>
<img src="https://velog.velcdn.com/images/bolero2/post/ee7a8a87-acfe-4614-8d50-5f070c35627f/image.png" alt="" /></p>
  </li>
  <li>
    <p><strong>ë§¨ ì•„ë˜ì—ì„œ 64-Bit(M1) Graphical Installer (428MB) ë¥¼ í´ë¦­í•œë‹¤.</strong>
<img src="https://velog.velcdn.com/images/bolero2/post/0ef75259-038b-4a76-ae3e-51b78c344a8f/image.png" alt="" /></p>
  </li>
  <li><strong>ê·¸ëŸ¬ë©´ ì•„ë˜ì²˜ëŸ¼ pkg íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ ëœë‹¤. (arm64=apple silicon ì•„í‚¤í…ì³ì„.)</strong>
<img src="https://velog.velcdn.com/images/bolero2/post/4dcbb047-29ca-4bc6-b7df-39c90a463d99/image.png" alt="" /></li>
</ol>

<p>pkg íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ë©´, ì•„ë˜ì²˜ëŸ¼ ë­”ê°€ ê²½ê³ ë„ ëœ¨ê³  ê³„ì•½ì„œ ë™ì˜ë„ í•˜ê³ , ë””ìŠ¤í¬ ì§€ì •ë„ í•´ì¤˜ì•¼ í•œë‹¤.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">install-1</th>
      <th style="text-align: center">install-2</th>
      <th style="text-align: center">install-3</th>
      <th style="text-align: center">install-4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://velog.velcdn.com/images/bolero2/post/c5a7da7a-26f5-428e-b020-42fdcf8481a3/image.png" alt="" /></td>
      <td style="text-align: center"><img src="https://velog.velcdn.com/images/bolero2/post/6530967f-749b-4628-93a7-964aae4eed79/image.png" alt="" /></td>
      <td style="text-align: center"><img src="https://velog.velcdn.com/images/bolero2/post/5b9e3851-29f4-45b7-8b9a-5ea2d2c76109/image.png" alt="" /></td>
      <td style="text-align: center"><img src="https://velog.velcdn.com/images/bolero2/post/3a568b29-7b45-4645-9e60-f37c5ba19c93/image.png" alt="" /></td>
    </tr>
  </tbody>
</table>

<p>ê·¸ë¦¬ê³ ëŠ” ì„¤ì¹˜í•˜ë©´ ëœë‹¤â€¦</p>

<ul>
  <li>ì„¸íŒ…ë„ ìë™ìœ¼ë¡œ í•´ì¤˜ì„œ ë§¤~ìš° í¸í•˜ë‹¤.
<img src="https://velog.velcdn.com/images/bolero2/post/f6fd127e-f3a8-48b4-9ce3-400b74ad9b25/image.png" alt="" /></li>
</ul>

<blockquote>
  <p>Anaconda ê°€ ì˜ ëœ¨ëŠ”ì§€ í™•ì¸í•˜ì.
matplotlib íŒ¨í‚¤ì§€ê°€ ì˜ import ë˜ëŠ” ê±¸ ë³´ë‹ˆ Anacondaê°€ í‹€ë¦¼ì—†ë‹¤â€¦</p>
</blockquote>

<ul>
  <li>conda init ì„¸íŒ…ì€ <code class="language-plaintext highlighter-rouge">vi ~/.zshrc</code> ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
<img src="https://velog.velcdn.com/images/bolero2/post/fcd3c298-dfe6-48b6-b3e4-9c3a1c5624e2/image.png" alt="" /></li>
</ul>

<blockquote>
  <p>/Users/{username}/opt/anaconda3 ì— ì‹¤ì œ íŒŒì¼ë“¤ì´ ë“¤ì–´ìˆë‹¤.
ì‚­ì œí•˜ê³  ì‹¶ìœ¼ë©´ í•´ë‹¹ í´ë”ë¥¼ ì‚­ì œí•´ì£¼ì.</p>
</blockquote>

<h2 id="2-pytorch-ì„¤ì¹˜">2. PyTorch ì„¤ì¹˜</h2>

<p>Anaconda m1 ë²„ì „ì„ ì˜ ì„¤ì¹˜í–ˆìœ¼ë‹ˆ, PyTorchë¥¼ ì„¤ì¹˜í•´ì£¼ì.</p>

<p>PyTorch ì„¤ì¹˜ëŠ” ì •ë§ ë§¤ìš° ì‰½ë‹¤.</p>

<p>ìš°ì„ , <a href="https://pytorch.org/get-started/locally/">https://pytorch.org/get-started/locally/</a> ë¡œ ê°€ì„œ ì„¤ì¹˜ ì»¤ë§¨ë“œë¥¼ ì•Œì•„ì•¼ í•œë‹¤.
<img src="https://velog.velcdn.com/images/bolero2/post/6003e2bf-22f6-4125-9494-41021b0e5bf7/image.png" alt="" /></p>

<p>(ì•„ê¹Œ ê³µì‹ ì¹¼ëŸ¼ì—ì„œ ë³´ì•˜ë“¯ì´, Nightly ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜í•´ì•¼ í•œë‹¤.)</p>

<p><code class="language-plaintext highlighter-rouge">pip install --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu </code></p>

<p>ë¡œ ì„¤ì¹˜í•˜ë©´ ëœë‹¤. ë°”ë¡œ ì„¤ì¹˜í•´ë³´ì.
<img src="https://velog.velcdn.com/images/bolero2/post/b13e16ec-d7de-4ad3-9ed4-733aac871746/image.png" alt="" /></p>

<p>PyTorch ì„¤ì¹˜ë„ ëë‚¬ë‹¤.</p>

<h2 id="3-pytorch-in-m1---gpu-acceleration">3. PyTorch in M1 - GPU Acceleration</h2>

<p>ì¼ë°˜ì ì¸ Nvidia gpuë¥¼ ì‚¬ìš©í•œë‹¤ë©´ GPU ê°€ì†í™”ë¥¼ ìœ„í•´ ì–´ë–»ê²Œ í•´ì•¼ í–ˆì„ê¹Œ.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">'cuda:0'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">" - device : </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">]])</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">" - cpu tensor : "</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">" - gpu tensor : "</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ gpu ê°€ì†ì´ ê°€ëŠ¥í–ˆë‹¤. (cuda:0ë²ˆ gpu deviceì— tensor í• ë‹¹)
<img src="https://velog.velcdn.com/images/bolero2/post/676b9471-2900-4f88-b2dd-2d399627ce8c/image.png" alt="" /></p>

<p>ì´ë ‡ê²Œ, gpu tensor ì¶œë ¥ ë¶€ë¶„ì˜ <code class="language-plaintext highlighter-rouge">device</code> ìª½ì— <strong><code class="language-plaintext highlighter-rouge">â€˜cuda:0â€™</code></strong>ì´ ì˜ ë“¤ì–´ê°„ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p>ê·¸ë ‡ë‹¤ë©´ M1ì€ ì–´ë””ì— í• ë‹¹í•´ì¤˜ì•¼ í• ê¹Œ?</p>

<p>M1 ì˜ ê²½ìš°ì—ëŠ”, â€˜cudaâ€™ ë§ê³  <strong>â€˜mpsâ€™</strong>ì— í• ë‹¹í•´ì•¼ í•œë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">'mps'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">" - device : </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">]])</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">" - cpu tensor : "</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">" - gpu tensor : "</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</code></pre></div></div>

<p>í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´
<img src="https://velog.velcdn.com/images/bolero2/post/7348052f-5f0b-478b-9fa3-b24dd9c9bbdd/image.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">device=</code> ìª½ì— <code class="language-plaintext highlighter-rouge">â€˜cuda:0â€™</code> ì´ ì•„ë‹Œ <strong><code class="language-plaintext highlighter-rouge">â€˜mpsâ€™</code></strong> ê°€ ë“¤ì–´ê°€ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<h2 id="4-speed-comparison">4. Speed Comparison</h2>

<p>ì†ë„ ë¹„êµë¥¼ í•´ë³´ì.</p>

<p>ë‹¹ì—°íˆ nvidia gpuë³´ë‹¤ëŠ” ëŠë¦´ ê²ƒìœ¼ë¡œ ì˜ˆìƒì´ ë˜ê¸´ í•˜ì§€ë§Œâ€¦ ì–¼ë§ˆë‚˜ ì°¨ì´ê°€ ë‚ ê¹Œ?</p>

<p>ë¹„êµ ëŒ€ìƒì€ ì´ 4ì¢…ë¥˜ì´ë‹¤.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Machine type</th>
      <th style="text-align: left">Name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Server GPU</td>
      <td style="text-align: left">Nvidia RTX A6000</td>
    </tr>
    <tr>
      <td style="text-align: left">M1 GPU</td>
      <td style="text-align: left">M1 GPU, 8 Core</td>
    </tr>
    <tr>
      <td style="text-align: left">Server CPU</td>
      <td style="text-align: left">Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz * 40 Core</td>
    </tr>
    <tr>
      <td style="text-align: left">M1 CPU</td>
      <td style="text-align: left">M1 CPU</td>
    </tr>
  </tbody>
</table>

<p>ê°„ë‹¨í•˜ê²Œ MNIST ë°ì´í„°ì…‹ì„ ë¶„ë¥˜í•˜ëŠ” torch ëª¨ë¸ì„ ì‘ì„±í–ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.nn.functional</span> <span class="kn">import</span> <span class="n">softmax</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>

<span class="c1"># device setting, nvidia='cuda:0' | m1='mps' | cpu='cpu'
</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="s">'cuda:0'</span>    <span class="c1"># "cuda:0" or "mps" or "cpu"
</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span> 
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">ch</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">actv</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Dropout2d</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Flatten</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">fn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fn2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fn3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">actv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">maxpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">bn2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">actv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">maxpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fn1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fn2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fn3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">train_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span> <span class="o">=</span> <span class="s">'./data/MNIST'</span><span class="p">,</span>
    <span class="n">train</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">download</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">()</span> <span class="c1"># ë°ì´í„°ë¥¼ 0ì—ì„œ 255ê¹Œì§€ ìˆëŠ” ê°’ì„ 0ì—ì„œ 1ì‚¬ì´ ê°’ìœ¼ë¡œ ë³€í™˜
</span>    <span class="p">])</span>
<span class="p">)</span>

<span class="n">test_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span> <span class="o">=</span> <span class="s">'./data/MNIST'</span><span class="p">,</span>
    <span class="n">train</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">download</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">()</span> <span class="c1"># ë°ì´í„°ë¥¼ 0ì—ì„œ 255ê¹Œì§€ ìˆëŠ” ê°’ì„ 0ì—ì„œ 1ì‚¬ì´ ê°’ìœ¼ë¡œ ë³€í™˜
</span>    <span class="p">])</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<span class="n">n_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">===== Model Architecture ====="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">===== Model Parameters ====="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">" - {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">n_params</span><span class="p">),</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="n">total_train_iter</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">total_valid_iter</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">)</span>

<span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">train_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">epochs_times</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Training start time : {}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
    <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">iter_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">image</span>  <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">target</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">train_acc</span> <span class="o">+=</span> <span class="n">acc</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_train_iter</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"[train %5s/%5s] Epoch: %4s | Time: %6.2fs | loss: %10.4f | Acc: %10.4f"</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">total_train_iter</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">iter_start</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc</span><span class="p">)))</span>

    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="n">total_train_iter</span>
    <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_acc</span> <span class="o">/</span> <span class="n">total_train_iter</span>
    <span class="n">epoch_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">epoch_start</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[Epoch {} training Ended] &gt; Time: {:.2}s/epoch | Loss: {:.4f} | Acc: {:g}</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
        <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epoch_runtime</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_loss</span><span class="p">),</span> <span class="n">train_acc</span><span class="p">))</span>
    
    <span class="n">epochs_times</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_runtime</span><span class="p">)</span>

<span class="n">program_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">train_start</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Training running time : {:.2}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">program_runtime</span><span class="p">))</span>

<span class="n">epochs_times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">epochs_times</span><span class="p">))</span>
<span class="n">epochs_times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">epochs_times</span><span class="p">))</span>

<span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__file__</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">".txt"</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">epochs_times</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'save success epoch times! -&gt; </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‹¤í—˜í•˜ë‹¤ë³´ë‹ˆ ì—„ì²­ë‚œ ë­”ê°€ê°€ ìˆì—ˆë‹¤â€¦</p>

<blockquote>
  <p>ğŸ§ ì‹¤í—˜í•˜ë©´ì„œ í¬ìŠ¤íŒ… ì‘ì„± ì¤‘ì¸ë°, m1ì—ì„œ image size=224 ë¡œ í•˜ê³  batch_size=64ë¡œ ì„¤ì • í›„ì— í•™ìŠµì„ ì‹¤í–‰í•˜ë©´ ì“°ë¡œí‹€ë§ì´ ê±¸ë¦°ë‹¤!!! ì´ê²Œ ë§ë‚˜??</p>

  <p>ì•„ì§ ëŒ€ê·œëª¨ì˜ í•™ìŠµì€ ì œëŒ€ë¡œ ì˜ ì•ˆë˜ëŠ” ëŠë‚Œì´ë‹¤â€¦</p>
</blockquote>

<ul>
  <li><strong>1 Epoch ê²½ê³¼ ì‹œê°„ (M1 GPU vs Server GPU)</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>base<span class="o">)</span> bolero is <span class="k">in </span>now ~ <span class="nv">$ </span>python m1_gpu.py 

<span class="o">=====</span> Model Architecture <span class="o">=====</span>
Model<span class="o">(</span>
  <span class="o">(</span>conv1<span class="o">)</span>: Conv2d<span class="o">(</span>1, 128, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn1<span class="o">)</span>: BatchNorm2d<span class="o">(</span>128, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>conv2<span class="o">)</span>: Conv2d<span class="o">(</span>128, 256, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn2<span class="o">)</span>: BatchNorm2d<span class="o">(</span>256, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>actv<span class="o">)</span>: ReLU<span class="o">(</span><span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>maxpool<span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="nv">kernel_size</span><span class="o">=</span>2, <span class="nv">stride</span><span class="o">=</span>2, <span class="nv">padding</span><span class="o">=</span>0, <span class="nv">dilation</span><span class="o">=</span>1, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>dropout<span class="o">)</span>: Dropout2d<span class="o">(</span><span class="nv">p</span><span class="o">=</span>0.5, <span class="nv">inplace</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>flatten<span class="o">)</span>: Flatten<span class="o">(</span><span class="nv">start_dim</span><span class="o">=</span>1, <span class="nv">end_dim</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span>
  <span class="o">(</span>fn1<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>12544, <span class="nv">out_features</span><span class="o">=</span>256, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn2<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>256, <span class="nv">out_features</span><span class="o">=</span>100, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn3<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>100, <span class="nv">out_features</span><span class="o">=</span>10, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
<span class="o">)</span> 

<span class="o">=====</span> Model Parameters <span class="o">=====</span>
 - 3535446 

Training start <span class="nb">time</span> : 2022-06-01 12:36:36.501451

/Users/bolero/m1_gpu.py:63: UserWarning: Implicit dimension choice <span class="k">for </span>softmax has been deprecated. Change the call to include <span class="nv">dim</span><span class="o">=</span>X as an argument.
  <span class="k">return </span>softmax<span class="o">(</span>x<span class="o">)</span>
<span class="o">[</span>train     1/ 3750] Epoch:    1 | Time:   0.32s | loss:     2.3119 | Acc:     0.1250
<span class="o">[</span>train  1876/ 3750] Epoch:    1 | Time:   0.03s | loss:     1.4933 | Acc:     0.9375
<span class="o">[</span>Epoch 1 training Ended] <span class="o">&gt;</span> Time: 1.3e+02s/epoch | Loss: 1.5247 | Acc: 0.9397
</code></pre></div></div>

<p><strong><em>M1 Macbook Pro</em></strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>neural<span class="o">)</span> NvidiaServer@NvidiaServer:~<span class="nv">$ </span>python server_gpu.py 

<span class="o">=====</span> Model Architecture <span class="o">=====</span>
Model<span class="o">(</span>
  <span class="o">(</span>conv1<span class="o">)</span>: Conv2d<span class="o">(</span>1, 128, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn1<span class="o">)</span>: BatchNorm2d<span class="o">(</span>128, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>conv2<span class="o">)</span>: Conv2d<span class="o">(</span>128, 256, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn2<span class="o">)</span>: BatchNorm2d<span class="o">(</span>256, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>actv<span class="o">)</span>: ReLU<span class="o">(</span><span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>maxpool<span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="nv">kernel_size</span><span class="o">=</span>2, <span class="nv">stride</span><span class="o">=</span>2, <span class="nv">padding</span><span class="o">=</span>0, <span class="nv">dilation</span><span class="o">=</span>1, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>dropout<span class="o">)</span>: Dropout2d<span class="o">(</span><span class="nv">p</span><span class="o">=</span>0.5, <span class="nv">inplace</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>flatten<span class="o">)</span>: Flatten<span class="o">(</span><span class="nv">start_dim</span><span class="o">=</span>1, <span class="nv">end_dim</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span>
  <span class="o">(</span>fn1<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>12544, <span class="nv">out_features</span><span class="o">=</span>256, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn2<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>256, <span class="nv">out_features</span><span class="o">=</span>100, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn3<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>100, <span class="nv">out_features</span><span class="o">=</span>10, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
<span class="o">)</span> 

<span class="o">=====</span> Model Parameters <span class="o">=====</span>
 - 3535446 

Training start <span class="nb">time</span> : 2022-06-01 03:36:49.959508

server_gpu.py:63: UserWarning: Implicit dimension choice <span class="k">for </span>softmax has been deprecated. Change the call to include <span class="nv">dim</span><span class="o">=</span>X as an argument.
  <span class="k">return </span>softmax<span class="o">(</span>x<span class="o">)</span>
<span class="o">[</span>train     1/ 3750] Epoch:    1 | Time:   0.04s | loss:     2.3063 | Acc:     0.0000
<span class="o">[</span>train  1876/ 3750] Epoch:    1 | Time:   0.01s | loss:     1.4613 | Acc:     1.0000
<span class="o">[</span>Epoch 1 training Ended] <span class="o">&gt;</span> Time: 2.7e+01s/epoch | Loss: 1.5264 | Acc: 0.938167
</code></pre></div></div>

<p><strong><em>Nvidia RTX A6000</em></strong></p>

<blockquote>
  <p>ğŸ§ 1 Epoch ê¹Œì§€ë§Œ ë´¤ì„ ë•Œ, Nvidia gpu ì„œë²„ìš©<strong>(RTX A6000)</strong> ì—ì„œëŠ” 27ì´ˆ~28ì´ˆ/epochê°€ ê±¸ë ¸ê³ , <strong><em>m1 ì—ì„œëŠ” 130ì´ˆ~140ì´ˆ/epochê°€ ê±¸ë ¸ë‹¤.</em>
ì•½ 5ë°°ì •ë„ ì°¨ì´ë‚˜ëŠ”ë°</strong>, í˜„ì¬ ì„œë²„ìš© GPU ê°€ ë„ˆë¬´ ìš°ì›”í•œ ì ë„ ìˆë‹¤.</p>
</blockquote>

<ul>
  <li><strong>1 Epoch ê²½ê³¼ ì‹œê°„ (M1 GPU vs Server CPU)</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>base<span class="o">)</span> bolero is <span class="k">in </span>now ~ <span class="nv">$ </span>python m1_gpu.py 

<span class="o">=====</span> Model Architecture <span class="o">=====</span>
Model<span class="o">(</span>
  <span class="o">(</span>conv1<span class="o">)</span>: Conv2d<span class="o">(</span>1, 128, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn1<span class="o">)</span>: BatchNorm2d<span class="o">(</span>128, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>conv2<span class="o">)</span>: Conv2d<span class="o">(</span>128, 256, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn2<span class="o">)</span>: BatchNorm2d<span class="o">(</span>256, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>actv<span class="o">)</span>: ReLU<span class="o">(</span><span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>maxpool<span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="nv">kernel_size</span><span class="o">=</span>2, <span class="nv">stride</span><span class="o">=</span>2, <span class="nv">padding</span><span class="o">=</span>0, <span class="nv">dilation</span><span class="o">=</span>1, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>dropout<span class="o">)</span>: Dropout2d<span class="o">(</span><span class="nv">p</span><span class="o">=</span>0.5, <span class="nv">inplace</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>flatten<span class="o">)</span>: Flatten<span class="o">(</span><span class="nv">start_dim</span><span class="o">=</span>1, <span class="nv">end_dim</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span>
  <span class="o">(</span>fn1<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>12544, <span class="nv">out_features</span><span class="o">=</span>256, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn2<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>256, <span class="nv">out_features</span><span class="o">=</span>100, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn3<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>100, <span class="nv">out_features</span><span class="o">=</span>10, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
<span class="o">)</span> 

<span class="o">=====</span> Model Parameters <span class="o">=====</span>
 - 3535446 

Training start <span class="nb">time</span> : 2022-06-01 12:36:36.501451

/Users/bolero/m1_gpu.py:63: UserWarning: Implicit dimension choice <span class="k">for </span>softmax has been deprecated. Change the call to include <span class="nv">dim</span><span class="o">=</span>X as an argument.
  <span class="k">return </span>softmax<span class="o">(</span>x<span class="o">)</span>
<span class="o">[</span>train     1/ 3750] Epoch:    1 | Time:   0.32s | loss:     2.3119 | Acc:     0.1250
<span class="o">[</span>train  1876/ 3750] Epoch:    1 | Time:   0.03s | loss:     1.4933 | Acc:     0.9375
<span class="o">[</span>Epoch 1 training Ended] <span class="o">&gt;</span> Time: 1.3e+02s/epoch | Loss: 1.5247 | Acc: 0.9397
</code></pre></div></div>

<p><strong><em>M1 Macbook Pro</em></strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>neural<span class="o">)</span> NvidiaServer@NvidiaServer:~<span class="nv">$ </span>python server_cpu.py 

<span class="o">=====</span> Model Architecture <span class="o">=====</span>
Model<span class="o">(</span>
  <span class="o">(</span>conv1<span class="o">)</span>: Conv2d<span class="o">(</span>1, 128, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn1<span class="o">)</span>: BatchNorm2d<span class="o">(</span>128, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>conv2<span class="o">)</span>: Conv2d<span class="o">(</span>128, 256, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn2<span class="o">)</span>: BatchNorm2d<span class="o">(</span>256, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>actv<span class="o">)</span>: ReLU<span class="o">(</span><span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>maxpool<span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="nv">kernel_size</span><span class="o">=</span>2, <span class="nv">stride</span><span class="o">=</span>2, <span class="nv">padding</span><span class="o">=</span>0, <span class="nv">dilation</span><span class="o">=</span>1, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>dropout<span class="o">)</span>: Dropout2d<span class="o">(</span><span class="nv">p</span><span class="o">=</span>0.5, <span class="nv">inplace</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>flatten<span class="o">)</span>: Flatten<span class="o">(</span><span class="nv">start_dim</span><span class="o">=</span>1, <span class="nv">end_dim</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span>
  <span class="o">(</span>fn1<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>12544, <span class="nv">out_features</span><span class="o">=</span>256, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn2<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>256, <span class="nv">out_features</span><span class="o">=</span>100, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn3<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>100, <span class="nv">out_features</span><span class="o">=</span>10, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
<span class="o">)</span> 

<span class="o">=====</span> Model Parameters <span class="o">=====</span>
 - 3535446 

Training start <span class="nb">time</span> : 2022-06-01 03:37:22.395249

server_cpu.py:63: UserWarning: Implicit dimension choice <span class="k">for </span>softmax has been deprecated. Change the call to include <span class="nv">dim</span><span class="o">=</span>X as an argument.
  <span class="k">return </span>softmax<span class="o">(</span>x<span class="o">)</span>
<span class="o">[</span>train     1/ 3750] Epoch:    1 | Time:   1.38s | loss:     2.3021 | Acc:     0.0625
<span class="o">[</span>train  1876/ 3750] Epoch:    1 | Time:   0.04s | loss:     1.4617 | Acc:     1.0000
<span class="o">[</span>Epoch 1 training Ended] <span class="o">&gt;</span> Time: 1.8e+02s/epoch | Loss: 1.5256 | Acc: 0.939617
</code></pre></div></div>

<p><strong><em>Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz * 40 Core</em></strong></p>

<blockquote>
  <p>ğŸ§ ë‹¤í–‰ìŠ¤ëŸ½ê²Œë„(?) <strong>M1 GPUê°€ Serverì˜ 40 Core CPUë³´ë‹¤ëŠ” ë¹¨ëë‹¤.</strong>
ìˆ˜ì¹˜ë¡œ ë³´ìë©´ M1 GPUê°€ 130ì´ˆ/epoch ì •ë„ ë‚˜ì˜¤ê³ , 40 Core CPUê°€ 180ì´ˆ/epoch ì •ë„ ë‚˜ì˜¨ë‹¤. (<strong>ì•½ 1.4ë°°ì •ë„ M1 GPUê°€ ë” ë¹ ë¦„</strong>)</p>
</blockquote>

<ol>
  <li><strong>1 Epoch ê²½ê³¼ ì‹œê°„ (M1 CPU vs M1 GPU)</strong></li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>base<span class="o">)</span> bolero is <span class="k">in </span>now ~ <span class="nv">$ </span>python m1_cpu.py 

<span class="o">=====</span> Model Architecture <span class="o">=====</span>
Model<span class="o">(</span>
  <span class="o">(</span>conv1<span class="o">)</span>: Conv2d<span class="o">(</span>1, 128, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn1<span class="o">)</span>: BatchNorm2d<span class="o">(</span>128, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>conv2<span class="o">)</span>: Conv2d<span class="o">(</span>128, 256, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn2<span class="o">)</span>: BatchNorm2d<span class="o">(</span>256, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>actv<span class="o">)</span>: ReLU<span class="o">(</span><span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>maxpool<span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="nv">kernel_size</span><span class="o">=</span>2, <span class="nv">stride</span><span class="o">=</span>2, <span class="nv">padding</span><span class="o">=</span>0, <span class="nv">dilation</span><span class="o">=</span>1, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>dropout<span class="o">)</span>: Dropout2d<span class="o">(</span><span class="nv">p</span><span class="o">=</span>0.5, <span class="nv">inplace</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>flatten<span class="o">)</span>: Flatten<span class="o">(</span><span class="nv">start_dim</span><span class="o">=</span>1, <span class="nv">end_dim</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span>
  <span class="o">(</span>fn1<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>12544, <span class="nv">out_features</span><span class="o">=</span>256, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn2<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>256, <span class="nv">out_features</span><span class="o">=</span>100, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn3<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>100, <span class="nv">out_features</span><span class="o">=</span>10, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
<span class="o">)</span> 

<span class="o">=====</span> Model Parameters <span class="o">=====</span>
 - 3535446 

Training start <span class="nb">time</span> : 2022-06-01 12:36:37.141268

/Users/bolero/m1_cpu.py:63: UserWarning: Implicit dimension choice <span class="k">for </span>softmax has been deprecated. Change the call to include <span class="nv">dim</span><span class="o">=</span>X as an argument.
  <span class="k">return </span>softmax<span class="o">(</span>x<span class="o">)</span>
<span class="o">[</span>train     1/ 3750] Epoch:    1 | Time:   0.09s | loss:     2.3023 | Acc:     0.1250
<span class="o">[</span>train  1876/ 3750] Epoch:    1 | Time:   0.05s | loss:     1.4612 | Acc:     1.0000
<span class="o">[</span>Epoch 1 training Ended] <span class="o">&gt;</span> Time: 1.7e+02s/epoch | Loss: 1.5262 | Acc: 0.938867
</code></pre></div></div>

<p><strong><em>M1 Macbook Pro - CPU</em></strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>base<span class="o">)</span> bolero is <span class="k">in </span>now ~ <span class="nv">$ </span>python m1_gpu.py 

<span class="o">=====</span> Model Architecture <span class="o">=====</span>
Model<span class="o">(</span>
  <span class="o">(</span>conv1<span class="o">)</span>: Conv2d<span class="o">(</span>1, 128, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn1<span class="o">)</span>: BatchNorm2d<span class="o">(</span>128, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>conv2<span class="o">)</span>: Conv2d<span class="o">(</span>128, 256, <span class="nv">kernel_size</span><span class="o">=(</span>3, 3<span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span>1, 1<span class="o">))</span>
  <span class="o">(</span>bn2<span class="o">)</span>: BatchNorm2d<span class="o">(</span>256, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span>0.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>actv<span class="o">)</span>: ReLU<span class="o">(</span><span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>maxpool<span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="nv">kernel_size</span><span class="o">=</span>2, <span class="nv">stride</span><span class="o">=</span>2, <span class="nv">padding</span><span class="o">=</span>0, <span class="nv">dilation</span><span class="o">=</span>1, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>dropout<span class="o">)</span>: Dropout2d<span class="o">(</span><span class="nv">p</span><span class="o">=</span>0.5, <span class="nv">inplace</span><span class="o">=</span>False<span class="o">)</span>
  <span class="o">(</span>flatten<span class="o">)</span>: Flatten<span class="o">(</span><span class="nv">start_dim</span><span class="o">=</span>1, <span class="nv">end_dim</span><span class="o">=</span><span class="nt">-1</span><span class="o">)</span>
  <span class="o">(</span>fn1<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>12544, <span class="nv">out_features</span><span class="o">=</span>256, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn2<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>256, <span class="nv">out_features</span><span class="o">=</span>100, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
  <span class="o">(</span>fn3<span class="o">)</span>: Linear<span class="o">(</span><span class="nv">in_features</span><span class="o">=</span>100, <span class="nv">out_features</span><span class="o">=</span>10, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
<span class="o">)</span> 

<span class="o">=====</span> Model Parameters <span class="o">=====</span>
 - 3535446 

Training start <span class="nb">time</span> : 2022-06-01 12:36:36.501451

/Users/bolero/m1_gpu.py:63: UserWarning: Implicit dimension choice <span class="k">for </span>softmax has been deprecated. Change the call to include <span class="nv">dim</span><span class="o">=</span>X as an argument.
  <span class="k">return </span>softmax<span class="o">(</span>x<span class="o">)</span>
<span class="o">[</span>train     1/ 3750] Epoch:    1 | Time:   0.32s | loss:     2.3119 | Acc:     0.1250
<span class="o">[</span>train  1876/ 3750] Epoch:    1 | Time:   0.03s | loss:     1.4933 | Acc:     0.9375
<span class="o">[</span>Epoch 1 training Ended] <span class="o">&gt;</span> Time: 1.3e+02s/epoch | Loss: 1.5247 | Acc: 0.9397
</code></pre></div></div>

<p><strong><em>M1 Macbook Pro - GPU</em></strong></p>

<blockquote>
  <p>ğŸ§ ì†”ì§íˆ M1-CPU ë‚˜ M1-GPU ë‚˜ ë­”ê°€ ì½”ë”© ì˜ëª»í–ˆì„ ì¤„ ì•Œê³  ê¸°ëŒ€ ì•ˆí–ˆëŠ”ë°, ì˜ì™¸ë¡œ ì°¨ì´ê°€ ë°œìƒí–ˆë‹¤.
<strong>M1-CPUê°€ 170ì´ˆ~180ì´ˆ/epoch ì •ë„ ë‚˜ì˜¤ê³ , M1-GPUëŠ” 130ì´ˆ/epoch ì •ë„ ë‚˜ì˜¤ëŠ”ë°, M1-CPU ì˜ ìˆ˜ì¤€ì´ Intel Xeon 4210R 2.40GHz 40 Core ì •ë„ì˜ ìˆ˜ì¤€ì„ ë³´ì˜€ë‹¤.</strong></p>
</blockquote>

<p>ê²°ë¡ ì€â€¦ M1-GPU ëŠ” ì—„ì²­ ì“¸ ì •ë„ëŠ” ì•„ë‹ˆë‹¤ ì•„ì§! ê·¸ë˜ë„ CPUë³´ë‹¤ëŠ” ë‚˜ìœ¼ë‹ˆ ê°„ë‹¨í•œ í…ŒìŠ¤íŒ… ì •ë„ëŠ” ë¬´ë¦¬ì—†ì´ ëŒë¦´ ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë¨.</p>

<p><strong>(ë‹¨ì ì€, ì•„ê¹Œ ì‹¤í—˜í•´ë´¤ëŠ”ë° <code class="language-plaintext highlighter-rouge">image_size=[224, 224]</code> ë¡œ í•˜ê³  <code class="language-plaintext highlighter-rouge">batch_size=64</code> ë¡œ í•˜ë‹ˆê¹Œ macbookì— 5~7ì´ˆë§ˆë‹¤ ì“°ë¡œí‹€ë§ì´ ë°œìƒí–ˆë‹¤â€¦ğŸ¥²)</strong></p>

<p>í•™ìŠµ ì¢…ë£Œ ë•Œ ì‹¤í—˜ ë°©ì‹ ë³„ ë§¤ Epochì˜ ì†Œìš”ì‹œê°„ì„ ì €ì¥í•˜ëŠ”ë°, ê·¸ë˜í”„ë¡œ ê·¸ë ¤ë³´ëŠ” ê±¸ë¡œ í¬ìŠ¤íŒ…ì„ ë§ˆë¬´ë¦¬ í•˜ê² ë‹¤.
(server CPUëŠ” ì„œë²„ ë¨¸ì‹ ì˜ ë‹¤ë¥¸ ì‘ì—…ë•Œë¬¸ì— 20 Epochsê¹Œì§€ ì¸¡ì •í•˜ì§€ ëª»í•¨.)</p>

<p><strong>ì†ŒìŠ¤ì½”ë“œ</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">server_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span>
<span class="n">m1_gpu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span>
<span class="n">m1_cpu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)]</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"server_gpu.txt"</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">server_gpu</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">server_gpu</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">server_gpu</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"m1_gpu.txt"</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">m1_gpu</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">m1_gpu</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">m1_gpu</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"m1_cpu.txt"</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">m1_cpu</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">m1_cpu</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">m1_cpu</span><span class="p">))</span>

<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training time per devices'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">server_gpu</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'o'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'green'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">m1_gpu</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'o'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">m1_cpu</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'o'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">([</span><span class="s">'Server GPU'</span><span class="p">,</span> <span class="s">'Server CPU'</span><span class="p">,</span> <span class="s">'M1 GPU'</span><span class="p">,</span> <span class="s">'M1 CPU'</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Epochs"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Running time(seconds)"</span><span class="p">)</span>
<span class="c1"># plt.show()
</span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">"runtime.png"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>ê²°ê³¼ ì´ë¯¸ì§€</strong><br />
<img src="https://velog.velcdn.com/images/bolero2/post/b04b61e8-e95a-46be-b214-049e490f2955/image.png" alt="" /></p>]]></content><author><name>bolero2</name></author><category term="DeepLearning" /><summary type="html"><![CDATA[M1 macbookì— Anaconda nativeì™€ pytorch native ì„¤ì¹˜ ë° ì†ë„ ë¹„êµ]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-pytorch-m1.png" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-pytorch-m1.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[DL] NMS, Non-Maximum Suppression íŒŒí—¤ì¹˜ê¸°</title><link href="http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/" rel="alternate" type="text/html" title="[DL] NMS, Non-Maximum Suppression íŒŒí—¤ì¹˜ê¸°" /><published>2022-05-12T00:00:00+09:00</published><updated>2022-05-12T00:00:00+09:00</updated><id>http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS</id><content type="html" xml:base="http://localhost:4000/deeplearning/2022/05/12/DL-Principle-of-NMS/"><![CDATA[<p><span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    ObjectDetection
</span></p>

<h2 id="0-intro">0. Intro</h2>

<p>NMSë€? Non-maximum Suppressionì˜ ì•½ìë¡œì¨, <strong>ë¹„ìµœëŒ€ ì–µì œ ì•Œê³ ë¦¬ì¦˜</strong>ìœ¼ë¡œ ìƒê°í•˜ë©´ ëœë‹¤.
ë§ ê·¸ëŒ€ë¡œ, ìµœëŒ€ê°€ ì•„ë‹Œ ë°•ìŠ¤ë“¤(=Bounding Box)ì„ ì‚­ì œí•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ë‹¤.</p>

<p><strong>Object Detection</strong> Taskì—ì„œ ê°ì²´ì— ëŒ€í•œ ìµœì¢… Bounding Boxë¥¼ ê²°ì •ì§€ì„ ë•Œ ì‚¬ìš©í•œë‹¤.</p>

<hr />

<h2 id="1-principle">1. Principle</h2>

<p>ì‘ë™ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<blockquote>
  <ol>
    <li>Predictioní•  ì´ë¯¸ì§€ë¥¼ Networkì— Forward ì‹œí‚¨ë‹¤.</li>
    <li>ì¶œë ¥ ê°€ëŠ¥í•œ ëª¨ë“  ë°•ìŠ¤ë¥¼ êµ¬í•œë‹¤. (NMS ì´ì „ì´ë¯€ë¡œ, ìˆ˜ì‹­~ìˆ˜ë°±ê°œì˜ ë°•ìŠ¤ ì •ë³´ê°€ ë‚˜ì˜¨ë‹¤.)</li>
    <li>í•´ë‹¹ ë°•ìŠ¤ ì •ë³´ë“¤ì„ <strong>Confidence Score</strong> ìˆœìœ¼ë¡œ ì •ë ¬í•œë‹¤.</li>
    <li>ë°•ìŠ¤ ì •ë³´ë“¤ì˜ <strong>Confidence Score</strong>ì™€, ê° ë°•ìŠ¤ ê°„ì˜ <strong>IoU</strong>ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•˜ì—¬ NMSë¥¼ ì ìš©í•œë‹¤.</li>
    <li>NMS ì ìš© í›„ì—ëŠ”, ì•Œë§ëŠ” ë°•ìŠ¤ë¼ê³  ì—¬ê²¨ì§€ëŠ” ê°’ë“¤ë§Œ ì¶œë ¥ëœë‹¤.</li>
  </ol>
</blockquote>

<p>í•µì‹¬ í‚¤ì›Œë“œë¥¼ ë½‘ìë©´, <strong>Confidence Score</strong>ì™€ <strong>IoU</strong>ë¼ê³  ìƒê°í•œë‹¤. (ì´ ë‘ ë‹¨ì–´ë¡œ êµ¬í˜„ì´ ê°€ëŠ¥í•¨.)</p>

<h3 id="1-1-confidence-score">1-1. Confidence-Score?</h3>

<p>ì—¬ê¸°ì„œ <strong>Confidence Score(ì‹ ë¢°ë„, ì‹ ë¢° ì ìˆ˜)</strong>ë¼ê³  í•˜ëŠ” ê²ƒì€
<strong>ë„¤íŠ¸ì›Œí¬ê°€ ì •ë‹µì„ ë„ì¶œí•´ëƒˆì„ ë•Œ, ê·¸ ì •ë‹µì— ëŒ€í•´ n%ì˜ í™•ì‹ ë„ë¥¼ ê°–ëŠ”ë‹¤ëŠ” ì˜ë¯¸</strong>ì´ë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, A ë°•ìŠ¤ì— ëŒ€í•œ Confidence Scoreê°€ 0.75ë¼ë©´,
ë„¤íŠ¸ì›Œí¬ê°€ ìƒê°í–ˆì„ ë•Œ â€œì•„, ì´ ë°•ìŠ¤ë¥¼ ë‚´ê°€ ë„ì¶œí•˜ê¸´ í–ˆëŠ”ë°, ì´ ë°•ìŠ¤ê°€ ì •ë‹µì¼ í™•ë¥ ì€ <strong>75%</strong> ì •ë„ì•¼.â€ ë¼ëŠ” ì˜ë¯¸ì´ë‹¤.</p>

<h3 id="1-2-iou">1-2. IoU?</h3>

<p>IoUëŠ” <strong>Intersection Over Union</strong>ì˜ ì•½ìì´ë‹¤.
<img src="https://images.velog.io/images/bolero2/post/93cd3e8c-b77f-4de9-a3f4-d7683c4e6838/iou.png" alt="iou.png" /></p>

<p>(Object Detection ì„ ë‹¤ë¤„ë³¸ ê°œë°œìë¼ë©´ ë§ì´ ì ‘í•´ë´¤ì„ ë“¯í•œ ê·¸ë¦¼.)</p>

<p>ì‰½ê²Œ ë§í•´ì„œ, ë‘ ë°•ìŠ¤ì˜ <strong>êµì§‘í•©</strong> / ë‘ ë°•ìŠ¤ì˜ <strong>í•©ì§‘í•©</strong> ì´ë‹¤.
ì½”ë“œë¡œ ë³´ìë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>			<span class="c1"># area of box n.
</span>        <span class="k">return</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># intersection area
</span>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">area_a</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
        <span class="n">area_b</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inter_area</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_a</span> <span class="o">+</span> <span class="n">area_b</span> <span class="o">-</span> <span class="n">inter_area</span><span class="p">)</span>    

    <span class="c1"># if boxes do not intersect
</span>    <span class="k">if</span> <span class="n">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="n">inter_area</span><span class="p">)</span>
    
    <span class="c1"># intersection over union
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">if</span> <span class="n">iou</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">iou</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Measure is wrong! : IoU Value is [</span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s">]."</span>
    <span class="k">return</span> <span class="n">iou</span>
</code></pre></div></div>

<p>box1ê³¼ box2ê°€ ì…ë ¥ìœ¼ë¡œ ì™”ì„ ë•Œ, ë‘ ë°•ìŠ¤ì˜ IoUë¥¼ ê³„ì‚°í•´ì£¼ëŠ” ì½”ë“œì´ë‹¤.
boxì˜ ì¢Œí‘œ ì²´ê³„ëŠ” <strong>[center_x, center_y, width, height]</strong> ì´ê³ , <strong>ìƒëŒ€ ì¢Œí‘œ</strong> ì´ë‹¤.
(YOLOì˜ ë¼ë²¨ë§ ë°©ë²•ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.)</p>

<hr />

<h2 id="2-sample-code">2. Sample Code</h2>

<p>ì½”ë“œë¡œ ì‚´í´ë³´ì.
ì„ì˜ë¡œ ë°•ìŠ¤ ì •ë³´ë“¤ì„ ìƒì„±í•´ì£¼ê³ , Confidence Score ê°’ë„ ë„£ì–´ì£¼ì—ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colorset</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>		<span class="c1"># Red
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Green
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Blue
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="c1"># Cyan
</span>        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>		<span class="c1"># Magenta
</span>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>		<span class="c1"># Yellow
</span><span class="p">]</span>

<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span>

<span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># left sector boxes
</span>    <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>        <span class="c1"># Red
</span>    <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>    <span class="c1"># Green
</span>    <span class="p">[</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>    <span class="c1"># Blue
</span>
    <span class="c1"># right sector boxes
</span>    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>     <span class="c1"># cyan
</span>    <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>    <span class="c1"># magenta
</span>    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">],</span>   <span class="c1"># yellow
</span><span class="p">]</span>
</code></pre></div></div>
<p><strong>ë°•ìŠ¤ ì •ë³´ëŠ” [center_x, center_y, width, height, conf_score] ìˆœìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆê³ ,
ì ˆëŒ€ ì¢Œí‘œì´ë‹¤. (0~1 ì‚¬ì´ë¡œ ìŠ¤ì¼€ì¼ë§ ëœ ê°’)</strong></p>

<p>í•´ë‹¹ ë°•ìŠ¤ë“¤ì„ 600 * 600ì˜ ë¹ˆ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ë³´ë©´, ë‹¤ìŒê³¼ ê°™ì€ ë°•ìŠ¤ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p><img src="https://images.velog.io/images/bolero2/post/c166b00b-67ec-4c8c-a644-40a47109769e/before_nms.jpg" alt="before_nms.jpg" /></p>

<p><strong>(ë°•ìŠ¤ ê·¸ë ¤ì£¼ëŠ” ì½”ë“œ)</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>			<span class="c1"># empty canvas
</span><span class="n">canvas_copy</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>						<span class="c1"># for after nms
</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                          <span class="n">colorset</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>ì„ì˜ë¡œ ë§Œë“  ë°•ìŠ¤ë“¤ì´ê¸° ë•Œë¬¸ì—, ìš°ë¦¬ëŠ” ì–´ë–¤ ê²ƒì´ NMS í†µê³¼ í›„ì— ë‚¨ì•„ì•¼ í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤.
ë°”ë¡œ <strong>Red</strong>ì™€ <strong>Cyan</strong> ìƒ‰ìƒì˜ ë°•ìŠ¤ë§Œ ë‚¨ì•„ì•¼ í•œë‹¤.
<em>(ì´ìœ ëŠ”, ì¢Œ/ìš°ì¸¡ ì„¹í„° ê¸°ì¤€ìœ¼ë¡œ ì‹ ë¢° ì ìˆ˜ê°€ ê°€ì¥ ë†’ê¸° ë•Œë¬¸ì´ë‹¤.)</em></p>

<p>ê·¸ë¦¬ê³ , <strong>NMS(boxes, iou_thres=0.4)</strong> í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ì£¼ì—ˆë‹¤. (ì¤‘ê°„ì— ì¶œë ¥ì„ ë””ë²„ê¹…í•´ë³¼ ìˆ˜ ìˆëŠ” printë¬¸ì´ ìˆë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># sorting
</span>    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">)</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span>
</code></pre></div></div>

<p>ìˆœì„œëŠ” <strong>1. ì›ë¦¬</strong>ì—ì„œ ë³¸ ê²ƒê³¼ ë™ì¼í•˜ë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>
</code></pre></div></div>
<p>ì—¬ê¸° ë¶€ë¶„ì—ì„œ Confidence Score ìˆœìœ¼ë¡œ box ì •ë³´ë“¤ì„ ì •ë ¬í•˜ê³ ,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>
</code></pre></div></div>
<p>ë¶€ë¶„ì—ì„œ ì‹¤ì œë¡œ IoU ê°’ì„ êµ¬í•˜ë©´ì„œ, íƒˆë½ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.</p>

<p>IoU Thresholdë¥¼ 0.4ë¡œ ì„¤ì •í•˜ì˜€ê¸° ë•Œë¬¸ì—,
ë°•ìŠ¤ ê°„ì˜ IoU ê°’ì´ 0.4 ì´ìƒì¸ ê²½ìš°ì—ëŠ”, <strong>Confidence Scoreê°€ ë‚®ì€ ë°•ìŠ¤ê°€ íƒˆë½í•œë‹¤.</strong></p>

<p>íƒˆë½ ì—¬ë¶€ëŠ” <code class="language-plaintext highlighter-rouge">answer = [True for x in range(sorted_boxes.shape[0])]</code> ë¡œ ë¯¸ë¦¬ ë°•ìŠ¤ ê°œìˆ˜ë§Œí¼ Trueë¥¼ ì ì–´ë‘ê³ ,
íƒˆë½ëœ ë°•ìŠ¤ ìë¦¬ì— <code class="language-plaintext highlighter-rouge">False</code>ë¥¼ ê¸°ë¡í•œë‹¤.</p>

<hr />

<p>ë””ë²„ê¹… ì¶œë ¥ë¬¼ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ul>
  <li>** ì •ë ¬ ì´ì „ì˜ box ì •ë³´ë“¤**
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Before</span> <span class="n">Arrange</span>
<span class="p">[[</span><span class="mf">0.3</span>  <span class="mf">0.3</span>  <span class="mf">0.1</span>  <span class="mf">0.1</span>  <span class="mf">0.9</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.31</span> <span class="mf">0.28</span> <span class="mf">0.14</span> <span class="mf">0.13</span> <span class="mf">0.5</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.28</span> <span class="mf">0.28</span> <span class="mf">0.09</span> <span class="mf">0.11</span> <span class="mf">0.3</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.65</span> <span class="mf">0.2</span>  <span class="mf">0.2</span>  <span class="mf">0.99</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.7</span>  <span class="mf">0.63</span> <span class="mf">0.22</span> <span class="mf">0.18</span> <span class="mf">0.35</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.62</span> <span class="mf">0.22</span> <span class="mf">0.22</span> <span class="mf">0.77</span><span class="p">]]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>ì •ë ¬ ì´í›„ì˜ box ì •ë³´ë“¤</strong> (confidence score ìˆœì„œë¡œ ì˜ ì •ë ¬ë˜ì—ˆë‹¤.)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">After</span> <span class="n">Arrange</span>
<span class="p">[[</span><span class="mf">0.75</span> <span class="mf">0.65</span> <span class="mf">0.2</span>  <span class="mf">0.2</span>  <span class="mf">0.99</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.3</span>  <span class="mf">0.3</span>  <span class="mf">0.1</span>  <span class="mf">0.1</span>  <span class="mf">0.9</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.75</span> <span class="mf">0.62</span> <span class="mf">0.22</span> <span class="mf">0.22</span> <span class="mf">0.77</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.31</span> <span class="mf">0.28</span> <span class="mf">0.14</span> <span class="mf">0.13</span> <span class="mf">0.5</span> <span class="p">]</span>
 <span class="p">[</span><span class="mf">0.7</span>  <span class="mf">0.63</span> <span class="mf">0.22</span> <span class="mf">0.18</span> <span class="mf">0.35</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.28</span> <span class="mf">0.28</span> <span class="mf">0.09</span> <span class="mf">0.11</span> <span class="mf">0.3</span> <span class="p">]]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Answerë¼ëŠ” ë³€ìˆ˜ë¥¼ ë‘ê³ , íƒˆë½ ì—¬ë¶€ë¥¼ ìœ„í•œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í–ˆë‹¤.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Before</span> <span class="n">NMS</span> <span class="n">Answer</span> <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
  <li><strong>NMS ë™ì‘ ê³¼ì •, íƒˆë½í•˜ë©´ Answer[index]ì— Falseë¥¼ ê¸°ë¡í•œë‹¤.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span> <span class="n">vs</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">1.0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">2</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.754</span>
<span class="n">Index</span> <span class="mi">2</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">3</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.519</span>
<span class="n">Index</span> <span class="mi">4</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">0</span> <span class="n">vs</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">1.0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">2</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">3</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.469</span>
<span class="n">Index</span> <span class="mi">3</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">4</span> <span class="o">=</span> <span class="n">iou</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">vs</span> <span class="mi">5</span> <span class="o">=</span> <span class="n">iou</span> <span class="mf">0.463</span>
<span class="n">Index</span> <span class="mi">5</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">.</span>
</code></pre></div>    </div>
    <p>: ì›ë˜ëŠ” ìê¸° ìì‹ ê³¼ëŠ” ë¹„êµí•˜ë©´ ì•ˆë˜ëŠ”ë°, ê·¸ëƒ¥ ë¹„êµí•˜ê²Œ ì§°ë‹¤. (ì‹¬í”Œí•˜ê²Œ)
ê·¸ ë¶€ë¶„ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì½”ë“œì— <code class="language-plaintext highlighter-rouge">int(iou_val) != 1</code>ì¸ ì¡°ê±´ì„ ì¶”ê°€í•˜ì˜€ë‹¤.
<strong>(iou_valì´ 1ì´ë¼ëŠ” ëœ»ì€, ìê¸° ìì‹ ê³¼ ë¹„êµí•œ ê²½ìš°ì´ë‹¤.)</strong></p>
  </li>
</ul>

<p>ì´ì œ ë³´ë©´, 2ê°œì˜ ê²½ìš°ê°€ ìˆë‹¤.</p>
<ul>
  <li><strong>IoUê°€ 0.4ë³´ë‹¤ ì‘ì„ ê²½ìš°</strong></li>
  <li><strong>IoUê°€ 0.4ë³´ë‹¤ í´ ê²½ìš°</strong></li>
</ul>

<p>1) ì‘ì„ ê²½ìš°ëŠ”, <strong>ì‚´ì•„ë‚¨ëŠ” ë°•ìŠ¤</strong>ì´ë‹¤.
2) í´ ê²½ìš°ëŠ”, <strong>íƒˆë½í•˜ëŠ” ë°•ìŠ¤</strong>ì´ë‹¤.
(0.9 confì˜ ë°•ìŠ¤ì™€ 0.4 confì˜ ë°•ìŠ¤ë¥¼ ë¹„êµí•˜ì—¬ iou_val == 0.5ë¼ê³  í•œë‹¤ë©´, 0.4 confì˜ ë°•ìŠ¤ê°€ íƒˆë½í•œë‹¤.)</p>

<ul>
  <li><strong>NMS ì´í›„ì— ì‚´ì•„ë‚¨ëŠ” ë°•ìŠ¤ì˜ index, Answer ë³€ìˆ˜ì— boolean ê°’ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆë‹¤.</strong>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">After</span> <span class="n">NMS</span> <span class="n">Answer</span> <span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>return ë˜ëŠ” ê°’ì€, Answer ë³€ìˆ˜ì™€ sorted_boxes, sorted_indexë¥¼ ë°˜í™˜í•´ì£¼ì—ˆë‹¤.
main ë¬¸ì—ì„œ ë°•ìŠ¤ë¥¼ ì˜ ë³¼ ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•¨ì´ë‹¤.</p>

<hr />

<h2 id="3-result">3. Result</h2>

<p>main ë¬¸ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ NMS í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>ì—¬ê¸°ì„œ boxesëŠ” before Arrange ë°•ìŠ¤ë“¤ì´ë‹¤.</strong></p>

<p>ê·¸ë¦¬ê³ , answerê³¼ sorted_boxes, sorted_index ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ,
ìƒˆë¡œìš´ ë¹„ì–´ìˆëŠ” canvasì— ê·¸ë ¤ì¤€ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span><span class="p">)):</span>
    <span class="n">sbox</span><span class="p">,</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">datum</span>
    <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas_copy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="n">colorset</span><span class="p">[</span><span class="n">sidx</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>
<p><strong>(Answer ë³€ìˆ˜ê°€ <em>True</em> ì¸ boxë§Œ ê·¸ë ¤ì¤€ë‹¤.)</strong></p>

<p>ê·¸ëŸ¬ë©´, ë‹¤ìŒê³¼ ê°™ì´ Redì™€ Cyan ìƒ‰ìƒì˜ ë°•ìŠ¤ë§Œ ë‚¨ì€ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
<img src="https://images.velog.io/images/bolero2/post/509a537d-77a4-41c6-8c59-b5bb0fa6e2a0/after_nms.jpg" alt="after_nms.py" /></p>

<hr />

<h2 id="4-full-code">4. Full Code</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_get_area</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>			<span class="c1"># area of box n.
</span>        <span class="k">return</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="c1"># intersection area
</span>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">area_a</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box1</span><span class="p">)</span>
        <span class="n">area_b</span> <span class="o">=</span> <span class="n">_get_area</span><span class="p">(</span><span class="n">box2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inter_area</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">area_a</span> <span class="o">+</span> <span class="n">area_b</span> <span class="o">-</span> <span class="n">inter_area</span><span class="p">)</span>    

    <span class="c1"># if boxes do not intersect
</span>    <span class="k">if</span> <span class="n">_is_box_intersect</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">_get_intersection_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">_get_union_area</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">inter_area</span><span class="o">=</span><span class="n">inter_area</span><span class="p">)</span>
    
    <span class="c1"># intersection over union
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">if</span> <span class="n">iou</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iou</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">iou</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Measure is wrong! : IoU Value is [</span><span class="si">{</span><span class="n">iou</span><span class="si">}</span><span class="s">]."</span>
    <span class="k">return</span> <span class="n">iou</span>


<span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># sorting
</span>    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elems</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sorted_boxes</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After Arrange"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">)</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Before NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">iou_val</span> <span class="o">=</span> <span class="n">iou</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_boxes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> vs </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = iou </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">iou_val</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iou_val</span> <span class="o">&gt;=</span> <span class="n">iou_thres</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">iou_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">answer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Index </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> is False."</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After NMS Answer :"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">colorset</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span>

    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># left boxes
</span>        <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>                  <span class="c1"># Red
</span>        <span class="p">[</span><span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>              <span class="c1"># Green
</span>        <span class="p">[</span><span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>              <span class="c1"># Blue
</span>
        <span class="c1"># right boxes
</span>        <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>               <span class="c1"># cyan
</span>        <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">],</span>              <span class="c1"># magenta
</span>        <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">],</span>             <span class="c1"># yellow
</span>    <span class="p">]</span>

    <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>
    <span class="n">canvas_copy</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                              <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                              <span class="n">colorset</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">answer</span><span class="p">,</span> <span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">iou_thres</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_boxes</span><span class="p">,</span> <span class="n">sorted_index</span><span class="p">)):</span>
        <span class="n">sbox</span><span class="p">,</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">datum</span>
        <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas_copy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                       <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                       <span class="n">colorset</span><span class="p">[</span><span class="n">sidx</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># print(canvas)
</span>    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Before NMS"</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"After NMS"</span><span class="p">,</span> <span class="n">canvas_copy</span><span class="p">)</span>

    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"before_nms.jpg"</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"after_nms.jpg"</span><span class="p">,</span> <span class="n">canvas_copy</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>]]></content><author><name>bolero2</name></author><category term="DeepLearning" /><summary type="html"><![CDATA[Object Detectionì—ì„œ ì‚¬ìš©í•˜ëŠ” NMS(Non-Maximum Suppression, ë¹„ ìµœëŒ€ ì–µì œ ì•Œê³ ë¦¬ì¦˜)ì— ëŒ€í•´ ì•Œì•„ë³´ê³ , ê°„ë‹¨í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ì—¬ ì‹¤ìŠµí•´ë´…ë‹ˆë‹¤.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-nms.jpg" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-nms.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[Paper] GA-Net: Guided Aggregation Net for End-to-end Stereo Matching</title><link href="http://localhost:4000/paper/2022/05/07/Paper-GA-Net-Guided-Aggregation-Net-for-End-to-end-Stereo-Matching/" rel="alternate" type="text/html" title="[Paper] GA-Net: Guided Aggregation Net for End-to-end Stereo Matching" /><published>2022-05-07T00:00:00+09:00</published><updated>2022-05-07T00:00:00+09:00</updated><id>http://localhost:4000/paper/2022/05/07/Paper-GA-Net-Guided-Aggregation-Net-for-End-to-end-Stereo-Matching</id><content type="html" xml:base="http://localhost:4000/paper/2022/05/07/Paper-GA-Net-Guided-Aggregation-Net-for-End-to-end-Stereo-Matching/"><![CDATA[<p><span class="tag  is-primary ">
    Paper
</span>
<span class="tag  is-primary ">
    DeepLearning
</span></p>

<h1 id="ga-net-guided-aggregation-net-for-end-to-end-stereo-matching">GA-Net: Guided Aggregation Net for End-to-end Stereo Matching</h1>

<p>ì´ë²ˆì— ì†Œê°œí•  ë…¼ë¬¸ì€ 2019ë…„ì— CVPR Oral ì„¹ì…˜ì—ì„œ ê³µê°œëœ
<strong>GA-Net</strong> ì´ë¼ëŠ” ë”¥ëŸ¬ë‹ ëª¨ë¸ì…ë‹ˆë‹¤.</p>

<p>2019ë…„ ë‹¹ì‹œì—, RGB ì´ë¯¸ì§€ì—ì„œ Depth ì´ë¯¸ì§€ë¥¼ ì¶”ì •í•˜ëŠ” <strong>Depth Estimation</strong>ì— ê´€í•œ ì—°êµ¬ê°€ í™œë°œíˆ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<p>GA-Netì€ Stereo ì˜ìƒ(ì–‘ì•ˆ)ì—ì„œ Depth Imageë¥¼ ì¶”ì •í•˜ëŠ” ë”¥ëŸ¬ë‹ ë„¤íŠ¸ì›Œí¬ì…ë‹ˆë‹¤.</p>

<p>GA-Netì€ ê·¸ë“¤ë§Œì˜ ë°©ë²•ìœ¼ë¡œ Computing costë¥¼ ì¤„ì´ê³ , ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ëŠ” ê²°ê³¼ë¥¼ ë„ì¶œí–ˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="1-stereo-matching">1. Stereo Matching?</h2>
<ul>
  <li>Disparity Estimation</li>
  <li>ê°ê° ë‹¤ë¥¸ ì‹œì„ ì—ì„œ í”½ì…€ë“¤ì„ ë§¤ì¹­ì‹œí‚¤ëŠ” ê²ƒ.</li>
</ul>

<p><img src="https://velog.velcdn.com/images/bolero2/post/6e9cb1c3-067f-4e21-ab5a-b9e3a22d7516/image.png" alt="" /></p>

<hr />

<h2 id="2-contribution">2. Contribution</h2>

<p>1) ê¸°ì¡´ì˜ GC-Netì˜ ê²½ìš°, 3D stereo matching ì—°êµ¬ì—ì„œ 3D Convë¥¼ ì‚¬ìš©</p>

<p>2) ì´ 3D convëŠ” ê³ ë¹„ìš©/ë†’ì€ ë³µì¡ë„ë¥¼ ìš”êµ¬ â†’ ì—°ì‚° ì‹œ ì†Œìš”ë˜ëŠ” ì‹œê°„ì´ ê¸¸ë‹¤.</p>

<p>3) ê¸°ì¡´ì˜ SGA(Semi-Global Aggregation)ì„ ë‹¤ë¥¸ ë°©í–¥ìœ¼ë¡œ ê°œì„ </p>

<p>4) ì—¬ê¸°ì— ì¶”ê°€ì ìœ¼ë¡œ LGA(Local Guided Aggregation) ê°œë°œ</p>

<p>5) <strong>SGA+LGAëŠ” 3D Convë¥¼ ëŒ€ì²´ ê°€ëŠ¥í•˜ê³ , 1/100 ìˆ˜ì¤€ì˜ ë³µì¡ë„ë¥¼ ê°€ì§„ë‹¤.</strong></p>

<p>6) 15-20fpsë¡œ ì‹¤ì‹œê°„ í‰ê°€ ë° ëŒ€ì¡° ê°€ëŠ¥</p>

<hr />

<h2 id="3-improvement-of-sga">3. Improvement of SGA</h2>

<p>1) ê¸°ì¡´ì˜ SGAëŠ” ì§ì ‘ ì¡°ì •(tuning)í•˜ê¸° í˜ë“  ì‚¬ìš©ì ì„¤ì • íŒŒë¼ë¯¸í„°ê°€ ìˆìŒ, ì´ íŒŒë¼ë¯¸í„°ëŠ” ë„¤íŠ¸ì›Œí¬ í•™ìŠµ ë„ì¤‘ì— ê°€ë³€ì„±ì´ ë§¤ìš° ë†’ë‹¤ â†’ unstable í•¨.</p>

<p>2) SGMìœ¼ë¡œ í”½ì…€ ë§¤ì¹­ ì‹œ ë„ˆë¬´ ë‹¤ë¥¸ í™˜ê²½ì— ì˜í–¥ì„ ë§ì´ ë°›ìŒ.</p>

<p>3) ê·¸ë˜ì„œ SGAë¥¼ ì„¸ ë°©í–¥ìœ¼ë¡œ ê°œì„ í•¨.</p>
<blockquote>
  <p>3-1) ì‚¬ìš©ì ì„¤ì • íŒŒë¼ë¯¸í„°ë¥¼ í•™ìŠµ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½(learnable)</p>

  <p>3-2) ì²« ë²ˆì§¸/ì™¸ë¶€ ìµœì†Œ ì„ íƒì„ ê°€ì¤‘ì¹˜ì˜ í•©ìœ¼ë¡œ ëŒ€ì²´í•¨, ê¸°ì¡´ ì—°êµ¬ì—ì„œ stridesëŠ” max-pooling layer ëŒ€ì²´í•´ì„œ ì •í™•ë„ ì†ì‹¤ì´ ì—†ìŒì„ ë°í˜”ìŒ.</p>

  <p>3-3) ë‚´ë¶€/ë‘ ë²ˆì§¸ ìµœì†Œ ì„ íƒ(selection)ì„ ìµœëŒ€ ì„ íƒìœ¼ë¡œ ë³€ê²½ â†’ ë³¸ ëª¨ë¸ì˜ í•™ìŠµí•˜ê³ ì í•˜ëŠ” íƒ€ê²Ÿì€ ë§¤ì¹­ ì½”ìŠ¤íŠ¸ë¥¼ ìµœì†Œí™”í•˜ëŠ” ê²ƒ ëŒ€ì‹  ground truthì˜ ì˜ˆìƒ ì ìˆ˜(confidence scoreì™€ ë¹„ìŠ·í•œ ê°œë…)ë¥¼ ìµœëŒ€í™”í•˜ëŠ” ê²ƒì„ ì¤‘ì ìœ¼ë¡œ ë³´ê¸° ë•Œë¬¸. (ë‹¤ì‹œ ë§í•´ì„œ, ìµœëŒ€í•œ ì˜ ë§ì¶”ëŠ” ê²ƒì— ì§‘ì¤‘í•¨)</p>
</blockquote>

<hr />

<h2 id="4-lga">4. LGA</h2>

<p>â†’ ì˜ìƒ ë‚´ì˜ ì–‡ì€ êµ¬ì¡°ë¬¼ê³¼ ê°ì²´ì˜ ê°€ì¥ìë¦¬(ì—£ì§€)ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•¨.</p>

<hr />

<h2 id="5-architecture">5. Architecture</h2>

<ul>
  <li>3ê°œì˜ SGA ë ˆì´ì–´ì™€ 1ê°œì˜ LGA ë ˆì´ì–´ í™•ì¸ ê°€ëŠ¥.</li>
</ul>

<p><img src="https://velog.velcdn.com/images/bolero2/post/931c43c5-e1c5-43e5-86bc-b05eab33e412/image.png" alt="" /></p>

<hr />

<h2 id="6-experiment">6. Experiment</h2>

<ul>
  <li>ì‹¤í—˜ ëŒ€ìƒ ë°ì´í„°ì…‹ì€ <strong>Scene Flow Dataset</strong>ê³¼ <strong>KITTI Benchmarks</strong> ë¥¼ ì‚¬ìš©í•¨.</li>
</ul>

<p><img src="https://velog.velcdn.com/images/bolero2/post/bcfc97e0-f362-4d42-b902-62bd0950dc4d/image.png" alt="" /></p>

<hr />

<h2 id="7-sgm-vs-3d-convolution">7. SGM vs 3D Convolution</h2>

<ul>
  <li>ë¹¨ê°„ ì„ ì€ Ground Truthì™€ ë§¤ì¹­ ì§€ì .</li>
</ul>

<p><img src="https://velog.velcdn.com/images/bolero2/post/d8ecd03f-8285-4c01-a240-52ad0c8cb910/image.png" alt="" /></p>

<ul>
  <li><strong>ê²°ë¡  : SGA + LGA ë°©ì‹ì´ noiseë¥¼ ì˜ ì¡ìŒ.</strong>
(<em>â€œThe SGA layers successfully suppress these noiseâ€</em>)</li>
</ul>

<hr />

<h2 id="8-traditional-sga-vs-ga-nets-sga">8. Traditional SGA vs GA-Netâ€™s SGA</h2>

<p><img src="https://velog.velcdn.com/images/bolero2/post/95f13d3b-3a6d-47f8-8f59-e4cab925ffe4/image.png" alt="" /></p>

<hr />

<p><strong>(Paper ReviewëŠ” ì œê°€ ìŠ¤ìŠ¤ë¡œ ì½ê³  ì‘ì„±í•œ ê¸€ì´ë¯€ë¡œ, ì£¼ê´€ì ì¸ ë‚´ìš©ì„ì„ ë°í™ë‹ˆë‹¤.)</strong></p>]]></content><author><name>bolero2</name></author><category term="Paper" /><summary type="html"><![CDATA[Semantic Segmentationì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¼ë²¨ë§ ë°ì´í„°ì— ëŒ€í•´ ì•Œì•„ë³´ê³ , ì–´ë–»ê²Œ ì œì‘í•  ìˆ˜ ìˆëŠ”ì§€ ì•Œì•„ë´…ë‹ˆë‹¤.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-ganet.png" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-ganet.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[Paper] Better plain ViT baselines for ImageNet-1k</title><link href="http://localhost:4000/paper/2022/05/03/Paper-Better-plain-ViT-baselines-for-ImageNet-1k/" rel="alternate" type="text/html" title="[Paper] Better plain ViT baselines for ImageNet-1k" /><published>2022-05-03T00:00:00+09:00</published><updated>2022-05-03T00:00:00+09:00</updated><id>http://localhost:4000/paper/2022/05/03/Paper-Better-plain-ViT-baselines-for-ImageNet-1k</id><content type="html" xml:base="http://localhost:4000/paper/2022/05/03/Paper-Better-plain-ViT-baselines-for-ImageNet-1k/"><![CDATA[<p><span class="tag  is-primary ">
    Paper
</span>
<span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    Transformer
</span>
<span class="tag  is-primary ">
    ImageClassification
</span></p>

<h1 id="better--plain-vit-baselines-for-imagenet-1k">Better  plain ViT baselines for ImageNet-1k</h1>

<p>ì´ë²ˆì— ì†Œê°œí•  ë…¼ë¬¸ì€ 5ì›” 3ì¼ <a href="https://paperswithcode.com">Paperswithcode</a>ì— ê²Œì¬ëœ
<strong>â€œ<em>Better plain ViT baselines for ImageNet-1k</em>â€œ</strong> ë¼ëŠ” ë…¼ë¬¸ì…ë‹ˆë‹¤.
(ë…¼ë¬¸ ë§í¬ : https://arxiv.org/pdf/2205.01580.pdf)</p>

<p>ë…¼ë¬¸ ìì²´ê°€ 3ì¥ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, ì½ê¸° í¸í•  ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë…¼ë¬¸ ì œëª©ì— ë‚˜ì™€ìˆëŠ” ViT ëª¨ë¸ì€ <strong>Image Classification</strong> taskì—ì„œ ì‚¬ìš©ë˜ëŠ” ëª¨ë¸ë¡œì¨, NLP(Natural Language processing)ì—ì„œ ì‚¬ìš©ë˜ëŠ” Transformer ëª¨ë“ˆì„ Image taskì— ì ìš©í•œ ì•„ì£¼ ìœ ëª…í•œ ëª¨ë¸ì…ë‹ˆë‹¤.</p>

<p>(ViT ì´ì „ì—ëŠ” Convolution ì—°ì‚°ì´ Image Taskì˜ ë…ë³´ì ì¸ ìˆ˜ë‹¨ì´ì—ˆì§€ë§Œ, ViT ì´í›„ë¡œ Classification ë¿ë§Œ ì•„ë‹ˆë¼ Object Detection(ex. DETR), Video Recognition ë“±ì—ì„œë„ Transformer ëª¨ë“ˆì´ í™œìš©ë  ì •ë„ë¡œ ViTê°€ ê·¸ íŒë„ë¥¼ ë°”ê¿”ë†“ì•˜ìŠµë‹ˆë‹¤.)</p>

<p>ê¸°íšŒê°€ ë˜ë©´ ViT ìì²´ ë…¼ë¬¸ê³¼ Attention(name: Attention is all you need) ë…¼ë¬¸, BERT ë…¼ë¬¸ì— ëŒ€í•´ì„œë„ ë‹¤ë¤„ë³¼ ì˜ˆì •ì…ë‹ˆë‹¤.</p>

<ul>
  <li><strong>ViT paper</strong> : <a href="https://arxiv.org/pdf/2010.11929.pdf">An Image Is Worth 16x16 Words: Transformers For Image Recognition At Scale</a></li>
  <li><strong>Attention paper</strong> : <a href="https://arxiv.org/pdf/1706.03762.pdf">Attention Is All You Need</a></li>
  <li><strong>BERT paper</strong> : <a href="https://arxiv.org/pdf/1810.04805.pdf">BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding</a></li>
</ul>

<p>(ë³¸ ë¸”ë¡œê·¸ì— ìˆëŠ” <strong>DETR</strong> ìš”ì•½ í¬ìŠ¤íŠ¸ : <a href="https://velog.io/@bolero2/Paper-DETR-End-to-End-Object-Detection-with-Transformer">DETR - End-to-End Object Detection with Transformer</a>)</p>

<hr />

<h2 id="0-abstract">0. Abstract</h2>

<p>ViTëŠ” Vision Transformerì˜ ì•½ìì…ë‹ˆë‹¤. ViTì˜ ë°œí‘œ ì´í›„ë¡œ Image Classification ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ì–‘í•œ Image ë¶„ì•¼ì—ì„œ Transformer ëª¨ë“ˆì„ ì ê·¹ ê¸°ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<p>ViTëŠ” Image Classification ëª¨ë¸ë¡œì¨, ë¶„ë¥˜ ë¼ë²¨ì„ 1000ê°œë‚˜ ê°€ì§€ê³  ìˆëŠ” ImageNet ê²½ì§„ëŒ€íšŒ (ILSVRC, ImageNet Large Scale Visual Recognition Challenge)ì—ì„œ ë§¤ìš° ìš°ìˆ˜í•œ ì„±ëŠ¥ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.</p>

<p>Vision Transformer ê¸°ìˆ ì„ ImageNet-1k ê²½ì§„ëŒ€íšŒì—ì„œ ì˜ ì“°ê¸° ìœ„í•´ì„œëŠ” _<strong>â€œsophisticated regularizationâ€</strong>_ì´ ìˆì–´ì•¼ í•˜ëŠ”ë°, ì‚¬ì‹¤ ì´ëŸ¬í•œ ê²ƒë“¤ ë§ê³  ì¼ë°˜ì ì¸ ë°ì´í„° ì¦ëŒ€ ê¸°ë²•(standard data augmentation)ë§Œìœ¼ë¡œë„ ë†€ë¼ìš´ ì„±ëŠ¥ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë³¸ ë…¼ë¬¸ì—ì„œëŠ” ì¼ë°˜ì ì¸ ViT ëª¨ë¸ì—ì„œ ëª‡ ê°œì˜ ìˆ˜ì •ì„ í†µí•´ ì„±ëŠ¥ì„ dramatical í•˜ê²Œ ì˜¬ë ¸ìŠµë‹ˆë‹¤.</p>

<p>íŠ¹íˆ, 90epochs ë§Œìœ¼ë¡œ top-1 accuracyê°€ 76%ë¥¼ ë„˜ì—ˆê³ , 300 epochs ê¹Œì§€ ê°€ëŠ”ë° í•˜ë£¨ë„ ê±¸ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="1-introduction">1. Introduction</h2>

<p>ImageNet ê²½ì§„ëŒ€íšŒì˜ ë°ì´í„°ì…‹ <strong><a href="https://image-net.org/index.php">ImageNet ë°ì´í„°ì…‹</a></strong>ì€ Image Classification ëª¨ë¸ì˜ ì§€í‘œ, ë­í‚¹ì„ ë§¤ê¸°ëŠ”ë° êµ‰ì¥íˆ ì¤‘ìš”í•œ ì§€í‘œì…ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ Classification ëª¨ë¸ì´ ImageNet ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•˜ì—¬ ë²¤ì¹˜ë§ˆí¬ ì ìˆ˜ë¥¼ ë§¤ê¸°ê³ , ë­í‚¹ì„ ë§¤ê¸°ê²Œ ë©ë‹ˆë‹¤.</p>

<p>ViT ëª¨ë¸ì— ëŒ€í•œ ë…¼ë¬¸ì€ ImageNetê³¼ ê°™ì´ large-scaleì˜ Datasetì„ ëŒ€ìƒìœ¼ë¡œ í•˜ì—¬, ì˜ tuningëœ ResNetë³´ë‹¤ ìš°ì›”í•¨ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ImageNet Datasetì€ Classification ë¶„ì•¼ì˜ testbed(ì‹¤í—˜ì˜ ê¸°ì¤€ì ) ì—­í• ì„ í•˜ë©°, ì´ ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ì€ ì—¬ëŸ¬ ìˆ˜ì •ì‚¬í•­ ì—†ì´ ê°„ë‹¨í•œ baselineì˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒ(ì½”ë“œ ìì²´ë¥¼ ë³´ìœ í•œë‹¤ëŠ” ì˜ë¯¸?)ì´ ê½¤ë‚˜ ë†’ì€ ì´ì ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë³¸ ë…¼ë¬¸ì€ <strong>introduction</strong> ë‹¨ë½ì—ì„œ <em><code class="language-plaintext highlighter-rouge">big_vision</code></em> ì´ë¼ëŠ” ê²ƒì„ ì†Œê°œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ <em><code class="language-plaintext highlighter-rouge">big_vision</code></em> ì€ ViTë¥¼ í¬í•¨í•˜ì—¬ MLP-Mixer, LiT ë“± vision transformer ëª¨ë¸ì„ baseline ì ìœ¼ë¡œ ê°€ì§€ê³  ìˆìœ¼ë©°, ë…¼ë¬¸ ìì²´ì ìœ¼ë¡œ baselineì˜ ëª¨ë¸ë¡œ ë†’ì€ ì„±ëŠ¥ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆì—ˆëŠ”ì§€ ê¸°ìˆ í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p><em><strong>ìš”ì•½í•˜ìë©´, â€œImageNet Datasetì„ íƒ€ê²Ÿìœ¼ë¡œ í•˜ì—¬ ViTì˜ baseline ëª¨ë¸ì— ì¶©ì‹¤í•˜ê²Œ ì‹¤í—˜ì„ ì§„í–‰í–ˆë‹¤.â€ë¼ê³  ë§í•˜ê³  ì‹¶ì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤. (ì´ê²ƒì€ big_visionì— ì½”ë“œê°€ íƒ‘ì¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.)</strong></em></p>

<p><em><strong>ì• ì´ˆì— ë’·ë¶€ë¶„ì„ ë³´ê²Œ ë˜ë©´ ëª¨ë¸ ì•„í‚¤í…ì³ì˜ ë³€í˜•ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šìœ¼ë©°, batch_size ë³€ê²½ê³¼ ê°™ì€ ì•„ì£¼ ì¼ë°˜ì ì´ê³  ì‚¬ì†Œí•œ ë¶€ë¶„ì„ ë³€í˜•í–ˆìŠµë‹ˆë‹¤.</strong></em></p>

<p>ë‹¨ìˆœí•¨ì„ ì¶”êµ¬í•˜ëŠ” ë…¼ë¬¸ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆê² ë„¤ìš”.</p>

<hr />

<h2 id="2-experimental-setup">2. Experimental setup</h2>

<p>ì‹¤í—˜(í›ˆë ¨ ë° í‰ê°€)ì€ ì „ë¶€ ImageNet ë°ì´í„°ì…‹ì„ íƒ€ê²Ÿìœ¼ë¡œ ì‚¼ì•˜ìŠµë‹ˆë‹¤.
ì‹¤í—˜ì— ëŒ€í•œ ëª¨ë¸ì€ <code class="language-plaintext highlighter-rouge">ViT-S/16</code> ëª¨ë¸ë¡œ ì„ ì •í•˜ì˜€ê³ , ë§Œì•½ ì»´í“¨íŒ… ìì›ì´ ë§ì´ ë‚¨ëŠ” ê²½ìš°ì—” <code class="language-plaintext highlighter-rouge">ViT-B/16</code>ì´ë‚˜ <code class="language-plaintext highlighter-rouge">ViT-B/32</code>ë¥¼ ì¨ë„ ëœë‹¤ê³  í•©ë‹ˆë‹¤.</p>

<p>Transformer ëª¨ë“ˆ ì‚¬ìš©ì‹œ ì´ë¯¸ì§€ë¥¼ n í¬ê¸°ì˜ â€œpatchâ€ë¡œ ë‚˜ëˆ„ëŠ” ë¶€ë¶„ì´ ìˆëŠ”ë°, ì´ patchë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì€ Imageì˜ í•´ìƒë„(resolution)ë¥¼ ì¤„ì´ëŠ” ê²ƒê³¼ ë™ì¼í•©ë‹ˆë‹¤.
(ViT-B/16ì˜ ê²½ìš° patch í¬ê¸°ê°€ 16ì´ ë˜ê³ , ViT-B/32ì˜ ê²½ìš° patch í¬ê¸°ê°€ 32ê°€ ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì´ìœ  ë•Œë¬¸ì— patch í¬ê¸°ë¥¼ ì–¸ê¸‰í•œ ê²ƒ ê°™ë„¤ìš”.)</p>

<p>ì‹¤í—˜ì€ <a href="https://arxiv.org/pdf/1409.4842.pdf">Inception Crop</a>, random horizontal flip, random Augmentation ê·¸ë¦¬ê³  Mixup Augmentationì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="3-results">3. Results</h2>

<p><img src="https://velog.velcdn.com/images/bolero2/post/a8de228b-d957-4fc7-8547-fdb7fb0cc6da/image.png" alt="" /></p>

<p>Experimental setup íŒŒíŠ¸ì˜ setupì„ í†µí•´ í•™ìŠµí•œ ê²°ê³¼,</p>

<p><strong>80%ì˜ ì„±ëŠ¥ì´ ë‚˜ì˜¤ëŠ” Epoch 300ê¹Œì§€ 21ì‹œê°„ 40ë¶„ë°–ì— ê±¸ë¦¬ì§€ ì•Šì•˜ê³ 
ì„±ëŠ¥ ë˜í•œ original <code class="language-plaintext highlighter-rouge">ViT</code>ë³´ë‹¤ 2% ì •ë„ ë” ë†’ìŠµë‹ˆë‹¤.</strong></p>

<p><code class="language-plaintext highlighter-rouge">ResNet</code> originalì„ 90 epoch ë™ì•ˆ í•™ìŠµì‹œí‚¤ê³ , improved ViT ì—­ì‹œ 90 epoch ë™ì•ˆ í•™ìŠµì‹œì¼°ì„ ë•ŒëŠ” ì„±ëŠ¥ì´ 1-2% ë‚´ì™¸ë¡œ ResNetë³´ë‹¤ ë” ë†’ìŠµë‹ˆë‹¤.</p>

<p>ê¸°ì¡´ì˜ ViT original ë…¼ë¬¸ê³¼ í•™ìŠµ ë¶€ë¶„ì—ì„œ ì°¨ì´ì ì„ ë‘” ê²ƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<blockquote>
  <ol>
    <li>batch_sizeë¥¼ 4096ì—ì„œ 1024ë¡œ ë‚®ì¶¤.</li>
    <li>class token ëŒ€ì‹  GAP(Global Average Pooling) ì‚¬ìš©.</li>
    <li>ì ì€ ìˆ˜ì¤€ì˜ Random Augmentationê³¼ Mixup ì‚¬ìš©.</li>
    <li>Position Embeddingì€ fixed 2D sin-cos ì‚¬ìš©.</li>
  </ol>
</blockquote>

<p><em><strong>ì´ë ‡ê²Œ ViT ëª¨ë¸ì—ì„œ ìœ„ì™€ ê°™ì€ ë‹¨ìˆœí•œ ë³€ê²½ì„ í†µí•´, ìµœì¢… 300 Epochì—ì„œ original <code class="language-plaintext highlighter-rouge">ViT-B/32</code> ëª¨ë¸ ë³´ë‹¤ ì•½ 6% ì •ë„ ì„±ëŠ¥ ì¦ê°€ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.</strong></em></p>

<p><img src="https://velog.velcdn.com/images/bolero2/post/af5f0056-0088-4af9-8594-50df11402069/image.png" alt="" /></p>

<p>ì´ í‘œë¥¼ ë³´ê²Œ ë˜ë©´, original ë³´ë‹¤ ì„±ëŠ¥ì´ ì˜¬ë¼ê°„ ê²ƒì€ í™•ì‹¤í•œ ì‚¬ì‹¤ì…ë‹ˆë‹¤.
ì´ í‘œì—ì„œ ì£¼ëª©í•´ì•¼ í•  ë¶€ë¶„ì€, <strong>ìœ„ì—ì„œ ì–¸ê¸‰í•œ 4ê°€ì§€ ë³€ê²½ì ì„ í•˜ë‚˜ì”© ì œê±°í•´ ë³´ì•˜ì„ ë•Œì˜ ì„±ëŠ¥ ê²°ê³¼ì…ë‹ˆë‹¤.</strong></p>

<p>ê°€ì¥ ë³€ê²½ì ì´ ì ì€ ë¶€ë¶„ì€ ëª¨ë¸ì˜ Head ë¶€ë¶„ì„ MLPì—ì„œ linearë¡œ ë³€ê²½í•˜ì˜€ì„ ë•Œê°€ ê°€ì¥ ì„±ëŠ¥ ë³€í™”ê°€ ì—†ì—ˆìŠµë‹ˆë‹¤. ê·¸ ì™¸ì˜ ë³€ê²½ì ì€ 1-2% ë‚´ì™¸ë¡œ ì„±ëŠ¥ í•˜ë½ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</p>

<p>ìš”ì•½í•´ë³´ìë©´, <strong>â€œì´ë ‡ê²Œ ë‹¨ìˆœí•œ baseline ëª¨ë¸ì—ì„œ ë‹¨ìˆœí•œ ë³€ê²½ ì‚¬í•­ë“¤(batch_size ë³€ê²½, GAP ì¶”ê°€, augmentation ê¸°ë²• ì¶”ê°€ ë“±)ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ë“œë¼ë§ˆí‹±í•œ ì„±ëŠ¥ í–¥ìƒì„ ì´ë£¨ì–´ë‚¼ ìˆ˜ ìˆë‹¤â€</strong> ê°€ í•µì‹¬ì´ë¼ê³  ë³¼ ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤.</p>

<p>SAM(Sharpness Aware Minimization) ê¸°ë²•, CutMix, blurring, ê³ í•´ìƒë„ì—ì„œì˜ íŒŒì¸ íŠœë‹, ë“œë¡­ì•„ì›ƒ, ëª¨ë¸ êµ¬ì¡° ë³€ê²½, stochastic depthì™€ ê°™ì€ ê³ ê¸‰ ê¸°ìˆ (?)ë“¤ì€ í•˜ë‚˜ë„ ì ìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="5-conclusion">5. Conclusion</h2>

<p>í•­ìƒ ë‹¨ìˆœí•œ ê²ƒì„ ì¶”êµ¬í•˜ëŠ” ê²ƒì€ ê°€ì¹˜ìˆë‹¤ê³  í•˜ë„¤ìš”.</p>

<blockquote>
  <p>â€œIt is always worth striving for simplicity.â€</p>
</blockquote>

<hr />

<p><strong>(Paper ReviewëŠ” ì œê°€ ìŠ¤ìŠ¤ë¡œ ì½ê³  ì‘ì„±í•œ ê¸€ì´ë¯€ë¡œ, ì£¼ê´€ì ì¸ ë‚´ìš©ì„ì„ ë°í™ë‹ˆë‹¤.)</strong></p>]]></content><author><name>bolero2</name></author><category term="Paper" /><summary type="html"><![CDATA[original ViTë¡œë¶€í„° ì„±ëŠ¥ì„ 10%ë‚˜ ì¦ê°€ì‹œí‚¨ ë°©ë²•]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-Better_plain_ViT_baselines_for_ImageNet-1k.png" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-Better_plain_ViT_baselines_for_ImageNet-1k.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[Android/Java] HttpURLConnectionìœ¼ë¡œ HTTP POST requestí•˜ê¸°</title><link href="http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/" rel="alternate" type="text/html" title="[Android/Java] HttpURLConnectionìœ¼ë¡œ HTTP POST requestí•˜ê¸°" /><published>2022-04-06T00:00:00+09:00</published><updated>2022-04-06T00:00:00+09:00</updated><id>http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request</id><content type="html" xml:base="http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/"><![CDATA[<p><span class="tag  is-primary ">
    Android
</span>
<span class="tag  is-primary ">
    Java
</span></p>

<h2 id="0-intro">0. Intro</h2>

<p>í•„ì íšŒì‚¬ì˜ ì¶”ë¡  ì„œë²„(Inference Server)ë¡œ ì´ë¯¸ì§€ë¥¼ <strong>POST</strong> ìš”ì²­í•´ì„œ ì‘ë‹µì„ ë°›ì•„ì˜¤ëŠ”
Android Applicationì„ ì œì‘í•˜ê²Œ ë˜ì—ˆë‹¤.</p>

<p>ë‚˜ëŠ” Android ê°œë°œì´ë€ ê±¸ ë‹¨ í•œë²ˆë„ í•´ë³¸ ì ì´ ì—†ì—ˆê³ ,
Java ë³´ë‹¤ëŠ” C++ì™€ Pythonì„ ì£¼ë¡œ ì¼ì—ˆë‹¤.</p>

<p>ê·¸ë˜ì„œ ê·¸ëŸ°ì§€ êµ‰ì¥íˆ ë§ì€ ì‚½ì§ˆì„ í•˜ë©° ì¥ì¥ 1ì£¼ì¼ì— ê±¸ì³ì„œ ê°œë°œì„ ì™„ë£Œí–ˆëŠ”ë°,
ë‚˜ì—ê²ŒëŠ” ë„ˆë¬´ ì–´ë µê³  ì¤‘ìš”í–ˆë˜ ì •ë³´ì˜€ê¸°ì— ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…ì„ í•˜ê²Œ ë˜ì—ˆë‹¤.</p>

<hr />

<h2 id="1-before-development">1. Before Development</h2>

<p>ìš°ì„ , ì–´ë– í•œ ì„œë²„ê°€ ìˆê³  ê±°ê¸°ì— AccessKeyì™€ Imageë¥¼ ë³´ë‚´ì•¼ í•œë‹¤.
ê°„ë‹¨í•˜ê²Œ Postman ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p><img src="https://velog.velcdn.com/cloudflare/bolero2/2d07c10a-cfd3-49b2-a8ea-251bfe794aa1/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202022-04-06%2006.04.20.png" alt="" /></p>

<p>ì´ë ‡ê²Œ POST methodë¡œ https://staging.server.com/api/inference/target ìœ„ì¹˜ë¡œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accessKey</span> <span class="o">=</span> <span class="s">"abcd12345"</span>
<span class="n">files</span> <span class="o">=</span> <span class="s">"bird.jpg"</span>
</code></pre></div></div>
<p>í˜•ì‹ì„ ë³´ë‚´ë©´ ì•„ë˜ì™€ ê°™ì´ ì‘ë‹µì´ ì˜¨ë‹¤.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"fileName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì–´ì©Œêµ¬_ì €ì©Œêµ¬_íŒŒì¼ì´ë¦„1.jpg"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"width"</span><span class="p">:</span><span class="w"> </span><span class="mi">2560</span><span class="p">,</span><span class="w">
            </span><span class="nl">"height"</span><span class="p">:</span><span class="w"> </span><span class="mi">1696</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"softmax"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9987636804580688</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="nl">"softmax"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0012363195419311523</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>ê°œë°œ ì „ì—, ì•Œì•„ì•¼ í•  ì •ë³´ëŠ”</p>
<blockquote>
  <ol>
    <li>ì–´ë–¤ Key ê°’ì„ ë³´ë‚´ì•¼ í•˜ëŠ”ê°€?</li>
    <li>ê°ê°ì˜ Keyì— ë§¤í•‘ë˜ëŠ” Value íƒ€ì…. (String? Image? Bitmap? ë“±)</li>
    <li>(ë‹¹ì—°í•˜ì§€ë§Œ) POST ìš”ì²­ì„ ë³´ë‚¼ ì„œë²„ ì£¼ì†Œ</li>
    <li>í—¤ë” ì •ë³´</li>
  </ol>
</blockquote>

<p>ë“±ì´ ìˆë‹¤.</p>

<p>í—¤ë” ì •ë³´ëŠ” Request ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ì–´ê¸‹ë‚˜ê²Œ ë˜ë©´
<strong>1. ìš”ì²­ì´ ì˜ëª» ê°€ê±°ë‚˜</strong> í˜¹ì€ <strong>2. ì‘ë‹µì´ ì´ìƒí•˜ê²Œ ì˜¬ ìˆ˜ ìˆê¸°</strong> ë•Œë¬¸ì— ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•œë‹¤.</p>

<p>ê·¸ëŸ¼ í—¤ë” ì •ë³´ëŠ” ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆì„ê¹Œ?</p>

<hr />

<h2 id="2-checking-header-information">2. Checking header information</h2>

<p>ì‚¬ì‹¤ ì½”ë“œ ì‘ì„±ë³´ë‹¤ í—¤ë” í™•ì¸ì´ë¼ëŠ” ë¶€ë¶„ì´ ì—„ì²­ í˜ë“¤ì—ˆë‹¤.
ë‚˜ëŠ” ë„¤íŠ¸ì›Œí¬ë‚˜ ì„œë²„ ê°œë°œì„ í•´ ë³¸ ì ì´ ì—†ì–´ì„œ, í—¤ë”ì˜ ì¤‘ìš”ì„±ì„ ëª°ëëŠ”ë° ì´ë²ˆ ê¸°íšŒì— ë¼ˆì €ë¦¬ê²Œ ëŠê¼ˆë‹¤.</p>

<p>Swagger ë¼ë“ ì§€, DevTools(ê°œë°œì ë„êµ¬, ìš”ì†Œ ì ê²€) ë¼ë“ ì§€, ì–´ë– í•œ ë°©ì‹ìœ¼ë¡œë“  ì›¹í˜ì´ì§€ì—ì„œ í—¤ë” ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
í•„ìëŠ” ê°œë°œì ë„êµ¬ë¥¼ ì‚¬ìš©í•´ì„œ ì›¹í˜ì´ì§€ì—ì„œ ì§ì ‘ í—¤ë”ë¥¼ í™•ì¸í•˜ì˜€ë‹¤.</p>

<p><img src="https://velog.velcdn.com/cloudflare/bolero2/bd9a5013-08e5-4cf4-bb94-54a8d05c391e/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202022-04-06%2006.18.57.png" alt="íšŒì‚¬ ì œí’ˆ.jpg" /></p>

<p><strong>ì´ë ‡ê²Œ ê°œë°œì ë„êµ¬ë¥¼ ì—´ê³ , ë„¤íŠ¸ì›Œí¬ íƒ­ - XHR/Fetch í•­ëª©ìœ¼ë¡œ ë“¤ì–´ê°€ë©´ [ìš”ì²­, ì‘ë‹µ, ìš”ì²­ ë°ì´í„°] ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</strong>
ê·¸ë¦¬ê³  ì €ê¸°ì˜ Content-Type, Accept-Language ë“±ì´ ìš°ë¦¬ê°€ Connectionì„ í•  ë•Œ ì„¤ì •í•´ì•¼ í•  í—¤ë” ë° Key ì •ë³´ë“¤ì´ë‹¤.</p>

<p>ì•„ë˜ë¡œ ë” ë‚´ë¦¬ë©´ ìš”ì²­ ë°ì´í„° í•­ëª©ì´ ìˆë‹¤.
<img src="https://velog.velcdn.com/cloudflare/bolero2/1b1a7fd0-d4ee-4fe7-9e5d-fb74af163c35/image.png" alt="" /></p>

<p>ìœ í˜•ì€ <code class="language-plaintext highlighter-rouge">multipart/form-data</code> ì´ê³ , boundaryëŠ” <code class="language-plaintext highlighter-rouge">----WebKitFormBoundaryAYuewg7muT6zRKkc</code> ì´ë‹¤.</p>

<p>ë‚˜ëŠ” boundaryê°€ ë­”ì§€ ì—„ì²­ í—·ê°ˆë ¸ëŠ”ë°, ì‰½ê²Œ ìƒê°í•´ì„œ â€œêµ¬ë¶„ìâ€ ë¼ê³  ë³´ë©´ ëœë‹¤.</p>

<p>POSTë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ë©´, key-value pairê°€ 1ê°œë“  10ê°œë“  í•˜ë‚˜ì˜ String íƒ€ì…ìœ¼ë¡œ ë³´ë‚¸ë‹¤.
ê·¸ëŸ¬ë©´ ê° key-value pairë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆì–´ì•¼ í•˜ëŠ”ë°, boundaryê°€ ê·¸ ì—­í• ì„ í•˜ê²Œ ëœë‹¤.</p>

<p>ê°œë°œì ë„êµ¬ì—ì„œ ìš”ì²­ ë°ì´í„°ë¥¼ ì§ì ‘ ë³¼ ìˆ˜ ìˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundaryAYuewg7muT6zRKkc
Content-Disposition: form-data; name="files"; filename="bird.jpg"
Content-Type: image/jpeg


------WebKitFormBoundaryAYuewg7muT6zRKkc--

</code></pre></div></div>
<p>ì´ë ‡ê²Œ, <strong>two-hypens</strong>(â€œâ€“â€œ)ê³¼ <strong>ì¤„ë°”ê¿ˆ</strong>(=crlf, Javaì—ì„œëŠ” â€œ\r\nâ€ì„ ì“´ë‹¤.), <strong>boundary</strong>ì˜ ì¡°í•©ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p>1ê°œì˜ ë°ì´í„°ê°€ ì•„ë‹ˆë¼ ì—¬ëŸ¬ ê°œì˜ image dataë¥¼ ë³´ëƒˆì„ ë•Œì˜ ìš”ì²­ ë°ì´í„°ëŠ” ì–´ë–¨ê¹Œ?</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="bird1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="cat1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="deer1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="dog1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy--

</code></pre></div></div>
<p>ì´ë ‡ê²Œ ë‚˜íƒ€ë‚œë‹¤. <strong>ìš°ë¦¬ê°€ Android ê°œë°œ ì‹œì— POST ë°ì´í„°ë¥¼ ë³´ë‚´ì¤„ ë•Œ, ì´ëŸ¬í•œ í˜•ì‹ì„ ë§ì¶°ì•¼ í•œë‹¤.</strong></p>

<p>(ë³´í†µ boundaryëŠ” ì›¹ í˜ì´ì§€ì—ì„œ ì•Œì•„ì„œ ë³´ë‚´ì¤€ë‹¤ê³  í•œë‹¤.
ê°œë°œìê°€ ì„ì˜ë¡œ ì‘ì„±í•´ë„ ëœë‹¤ê³  í•˜ì§€ë§Œ, í•„ìëŠ” ì›¹í˜ì´ì§€ì˜ í˜•ì‹ì„ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° í•˜ì˜€ë‹¤.)</p>

<hr />

<h2 id="3-development">3. Development</h2>

<p>ì´ì œ ì‹¤ì œ ì½”ë“œë¶€ë¶„ì„ ì‘ì„±í•´ë³´ì.</p>

<h3 id="3-1-pre-setting">3-1. pre-setting</h3>
<p>ì‘ë™ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:</p>

<ol>
  <li>Load Image ë²„íŠ¼ìœ¼ë¡œ ImageViewì— ì´ë¯¸ì§€ë¥¼ ë„ìš°ê³ </li>
  <li>Send To Server ë²„íŠ¼ìœ¼ë¡œ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•œë‹¤.</li>
</ol>

<p>í™”ë©´ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:
<img src="https://velog.velcdn.com/cloudflare/bolero2/03bd1748-a0df-43a5-907c-393a27385be9/flow1.jpg" alt="" /></p>

<p>ë²„íŠ¼ ë° String, ImageView, TextView ê´€ë ¨í•´ì„œëŠ” ì´í›„ì— í¬ìŠ¤íŒ…ì„ í•˜ê³ ,
ì§€ê¸ˆì€ Http Requestê°€ ëª©ì ì´ë¯€ë¡œ ìƒëµí•œë‹¤.</p>

<p>ìš°ì„ , STORAGE ë° Network permissionì„ ì ì–´ì¤˜ì•¼ í•œë‹¤.
<code class="language-plaintext highlighter-rouge">app/manifests/AndroidManifest.xml</code> ìœ„ì¹˜ì— ì ëŠ”ë‹¤.</p>

<ul>
  <li><strong>AndroidManifest.xml</strong>
```xml</li>
</ul>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.example.demoandroidapp">
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.INTERNET" />
</manifest>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì™¸ë¶€ ClassëŠ” ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì—†ê¸° ë•Œë¬¸ì—, `build.gradle` ì—ëŠ” ìˆ˜ì •í•  ê²ƒì´ ì—†ë‹¤.

### 3-2. MainActivity

ê°„ë‹¨í•˜ê²Œ MainActivityì˜ OnCreate ë° OnCreate í•˜ìœ„ buttonLoadImage.setOnClickListener í•¨ìˆ˜ ì½”ë“œë§Œ ë³´ì.

- **MainActivity.class**
```java
import androidx.appcompat.app.AppCompatActivity;
import android.annotation.SuppressLint;
import android.content.Intent;
import android.database.Cursor;
import android.os.AsyncTask;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.BitmapDrawable;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.view.View;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;
import java.io.ByteArrayOutputStream;
import org.json.JSONArray;
import org.json.JSONObject;

public class MainActivity extends AppCompatActivity {
    private static final int RESULT_LOAD_IMAGE = 1;
    private static String output = "";
    private TextView resultTextView = null;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // declaration button
        Button buttonLoadImage = (Button) findViewById(R.id.button);
        Button buttonSendToServer = (Button) findViewById(R.id.detect);
        resultTextView = findViewById(R.id.resultText);

        // permission
        requestPermissions(new String[]{android.Manifest.permission.READ_EXTERNAL_STORAGE}, 1);

        // Declaration TextView, ImageView, initialization resultTextView

        TextView NothingToShowTextView = findViewById(R.id.nothingToShowText);
        ImageView imageView = (ImageView) findViewById(R.id.image);
        resultTextView.setText("");

        buttonLoadImage.setOnClickListener(new View.OnClickListener() {

            @SuppressLint("SetTextI18n")
            @Override
            public void onClick(View arg0) {
                // reset TextView
                NothingToShowTextView.setText("");
                Intent i = new Intent(
                        Intent.ACTION_PICK,
                        MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
                startActivityForResult(i, RESULT_LOAD_IMAGE);
            }
        });
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  OnCreate ë‚´ë¶€ì— ì´ì–´ì„œ <code class="language-plaintext highlighter-rouge">buttonSendToServer.setOnClickListener</code> ë¥¼ ì‘ì„±í•œë‹¤.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buttonSendToServer</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>

    <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">"SetTextI18n"</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">arg0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Bitmap</span> <span class="n">original_bitmap</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">url_string</span> <span class="o">=</span> <span class="s">"https://staging.server.com/api/inference/target"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">accessKey_string</span> <span class="o">=</span> <span class="s">"abcd12345"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">resultTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Inference in progress..."</span><span class="o">);</span>

            <span class="c1">// Getting the image from the image view</span>
            <span class="c1">// [1] Read the image as Bitmap</span>
            <span class="n">original_bitmap</span> <span class="o">=</span> <span class="o">((</span><span class="nc">BitmapDrawable</span><span class="o">)</span> <span class="n">imageView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">()).</span><span class="na">getBitmap</span><span class="o">();</span>

            <span class="nc">ByteArrayOutputStream</span> <span class="n">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="n">original_bitmap</span><span class="o">.</span><span class="na">compress</span><span class="o">(</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">CompressFormat</span><span class="o">.</span><span class="na">JPEG</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="n">blob</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">imageBytes</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>

            <span class="c1">// [2] http connection</span>
            <span class="nc">NetworkTask</span> <span class="n">networkTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NetworkTask</span><span class="o">(</span><span class="n">url_string</span><span class="o">,</span>
                                                      <span class="n">accessKey_string</span><span class="o">,</span>
                                                      <span class="n">imageBytes</span><span class="o">,</span>
                                                      <span class="n">resultTextView</span><span class="o">);</span>
            <span class="n">networkTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failed to open image file."</span><span class="o">);</span>
            <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">imageView</span><span class="o">.</span><span class="na">setImageDrawable</span><span class="o">(</span><span class="k">new</span> <span class="nc">BitmapDrawable</span><span class="o">(</span><span class="n">getResources</span><span class="o">(),</span> <span class="n">original_bitmap</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">String url_string</code> ì—ëŠ” Postmanì—ì„œ ë´¤ë˜ <code class="language-plaintext highlighter-rouge">"https://staging.server.com/api/inference/target"</code> ì„ ì ê³ , 
<code class="language-plaintext highlighter-rouge">String accessKey_string</code> ì—ëŠ” <code class="language-plaintext highlighter-rouge">"abcd12345"</code> ë¥¼ ì ì–´ì¤€ë‹¤.</p>

<p>ì—¬ê¸°ì„œ í•µì‹¬ì€ 2ê°€ì§€ì´ë‹¤.</p>
<blockquote>
  <ol>
    <li>Bitmap íƒ€ì…ì˜ ì´ë¯¸ì§€ë¥¼ byte[] íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•œë‹¤.</li>
    <li>AsyncTask ë¥¼ ìƒì†ë°›ì€ NetworkTaskë¥¼ execute() í•œë‹¤.</li>
  </ol>
</blockquote>

<p>byte[] í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì€, <strong>ImageViewì—ì„œ ì´ë¯¸ì§€ë¥¼ ì½ì–´ì„œ(bitmap) &gt; toByteArray();ë¥¼ ì ìš©í•˜ëŠ” ê²ƒ</strong>ì´ë‹¤.</p>

<h3 id="3-3-networktask">3-3. NetworkTask</h3>

<p>NetworkTaskëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í–ˆë‹¤:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NetworkTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="cm">/**
     * AsyncTask start
     *
     * (single Worker Thread)
     * 1. onPreExecuted()
     * 2. doInBackground()
     *      - publishProgress() -&gt; onProgressUpdate()
     *      - publishProgress() -&gt; onProgressUpdate()
     *      - ...
     * 3. onPostExecuted()
     *
     */</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">url</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">accessKey</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">values</span><span class="o">;</span>
    <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">"StaticFieldLeak"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TextView</span> <span class="n">_resultView</span><span class="o">;</span>

    <span class="c1">// Constructor</span>
    <span class="kd">public</span> <span class="nf">NetworkTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">accessKey</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">values</span><span class="o">,</span> <span class="nc">TextView</span> <span class="n">resultView</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accessKey</span> <span class="o">=</span> <span class="n">accessKey</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">_resultView</span> <span class="o">=</span> <span class="n">resultView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">result</span><span class="o">;</span> <span class="c1">// ìš”ì²­ ê²°ê³¼ë¥¼ ì €ì¥í•  ë³€ìˆ˜.</span>
        <span class="nc">RequestHttpsURLConnection</span> <span class="n">requestHttpsURLConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RequestHttpsURLConnection</span><span class="o">();</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">requestHttpsURLConnection</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">accessKey</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[doInBackground] output : "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[doInBackground] output is null state."</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">"SetTextI18n"</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">outputs</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">image</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="kt">double</span> <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="no">F</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">labelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">JSONArray</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">JSONObject</span> <span class="n">tempJsonObject</span> <span class="o">=</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"image"</span><span class="o">);</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"outputs"</span><span class="o">);</span>

                    <span class="nc">JSONArray</span> <span class="n">jsonOutputsArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">outputs</span><span class="o">);</span>

                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="nc">JSONObject</span> <span class="n">tempOutputsJsonObject</span> <span class="o">=</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                        <span class="n">labelName</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"label"</span><span class="o">);</span>
                        <span class="kt">double</span> <span class="n">tempSoftmaxValue</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="s">"softmax"</span><span class="o">);</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">maxSoftmax</span> <span class="o">&lt;</span> <span class="n">tempSoftmaxValue</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="n">tempSoftmaxValue</span><span class="o">;</span>
                            <span class="k">switch</span> <span class="o">(</span><span class="n">labelName</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">case</span> <span class="s">"0"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"bird"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"1"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"cat"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"2"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"deer"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"3"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"dog"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"4"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"frog"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"5"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"horse"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>

                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[onPostExecute] output is null state."</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">_resultView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Result : ["</span> <span class="o">+</span> <span class="n">maxLabelName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>AsyncTaskëŠ” Http Connectionì„ ìœ„í•´ì„œ <strong>ë°˜ë“œì‹œ</strong> ìƒì†ë°›ì•„ì•¼ ëœë‹¤ê³  í•œë‹¤.
(Android ì‹¤í–‰ì˜ main threadì—ì„œ network connection ë™ì‘ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.)</p>

<p>AsyncTaskì˜ ë™ì‘ ë°©ì‹ì€</p>
<blockquote>
  <ol>
    <li>AsyncTask start</li>
    <li><strong>onPreExecuted()</strong></li>
    <li><strong>doInBackground()</strong>
      <ul>
        <li>publishProgress() -&gt; onProgressUpdate()</li>
        <li>publishProgress() -&gt; onProgressUpdate()</li>
        <li>â€¦</li>
      </ul>
    </li>
    <li><strong>onPostExecuted()</strong></li>
  </ol>
</blockquote>

<p>ìˆœì„œì´ë‹¤.</p>

<p>doInBackground() ì´í›„ì— onPostExecuted() í•¨ìˆ˜ê°€ ìˆ˜í–‰ë˜ëŠ”ë°,</p>

<p>doInBackground í•¨ìˆ˜ì˜ return typeì´ <strong>String</strong> ì´ë¯€ë¡œ,
onPostExecuted() í•¨ìˆ˜ì˜ ì…ë ¥ íŒŒë¼ë¯¸í„°ì˜ type ì—­ì‹œ <strong>String</strong> ì´ ëœë‹¤.</p>

<p>doInBackground ì—ì„œ ì‹¤ì œ POST requestë¥¼ ë‚ ë¦¬ê³ , onPostExecuted ì—ì„œ POST response Stringì— ëŒ€í•œ í›„ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§„ë‹¤. (í™”ë©´ì— ê²°ê³¼ê°’ ë„ì›Œì£¼ê¸° ë“±)</p>

<p>ì‹¤ì œ ë™ì‘ì€ <strong>doInBackground()</strong> í•¨ìˆ˜ ë‚´ë¶€ ì¤‘ê°„ì˜</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RequestHttpsURLConnection</span> <span class="n">requestHttpsURLConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RequestHttpsURLConnection</span><span class="o">();</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">requestHttpsURLConnection</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">accessKey</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span> <span class="c1">// í•´ë‹¹ URLë¡œ ë¶€í„° ê²°ê³¼ë¬¼ì„ ì–»ì–´ì˜¨ë‹¤.</span>
</code></pre></div></div>
<p>ë¶€ë¶„ì—ì„œ POST requestë¥¼ ë‚ ë¦¬ê²Œ ëœë‹¤.
ìƒì„±ì íŒŒë¼ë¯¸í„°ëŠ” ì—†ê³ , <code class="language-plaintext highlighter-rouge">request</code> í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„°ëŠ”:</p>
<blockquote>
  <ol>
    <li><strong>url</strong> : API Endpoint</li>
    <li><strong>accessKey</strong> : key[â€˜accessKeyâ€™]</li>
    <li><strong>values</strong> : key[â€˜filesâ€™] (byte[] type.)</li>
  </ol>
</blockquote>

<p>ì´ë ‡ê²Œ 3ê°œë¡œ ì„¤ì •í•˜ì˜€ë‹¤.</p>

<p>ê·¸ëŸ¬ë©´ ì´ì œ í•µì‹¬ ë¶€ë¶„ì¸ <code class="language-plaintext highlighter-rouge">RequestHttpsURLConnection</code> class ì½”ë“œë¥¼ ë³´ì.</p>

<h3 id="3-4-requesthttpsurlconnection">3-4. RequestHttpsURLConnection</h3>

<ul>
  <li><strong>RequestHttpsURLConnection.class ì „ì²´ ì½”ë“œ</strong>
```java
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.InputStream;
import java.io.BufferedInputStream;
import java.io.DataOutputStream;
import javax.net.ssl.HttpsURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;</li>
</ul>

<p>public class RequestHttpsURLConnection {
    String strResponse = null;
    public String request(String _url, String accessKey, byte[] imageBytes){</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // HttpURLConnection ì°¸ì¡° ë³€ìˆ˜.
    HttpsURLConnection urlConn = null;

    try{
        String crlf = "\r\n";     // carriage return + line feed
        String twoHyphens = "--";
        String boundary = "----WebKitFormBoundarynuXSuFo6d9f2xtbb";

        URL url = new URL(_url);
        urlConn = (HttpsURLConnection) url.openConnection();

        // [2-1]. urlConn ì„¤ì •.
        urlConn.setRequestMethod("POST"); // URL ìš”ì²­ì— ëŒ€í•œ ë©”ì†Œë“œ ì„¤ì • : POST.
        urlConn.setRequestProperty("USER-AGENT", "Mozilla/5.0");
        urlConn.setRequestProperty("ACCEPT-LANGUAGE", "en-us,en;0.5");
        urlConn.setDoInput(true);
        urlConn.setDoOutput(true);
        urlConn.setUseCaches(false);

        urlConn.setRequestProperty("Connection", "keep-alive");
        urlConn.setRequestProperty("User-Agent", "CodeJava Agent");
        urlConn.setRequestProperty("Content-Type", "multipart/form-data; boundary=" + boundary);

        // [2-2]. parameter ì „ë‹¬ ë° ë°ì´í„° ì½ì–´ì˜¤ê¸°.
        DataOutputStream request = new DataOutputStream(urlConn.getOutputStream());

        // Write key and values
        // 1. Access Key
        request.writeBytes(twoHyphens + boundary + crlf);
        request.writeBytes("Content-Disposition: form-data; name=\"accessKey\"" + crlf);
        request.writeBytes("Content-Type: application/json" + crlf);
        request.writeBytes(crlf);
        request.writeBytes(accessKey + crlf);

        // 2. Image data
        request.writeBytes(twoHyphens + boundary + crlf);
        request.writeBytes("Content-Disposition: form-data; name=\"files\"; filename=\"elephants1.png\"" + crlf);
        request.writeBytes("Content-Type: image/jpeg" + crlf);
        request.writeBytes(crlf);
        request.write(imageBytes);

        request.writeBytes(crlf);
        request.writeBytes(twoHyphens + boundary + twoHyphens + crlf);
        request.flush();
        request.close();

        int response_code = urlConn.getResponseCode();
        System.out.println("Connection response code : [" + response_code + "]");

        // [2-3]. ì—°ê²° ìš”ì²­ í™•ì¸.
        // ì‹¤íŒ¨ ì‹œ nullì„ ë¦¬í„´í•˜ê³  ë©”ì„œë“œë¥¼ ì¢…ë£Œ.
        if (response_code != HttpsURLConnection.HTTP_OK){
            return "Response Code : " + Integer.toString(response_code);	// response 200
        } else {
            InputStream responseStream = new BufferedInputStream(urlConn.getInputStream());
            BufferedReader responseStreamReader = new BufferedReader(new InputStreamReader(responseStream, StandardCharsets.UTF_8));

            String outputResponse = "";
            StringBuilder stringBuilder = new StringBuilder();

            while ((outputResponse = responseStreamReader.readLine()) != null) {
                stringBuilder.append(outputResponse).append("\n");
            }

            responseStreamReader.close();
            strResponse = stringBuilder.toString();

            return strResponse;
        }
    } catch (IOException e) {   // for URL.
        e.printStackTrace();
    }                           // for openConnection().
    finally {
        if (urlConn != null)
            urlConn.disconnect();
    }
    return null;
} } ```
</code></pre></div></div>

<p>ë‹¬ë‘ request í•¨ìˆ˜ í•˜ë‚˜ë§Œ êµ¬í˜„í•˜ì˜€ë‹¤. ì´ì œë¶€í„°ëŠ” ê° êµ¬ì„± ë³„ ì½”ë“œ ë¸”ëŸ­ì— ëŒ€í•œ ì„¤ëª…ê³¼ ì°¸ê³ ì‚¬í•­ë“¤ì´ë‹¤.</p>

<hr />

<p><em><strong>1. ìš°ë¦¬ê°€ ì•„ê¹Œ í—¤ë” ì •ë³´ ì°¾ê¸°ì—ì„œ ë´¤ì—ˆë˜ boundaryì™€, crlf(ì¤„ë°”ê¿ˆ), two-hypens ë³€ìˆ˜ë¥¼ í• ë‹¹í•œë‹¤.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">crlf</span> <span class="o">=</span> <span class="s">"\r\n"</span><span class="o">;</span>     <span class="c1">// carriage return + line feed</span>
<span class="nc">String</span> <span class="n">twoHyphens</span> <span class="o">=</span> <span class="s">"--"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">boundary</span> <span class="o">=</span> <span class="s">"----WebKitFormBoundarynuXSuFo6d9f2xtbb"</span><span class="o">;</span>
</code></pre></div></div>
<p>boundaryëŠ” ì„ì˜ë¡œ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤ê³  í•˜ì§€ë§Œ, ì›¹ì•Œëª»ì¸ í•„ìëŠ” ì˜ ëª°ë¼ì„œ browserì—ì„œ ë³´ì—¬ì¤€ ê²ƒì„ ì¼ë‹¤.</p>

<hr />

<p><em><strong>2. URL ê°ì²´ë¥¼ ë§Œë“¤ê³ , Connectionì„ í™œì„±í™”í•œë‹¤.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">_url</span><span class="o">);</span>
<span class="n">urlConn</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpsURLConnection</span><span class="o">)</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
</code></pre></div></div>

<hr />

<p><em><strong>3. í—¤ë” ì •ë³´ë¥¼ ì…ë ¥í•œë‹¤.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span> <span class="c1">// URL ìš”ì²­ì— ëŒ€í•œ ë©”ì†Œë“œ ì„¤ì • : POST.</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"USER-AGENT"</span><span class="o">,</span> <span class="s">"Mozilla/5.0"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"ACCEPT-LANGUAGE"</span><span class="o">,</span> <span class="s">"en-us,en;0.5"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setDoInput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setUseCaches</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"Connection"</span><span class="o">,</span> <span class="s">"keep-alive"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"User-Agent"</span><span class="o">,</span> <span class="s">"CodeJava Agent"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"multipart/form-data; boundary="</span> <span class="o">+</span> <span class="n">boundary</span><span class="o">);</span>
</code></pre></div></div>
<p>ì´ì „ì— web-browserì—ì„œ ì‚´í´ ë³¸ í—¤ë” ì •ë³´ë“¤ì´ë‹¤. 
Content-Typeì€ <code class="language-plaintext highlighter-rouge">"multipart/form-data"</code> í˜•ì‹ì´ê³ , <code class="language-plaintext highlighter-rouge">;</code> ì´í›„ì— boundary ì •ë³´ë¥¼ ìœ„ì™€ ê°™ì´ ë„£ì–´ì£¼ë©´ ëœë‹¤.</p>

<p>ë˜í•œ, POST methodì´ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">urlConn.setRequestMethod()</code> ì˜ íŒŒë¼ë¯¸í„°ë¡œ _<strong>â€œPOSTâ€</strong>_ë¥¼ ë„£ì–´ì£¼ì—ˆë‹¤.</p>

<p>ì´ ì™¸ì—</p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">"USER-AGENT"</code> : web browserì—ì„œ í™•ì¸ ê°€ëŠ¥.
<code class="language-plaintext highlighter-rouge">"ACCEPT-LANGUAGE"</code> : <em><strong>â€œen-us,en;0.5â€</strong></em> ë¡œ ê³ ì •í•´ì¤¬ë‹¤.
<code class="language-plaintext highlighter-rouge">"Connection"</code> : web browserì—ì„œ í™•ì¸ ê°€ëŠ¥.
<code class="language-plaintext highlighter-rouge">"User-Agent"</code> : <em><strong>â€œCodeJava Agentâ€</strong></em> ë¡œ ê³ ì •í•´ì¤¬ë‹¤.</p>

  <p><code class="language-plaintext highlighter-rouge">urlConn.setDoInput(true)</code>
<code class="language-plaintext highlighter-rouge">urlConn.setDoOutput(true)</code>
<code class="language-plaintext highlighter-rouge">urlConn.setUseCaches(false)</code> : ìœ„ 3ê°œëŠ” true / true / false ë¡œ ê³ ì •í•´ì£¼ì—ˆë‹¤.</p>
</blockquote>

<p>ë“±ì„ ì ì–´ì¤€ë‹¤.</p>

<hr />

<p><em><strong>4. form-dataë¥¼ ì…ë ¥í•œë‹¤.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DataOutputStream</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="n">urlConn</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>

<span class="c1">// Write key and values</span>
<span class="c1">// 1. Access Key</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Disposition: form-data; name=\"accessKey\""</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Type: application/json"</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">accessKey</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>

<span class="c1">// 2. Image data</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Disposition: form-data; name=\"files\"; filename=\"anything.png\""</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Type: image/jpeg"</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">imageBytes</span><span class="o">);</span>

<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="n">request</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<p>ì‚¬ì‹¤ìƒ ì´ë²ˆ ê°œë°œì—ì„œ <strong>ê°€ì¥</strong> ì¤‘ìš”í•œ ë¶€ë¶„ì´ë‹¤.
ë‚˜ëŠ” ì´ëŸ° requestë¥¼ ì²˜ìŒë³´ë‚´ì„œ, 3ì¼ì„ í—¤ë§¸ì—ˆë‹¤.</p>

<p><strong>ì‹¤ì œ requestë¥¼ ë³´ë‚¼ ë°ì´í„°ë“¤ì˜ ëª…ì„¸ì„œ(?)ë¥¼ ì ì–´ì£¼ëŠ” ë¶€ë¶„ì´ë‹¤.</strong>
ì•„ê¹Œ ìš”ì²­ ë°ì´í„° í•­ëª©ì—ì„œ ë´¤ì—ˆë˜</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundaryAYuewg7muT6zRKkc (+ crlf)
Content-Disposition: form-data; name="files"; filename="bird.jpg" (+ crlf)
Content-Type: image/jpeg (+ crlf)
(+ crlf)
(+ crlf)
------WebKitFormBoundaryAYuewg7muT6zRKkc-- (+ crlf)
(+ crlf)
</code></pre></div></div>
<p>ì´ ë¶€ë¶„ì„ ì ì–´ì£¼ëŠ” ê²ƒì´ë‹¤.</p>

<ul>
  <li>í•­ìƒ ì‹œì‘ì€ twoHypens + boundary + crlfë¡œ ì‹œì‘í•œë‹¤.</li>
  <li>Content-Disposition ì„ ì ì–´ì¤€ë‹¤. ë¬¸ìì—´ì´ë¯€ë¡œ ì›¹í˜ì´ì§€ì—ì„œ ë³´ì´ëŠ” ê·¸ëŒ€ë¡œ ì ì–´ì£¼ë©´ ëœë‹¤. <strong>crlf ë¥¼ ë¶™ì¸ë‹¤.</strong></li>
  <li>Content-Type ì„ ì ì–´ì¤€ë‹¤. <strong>crlf ë¥¼ ë¶™ì¸ë‹¤.</strong></li>
  <li><strong>crlf ë¥¼ ë¶™ì¸ë‹¤.</strong></li>
  <li><em>ì‹¤ì œë¡œ ë³´ë‚¼(POST) ë°ì´í„°ë¥¼ ì ì–´ì¤€ë‹¤.</em>
    <ul>
      <li><strong>String ì¼ ê²½ìš°</strong> : request.writeBytes()</li>
      <li><strong>byte[] (image)ì¼ ê²½ìš°</strong> : request.write()</li>
    </ul>
  </li>
  <li><strong>crlf ë¥¼ ë¶™ì¸ë‹¤.</strong></li>
  <li>í•­ìƒ ë§ˆì§€ë§‰ì€ twoHypens + boundary + twoHypens + crlf ë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.</li>
  <li>ë” ì´ìƒ ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ : <code class="language-plaintext highlighter-rouge">request.flush()</code> ë° <code class="language-plaintext highlighter-rouge">request.close()</code> ë¡œ POSTë¥¼ ì¢…ë£Œí•œë‹¤.</li>
</ul>

<p>ì´ë ‡ê²Œ í•˜ë©´ ì‹¤ì œ API Endpoint ì„œë²„ì— POST ë™ì‘ì´ ìˆ˜í–‰ëœë‹¤.</p>

<hr />

<p><em><strong>5. ì‘ë‹µ ì½”ë“œ(Response Code) ë° ì‘ë‹µ ë¬¸ìì—´ì„ í™•ì¸í•œë‹¤.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">response_code</span> <span class="o">=</span> <span class="n">urlConn</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Connection response code : ["</span> <span class="o">+</span> <span class="n">response_code</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>

<span class="c1">// [2-3]. ì—°ê²° ìš”ì²­ í™•ì¸.</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response_code</span> <span class="o">!=</span> <span class="nc">HttpsURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">){</span>
    <span class="k">return</span> <span class="s">"Response Code : "</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">response_code</span><span class="o">);</span>	<span class="c1">// response 200</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">InputStream</span> <span class="n">responseStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">urlConn</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
    <span class="nc">BufferedReader</span> <span class="n">responseStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">responseStream</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>

    <span class="nc">String</span> <span class="n">outputResponse</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>

    <span class="k">while</span> <span class="o">((</span><span class="n">outputResponse</span> <span class="o">=</span> <span class="n">responseStreamReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">outputResponse</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">responseStreamReader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="n">strResponse</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">strResponse</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì‘ë‹µì€ <code class="language-plaintext highlighter-rouge">InputStream</code> ê³¼ <code class="language-plaintext highlighter-rouge">BufferedReader</code> í´ë˜ìŠ¤ì—ì„œ ìˆ˜í–‰í•œë‹¤.
<code class="language-plaintext highlighter-rouge">BufferedReader</code> í´ë˜ìŠ¤ì˜ ê°ì²´ê°€ <code class="language-plaintext highlighter-rouge">InputStream</code> í´ë˜ìŠ¤ì˜ ê°ì²´ë¥¼ ë°›ëŠ”ë°, ì´ <code class="language-plaintext highlighter-rouge">InputStream</code> ì˜ ê°ì²´ëŠ” <code class="language-plaintext highlighter-rouge">urlConn.getInputStream()</code> ì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ”ë‹¤.</p>

<p>(ì‚¬ì‹¤ response ë¶€ë¶„ì€ ì•„ë§ˆ ì „ ì„¸ê³„ì˜ android http connection ëª¨ë“  ì½”ë“œì—ì„œ ë™ì¼í•˜ê²Œ ì ìš©ë  ê²ƒì´ë‹¤.)</p>

<p>ì´ë ‡ê²Œ í•´ì„œ, endlineê¹Œì§€ whileë¬¸ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">readline()</code> ì„ ìˆ˜í–‰í•˜ì—¬ <code class="language-plaintext highlighter-rouge">StringBuilder</code> ê°ì²´ì— ê²°ê³¼ ë¬¸ìì—´ì„ ì €ì¥í•œë‹¤.</p>

<p>ì´ë ‡ê²Œ ë‚˜ì˜¨ response ë¬¸ìì—´ì€, ì•„ê¹Œ <strong>MainActivity.class</strong> ì†ŒìŠ¤ ì½”ë“œì˜ NetworkTask í´ë˜ìŠ¤ ë‚´ë¶€
<code class="language-plaintext highlighter-rouge">result = requestHttpsURLConnection.request(url, accessKey, values);</code>
result ë³€ìˆ˜ì— ì €ì¥ëœë‹¤.</p>

<hr />

<h2 id="4-finish">4. Finish</h2>

<p>ê±°ì˜ ë‹¤ ì™”ë‹¤.</p>

<p>ì±•í„° 3ì˜ <code class="language-plaintext highlighter-rouge">request</code> í•¨ìˆ˜ëŠ” <code class="language-plaintext highlighter-rouge">doInBackground</code>ì—ì„œ ìˆ˜í–‰ë˜ì—ˆê³ ,
request ì˜ ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">doInBackground</code> í•¨ìˆ˜ ë‚´ë¶€ì˜ <code class="language-plaintext highlighter-rouge">result</code> ë³€ìˆ˜ì— ì €ì¥ë˜ì—ˆìœ¼ë©°,
í•´ë‹¹ <code class="language-plaintext highlighter-rouge">result</code> ë³€ìˆ˜ë¥¼ return í•˜ë©´ <code class="language-plaintext highlighter-rouge">onPostExecuted</code> í•¨ìˆ˜ì—ì„œ result ë³€ìˆ˜ì˜ ê°’ì„ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤.
(ì´ê±´ ì •í•´ì§„ êµ¬ì¡°ì´ë‹¤.)</p>

<p>ê·¸ëŸ¬ë©´ ì´ì œ <code class="language-plaintext highlighter-rouge">onPostExecuted()</code> í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ ì‚´í´ë³´ì.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">outputs</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">image</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="kt">double</span> <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="no">F</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">labelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">JSONArray</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">JSONObject</span> <span class="n">tempJsonObject</span> <span class="o">=</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"image"</span><span class="o">);</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"outputs"</span><span class="o">);</span>

                <span class="nc">JSONArray</span> <span class="n">jsonOutputsArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">outputs</span><span class="o">);</span>

                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">JSONObject</span> <span class="n">tempOutputsJsonObject</span> <span class="o">=</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                    <span class="n">labelName</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"label"</span><span class="o">);</span>
                    <span class="kt">double</span> <span class="n">tempSoftmaxValue</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="s">"softmax"</span><span class="o">);</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">maxSoftmax</span> <span class="o">&lt;</span> <span class="n">tempSoftmaxValue</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="n">tempSoftmaxValue</span><span class="o">;</span>
                        <span class="k">switch</span> <span class="o">(</span><span class="n">labelName</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">case</span> <span class="s">"0"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"bird"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"1"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"cat"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"2"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"deer"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"3"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"dog"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"4"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"frog"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"5"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"horse"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[onPostExecute] output is null state."</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">_resultView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Result : ["</span> <span class="o">+</span> <span class="n">maxLabelName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ìš°ë¦¬ëŠ” ë§¨ ì²˜ìŒì— Postman ìœ¼ë¡œ í™•ì¸í–ˆì„ ë•Œ, json í˜•íƒœì˜ ì‘ë‹µì´ ì˜¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
ê·¸ë ‡ê¸° ë•Œë¬¸ì— androidì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ JSON classë¥¼ import í•˜ì—¬ íŒŒì‹±í•˜ì˜€ë‹¤.</p>

<p>[ ] ë¡œ ì‹œì‘í•˜ë©´ JSONArrayë¡œ ê°ì²´ë¥¼ ë§Œë“¤ê³ , { } ë¡œ ì‹œì‘í•˜ë©´ JSONObjectë¡œ ê°ì²´ë¥¼ ë§Œë“¤ë©´ ëœë‹¤.</p>

<p>ì´ë ‡ê²Œ íŒŒì‹±ì„ í•˜ê³  ë‚˜ì„œ, TextView ì— ì¶”ë¡  ê²°ê³¼ categoryë¥¼ ì ì–´ì£¼ë©´ ê°œë°œì´ ëë‚˜ê²Œ ëœë‹¤.</p>

<hr />

<blockquote>
  <ul>
    <li>
      <p><strong>ë²„ê·¸ 1</strong> : AsyncTaskë¡œ ìˆ˜í–‰í•˜ì§€ ì•Šìœ¼ë©´, Android main threadì—ì„œ ìì²´ì ìœ¼ë¡œ blockingì„ í•œë‹¤.</p>
    </li>
    <li>
      <p><strong>ë²„ê·¸ 2</strong> : í—¤ë”ë¥¼ ì˜ëª» ì ìœ¼ë©´, response string ì´ ì „ë¶€ ê¹¨ì ¸ì„œ ì˜¬ ìˆ˜ ìˆë‹¤. ì´ëŸ´ ê²½ìš° 
<strong>í—¤ë”ë¥¼ í•˜ë‚˜ì”© ì†Œê±°í•˜ë©° ì–´ë–¤ í—¤ë”ë¥¼ ì˜ëª» ì ì—ˆëŠ”ì§€ ì²´í¬í•˜ê³ , í•´ë‹¹ í—¤ë”ì˜ ì˜¬ë°”ë¥¸ ê°’ì„ ì°¾ê±°ë‚˜ í˜¹ì€ ì•ˆì¨ì¤˜ë„ ë  ê²½ìš° ê·¸ëƒ¥ ì“°ì§€ë§ìâ€¦</strong></p>
    </li>
    <li><strong>ì°¸ê³  1</strong> : ë‚˜ì˜ ê²½ìš°ì—ì„œëŠ” AccessKeyë¥¼ ë„£ì–´ì£¼ê¸° ë•Œë¬¸ì— Https ì„œë²„ì—¬ë„ POSTê°€ ê°€ëŠ¥í–ˆë‹¤. (ë³„ë„ ì¸ì¦ì´ í•„ìš”ì—†ìŒ.) 
HTTP í†µì‹ ì˜ ê²½ìš° í¬ìŠ¤íŒ…í•œ ê²ƒì²˜ëŸ¼ í•˜ë©´ ëœë‹¤. ë‹¨, í´ë˜ìŠ¤ importëŠ” 
<code class="language-plaintext highlighter-rouge">import javax.net.ssl.HttpsURLConnection;</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">import java.net.HttpURLConnection;</code> ì„ ì¨ì£¼ê³ 
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HttpURLConnection urlConn = null;
urlConn = (HttpURLConnection) url.openConnection();
</code></pre></div>      </div>
      <p>ìœ¼ë¡œ ë°”ê¿”ì£¼ì.</p>
    </li>
    <li>
      <p><strong>ì°¸ê³  2</strong> : Httpsì˜ ê²½ìš° CA(ì¸ì¦ì„œ)ì™€ ê°™ì€ ì¸ì¦ ì •ë³´ê°€ ë³„ë„ë¡œ í•„ìš”í•˜ë‹¤ê³  í•œë‹¤.</p>
    </li>
    <li>
      <p><strong>ì°¸ê³  3</strong> : AsyncTaskëŠ” ë°˜ë“œì‹œ ìƒì†ë°›ì•„ì•¼ í•œë‹¤.</p>
    </li>
    <li><strong>ì°¸ê³  4</strong> : POSTê°€ ì œëŒ€ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•Šì•˜ì„ ê²½ìš°(response 400 codeì²˜ëŸ¼) web browser í˜¹ì€ API ë¬¸ì„œë¥¼ ë³´ê³ , ì–´ë–¤ í˜•íƒœì¸ì§€, Content-Type, Content-Disposition ë“±ì„ <strong>ë°˜ë“œì‹œ</strong> í™•ì¸í•˜ì.</li>
  </ul>
</blockquote>]]></content><author><name>bolero2</name></author><category term="Android" /><summary type="html"><![CDATA[HttpURLConnection í´ë˜ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ HTTP ì„œë²„ì— POST ìš”ì²­í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-android_https.png" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-android_https.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[DL] Semantic Segmentationì—ì„œ Label Image ìƒì„±í•˜ê¸°</title><link href="http://localhost:4000/deeplearning/2022/01/15/DL-Semantic-Segmentation-Create-Label-Image/" rel="alternate" type="text/html" title="[DL] Semantic Segmentationì—ì„œ Label Image ìƒì„±í•˜ê¸°" /><published>2022-01-15T00:00:00+09:00</published><updated>2022-01-15T00:00:00+09:00</updated><id>http://localhost:4000/deeplearning/2022/01/15/DL-Semantic-Segmentation-Create-Label-Image</id><content type="html" xml:base="http://localhost:4000/deeplearning/2022/01/15/DL-Semantic-Segmentation-Create-Label-Image/"><![CDATA[<p><span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    SemanticSegmentation
</span></p>

<h1 id="semantic-segmentationì—ì„œ-label-image-ìƒì„±í•˜ê¸°">Semantic Segmentationì—ì„œ Label Image ìƒì„±í•˜ê¸°</h1>

<p>semantic segmentationì€ ê°„ë‹¨í•˜ê²Œ ë³´ìë©´ <em>â€œ<strong>Image</strong>â€ - â€œ<strong>Image</strong>â€œ</em> ê´€ê³„ì˜ í•™ìŠµì…ë‹ˆë‹¤.</p>

<p>X ì…ë ¥ì—ëŠ” ë³´í†µ jpgë“  pngë“  ì½ì„ ìˆ˜ ìˆëŠ” Image fileì´ ë†“ì´ê³ ,<br />
Y ì…ë ¥(ì •ë‹µ)ì—ëŠ” ë³´í†µ png íŒŒì¼ì´ ì˜µë‹ˆë‹¤.</p>

<p>ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” <em><strong>ì–´ë–»ê²Œ í•˜ë©´ ë¼ë²¨ì— í•´ë‹¹ë˜ëŠ” Image file(.png)ë¥¼ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€?</strong></em> ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="0-intro"><strong>0. Intro</strong></h2>

<p>Semantic Segmentation Taskë¥¼ í•™ìŠµí•˜ëŠ”ë°ëŠ” 2ê°€ì§€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤:
<strong><em>(Input) X Data : í•™ìŠµí•  Image dataset
(Input) Y Data : í•™ìŠµí•  Imageì— ëŒ€ì‘ë˜ëŠ” Color Map Image file</em></strong></p>

<p>íŠ¹íˆ, Y Data ì˜ ê²½ìš°ì— â€œ<strong>JPG</strong>â€ í¬ë§·ì´ ì•„ë‹Œ â€œ<strong>PNG</strong>â€ í¬ë§·ì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>JPG í¬ë§·ì€ ì†ì‹¤ ì••ì¶•ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ìš©ëŸ‰ì´ ì‘ë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ
_<strong>ì‚¬ìš©ìì˜ ëˆˆì— ì¡íˆì§€ ì•ŠëŠ” íŠ¹ì • ë¶€ë¶„ì˜ Color ê°’ì´ ë³€ê²½ëœë‹¤ëŠ” íŠ¹ì§•</strong>_ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” Semantic Segmentationì˜ Label Imageë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ê³¼ ì¼ë°˜ì ì¸ Image Data ì™€ì˜ ì°¨ì´ì ì„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="1-about-semantic-segmentation"><strong>1. About Semantic Segmentation</strong></h2>
<p>ì‹œì‘í•˜ê¸°ì— ì•ì„œ, Semantic Segmentation Taskê°€ ì •í™•íˆ ì–´ë–¤ Taskì¸ì§€ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.
Semantic Segmentation Taskì˜ ê²½ìš°, 
<strong>ì „ì²´ ì´ë¯¸ì§€ì— ëŒ€í•´ ê°ê°ì˜ í”½ì…€ì´ ì–´ëŠ Label(=Category)ì— ì†í•˜ëŠ”ì§€ ë¶„ë¥˜í•˜ëŠ” ë¬¸ì œ</strong>ì…ë‹ˆë‹¤.</p>

<p>ì •êµí•œ ë¶„ë¥˜ë¥¼ í•´ë‚´ì•¼ í•˜ê¸° ë•Œë¬¸ì— <strong>Atrous Convolution</strong>ê³¼ ê°™ì€ <strong>Receptive Field(ìˆ˜ìš© ì˜ì—­, í•„í„°ê°€ í•œ ë²ˆì— ë³¼ ìˆ˜ ìˆëŠ” ì˜ì—­)</strong>ê°€ ë„“ì€ í•©ì„± ê³± ì—°ì‚°ì„ ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<dl>
  <dt><strong>DeepLab V3+</strong> ì½”ë“œ ì¤‘ì—ì„œ, ê°€ì¥ ì¤‘ìš”í•œ Loss Function êµ¬í˜„ ë¶€ë¶„ì„ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.</dt>
  <dt>(Github Repository</dt>
  <dd>https://github.com/jfzhang95/pytorch-deeplab-xception)</dd>
</dl>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="k">class</span> <span class="nc">SegmentationLosses</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">batch_average</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ignore_index</span> <span class="o">=</span> <span class="n">ignore_index</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_average</span> <span class="o">=</span> <span class="n">batch_average</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cuda</span> <span class="o">=</span> <span class="n">cuda</span>

    <span class="k">def</span> <span class="nf">build_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'ce'</span><span class="p">):</span>
        <span class="s">"""Choices: ['ce' or 'focal']"""</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'ce'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">CrossEntropyLoss</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'focal'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">FocalLoss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">CrossEntropyLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">logit</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ignore_index</span><span class="p">,</span>
                                        <span class="n">reduction</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">cuda</span><span class="p">:</span>
            <span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_average</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">FocalLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">logit</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">ignore_index</span><span class="p">,</span>
                                        <span class="n">reduction</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">cuda</span><span class="p">:</span>
            <span class="n">criterion</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="n">logpt</span> <span class="o">=</span> <span class="o">-</span><span class="n">criterion</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="nb">long</span><span class="p">())</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logpt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">logpt</span> <span class="o">*=</span> <span class="n">alpha</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pt</span><span class="p">)</span> <span class="o">**</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">logpt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_average</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></div>

<p>ìœ„ì˜ DeepLab V3+ Repositoryì— êµ¬í˜„ë˜ì–´ ìˆëŠ” Loss Function ì…ë‹ˆë‹¤.</p>

<p>ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” í•µì‹¬ì ì¸ ì½”ì–´ í•¨ìˆ˜ê°€ <strong>nn.CrossEntropyLoss</strong> ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Cross-Entropy Loss Function(ì´í•˜ <strong>CE Loss</strong>)ì€ Semantic Segmentation Task(ì´í•˜ <strong>ë¶„í•  ë¬¸ì œ</strong>)ì´ì „ì— ë¶„ë¥˜ ë¬¸ì œ(Classification)ì—ì„œ ìì£¼ ì“°ì´ëŠ” ì†ì‹¤ í•¨ìˆ˜ì…ë‹ˆë‹¤.</p>

<p>ê·¸ëŸ¼ ì™œ ë¶„ë¥˜ ë¬¸ì œì™€ ë¶„í•  ë¬¸ì œëŠ” ë‘˜ë‹¤ CE Lossë¥¼ ì“°ëŠ” ê²ƒì¼ê¹Œìš”?</p>

<blockquote>
  <p>1) ë¶„ë¥˜ ë¬¸ì œ(Classification) ì—ì„œëŠ” ì´ë¯¸ì§€ 1ì¥ ì „ì²´ì— ëŒ€í•œ Labelì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.
(ex. ì´ ì‚¬ì§„ì€ ê³ ì–‘ì´ ì‚¬ì§„ì…ë‹ˆë‹¤!)</p>

  <p>2) ë¶„í•  ë¬¸ì œ(Semantic Segmentation) ì—ì„œëŠ” ì´ë¯¸ì§€ 1ì¥ ë‚´ì˜ 1ê°œ í”½ì…€ì— ëŒ€í•œ Labelì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.
(ex. ì´ í”½ì…€ì€ ê³ ì–‘ì´ì— í•´ë‹¹í•˜ëŠ” í”½ì…€ì…ë‹ˆë‹¤!)</p>
</blockquote>

<p>ìœ„ì—ì„œ ì„œìˆ  í•˜ì˜€ë“¯ì´, ë‘ ë¬¸ì œ ëª¨ë‘ ë¶„ë¥˜ë¥¼ í•˜ê¸´ í•˜ì§€ë§Œ Classification ë¬¸ì œì˜ ê²½ìš°ëŠ” ì´ë¯¸ì§€ ì „ì²´ë¥¼ ë¶„ë¥˜í•˜ê³ ,
<strong>Semantic Segmentation ë¬¸ì œì˜ ê²½ìš°ëŠ” 1ê°œ í”½ì…€ì— ëŒ€í•´ì„œë§Œ ë¶„ë¥˜í•©ë‹ˆë‹¤.</strong></p>

<p>(ë¶„ë¥˜ ë¬¸ì œ ì‹ ê²½ë§ì—ì„œ, Batch Sizeê°€ 1ì´ë¼ê³  ê°€ì •í•œë‹¤ë©´ ë‹¨ìˆœíˆ 
True-Label 1ê°œì™€ Predicted-Label 1ê°œë¥¼ ë¹„êµí•˜ëŠ” ê²ƒì²˜ëŸ¼, 
True-Labelâ€™s 1â€“pixelê³¼ Predicted-Labelâ€™s 1-pixelì„ ë¹„êµí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
ì´ëŠ” ì´ë¯¸ì§€ì˜ width * height ìˆ˜ë§Œí¼ ë°˜ë³µë©ë‹ˆë‹¤.)</p>

<p>1ê°œ í”½ì…€ì´ë¼ê³  í•œë‹¤ë©´?
ì¼ë°˜ì ì¸ Color ImageëŠ” <strong>3ì±„ë„ì˜ RGB</strong> ê°’ì´ ë“¤ì–´ì˜¤ì§€ë§Œ, 
CE Lossë¥¼ ì‚¬ìš©í•˜ëŠ” ë¶„í•  ë¬¸ì œ íŠ¹ì„± ìƒ <strong>1ê°œ ì±„ë„ì˜ ê°’</strong>ì´ ë“¤ì–´ì˜¤ëŠ”ë° ì´ ê°’ì´ ë°”ë¡œ <strong>Label Value</strong>ê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p>ìµœì¢…ì ìœ¼ë¡œ, Semantic Segmentation Taskì˜ í•™ìŠµ ë°©ì‹ì€</p>

<blockquote>
  <ol>
    <li>1ê°œ í”½ì…€ ë³„ë¡œ Label ê°’ì„ ë‹¤ë¥´ê²Œ ì¤€ë‹¤.(Dataset ì¸¡ë©´)</li>
    <li>CE Lossë¥¼ í†µí•´ ì†ì‹¤ ê°’ì„ êµ¬í•œë‹¤.</li>
    <li>Optimizer(SGD, Adam etc.)ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ì†ì‹¤ ê°’ì„ backward ë°©í–¥ìœ¼ë¡œ ê°€ì¤‘ì¹˜ë¥¼ ê°±ì‹ í•œë‹¤.</li>
  </ol>
</blockquote>

<p>3ë‹¨ê³„ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="2-cv2imwrite--vs-pascal-voc-annotation">2. cv2.imwrite( ) vs Pascal VOC Annotation</h2>
<p>Label Image ì œì‘ì— ì•ì„œ, ì‹¤ì œë¡œ</p>

<ul>
  <li>ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ cv2.imwriteë¥¼ ì‚¬ìš©í•˜ì—¬ ì €ì¥í•œ Label Image</li>
  <li>Pascal VOCì˜ Semantic Segmentation Taskì˜ Annotation Label Image</li>
</ul>

<p>ë¥¼ ë¹„êµí•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
(Pascal VOC Dataset : host.robots.ox.ac.uk/pascal/VOC/voc2007)</p>

<p><strong><em>Mac OS â€” file command in terminal</em></strong>
<img src="https://images.velog.io/images/bolero2/post/bf3c4130-3bc6-4d4e-bdd8-c013ff4cbeb0/command.png" alt="file command in terminal" /></p>

<p>ìœ„ ì´ë¯¸ì§€ëŠ” 2ê°œì˜ ì´ë¯¸ì§€ë¥¼ Terminal ìƒì—ì„œ file commandë¡œ ì½ì–´ì˜¨ ê²°ê³¼ì…ë‹ˆë‹¤.</p>

<p><strong><em>2009_001625.png â€” RAW Image file</em></strong><br />
<img src="https://images.velog.io/images/bolero2/post/166417ed-1203-4b76-a7c9-563b1ef34d5d/bottle1.png" alt="2009_001625.png" /></p>

<p><strong>2009_001625.png</strong> íŒŒì¼ì€ Pascal VOC Datasetì—ì„œ ê°€ì ¸ì˜¨ íŒŒì¼ì´ê³ ,
<strong>2009_001625_RGB.png</strong> íŒŒì¼ì€ cv2.imwrite( ) í•¨ìˆ˜ë¡œ ì €ì¥í•œ íŒŒì¼ì…ë‹ˆë‹¤.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">2009_001625.png(VOC IMAGE)</th>
      <th style="text-align: center">2009_001625_RGB.png(cv2.imwrite IMAGE)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://images.velog.io/images/bolero2/post/5a20712b-14a2-4374-a4b4-72e31dc1683d/bottle1.png" alt="2009_001625.png" /></td>
      <td style="text-align: center"><img src="https://images.velog.io/images/bolero2/post/5b4e2800-04c5-4cbb-a3d7-de24198f7da1/bottle1_RGB.png" alt="2009_001625_RGB.png" /></td>
    </tr>
  </tbody>
</table>

<p>ëª…ë ¹ì–´ ê²°ê³¼ë¥¼ ë³´ë©´, VOC ImageëŠ” 8-bit colormap íŒŒì¼ì´ì§€ë§Œ cv2.imwriteë¡œ ì €ì¥í•œ ImageëŠ” 8-bit/color RGB íŒŒì¼ì…ë‹ˆë‹¤.
ì‚¬ëŒì´ ë³´ê¸°ì—”, ìœ¡ì•ˆìƒìœ¼ë¡œëŠ” ì–´ë–¤ ì°¨ì´ê°€ ìˆì„ê¹Œìš”?</p>

<p>ì–´ë–¤ ì´ë¯¸ì§€ê°€ Pascal VOCì¸ì§€ ëª¨ë¥¼ ì •ë„ë¡œ ë„ˆë¬´ ìœ ì‚¬í•©ë‹ˆë‹¤â€¦
ìœ¡ì•ˆìƒìœ¼ë¡œë„ ì „í˜€ ì°¨ì´ì ì´ ì—†ìŠµë‹ˆë‹¤. 
ì°¨ì´ì ì´ë¼ê³ ëŠ” ìœ„ì—ì„œ ì–¸ê¸‰í•œ 8-bit colormapì´ëƒ, 8-bit/color RGB íŒŒì¼ì´ëƒ ì°¨ì´ì…ë‹ˆë‹¤.
ìš°ë¦¬ëŠ” ì—¬ê¸°ì„œ PNG í¬ë§·ì˜ íŠ¹ì„±ê³¼ Label Imageì™€ì˜ ê´€ê³„ì— ëŒ€í•´ ì•Œì•„ë³¼ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="3-png-format-and-segmentation-label-image">3. PNG Format <em>and</em> Segmentation Label Image</h2>
<p>PNG í¬ë§·ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” JPGì™€ ê°™ì€ ì†ì‹¤ì••ì¶• ë°©ì‹ì´ ì•„ë‹Œ,
ì›ë³¸ ê·¸ëŒ€ë¡œì˜ Color ê°’ì„ ì €ì¥í•©ë‹ˆë‹¤.</p>

<p>ê·¸ë¦¬ê³  ì•„ì£¼ ì¤‘ìš”í•œ íŠ¹ì§•ì´ í•˜ë‚˜ ë” ìˆëŠ”ë°, ë°”ë¡œ
<strong>Palette ì •ë³´ë¥¼ ë„£ì„ ìˆ˜ ìˆë‹¤ëŠ” ì </strong>ì…ë‹ˆë‹¤.</p>

<p>Palette ì •ë³´ê°€ ì´ë¯¸ì§€ì— ë“¤ì–´ê°€ê²Œ ë˜ë©´ Image ArrayëŠ” ë” ì´ìƒ 3ì±„ë„ì´ì–´ì•¼ í•  í•„ìš”ê°€ ì—†ì–´ì§‘ë‹ˆë‹¤. ì´ë¥¼</p>

<blockquote>
  <p><strong>â€œIndexed Imageâ€</strong></p>
</blockquote>

<p>ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.</p>

<p>ë§ ê·¸ëŒ€ë¡œ <strong>â€œìƒ‰ì¸í™” ëœ ì´ë¯¸ì§€â€</strong> ì¸ ê²ƒì´ì£ .</p>

<p>Index ì •ë³´ëŠ” Paletteê°€ ë˜ëŠ” ê²ƒì´ê³ , Image Arrayì—ëŠ” ë‹¨ìˆœíˆ 1ì±„ë„ì˜ ê³µê°„ì— ìƒ‰ì¸ ì •ë³´(Index value)ë§Œ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.
ì¶”í›„ì— Paletteë¥¼ ë°”ê¾¸ê²Œ ë˜ë©´, Imageì˜ ìƒ‰ìƒ ê°’ë„ ë°”ë€Œê²Œ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</p>

<p><strong>Semantic Segmentationì€ Pixelì— ëŒ€í•œ ë¼ë²¨ ê°’ì„ í•™ìŠµí•  ë•Œ, ì´ Index valueë¥¼ í•™ìŠµí•˜ê²Œ ë©ë‹ˆë‹¤.</strong></p>

<hr />

<h2 id="4-how-create-label-image">4. <em>How create</em>â€¦ Label Image?</h2>
<p>ìœ„ì—ì„œ 
<em>1) ì™œ PNG í¬ë§·ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€,</em>
<em>2) Indexed Imageë€ ë¬´ì—‡ì¸ì§€,</em>
<em>3) ì™œ cv2.imwrite( )ì™€ ê°™ì€ ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜ë¡œ ì €ì¥í•˜ë©´ ì•ˆë˜ëŠ”ì§€</em>
ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.</p>

<p>ì´ì œëŠ” Polygon íƒ€ì…ì˜ Label Image (for Segmentation)ë¥¼ ì œì‘í•´ë³´ê² ìŠµë‹ˆë‹¤.
ì¤€ë¹„ë¬¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<blockquote>
  <ol>
    <li>Color Mapê³¼ Palette ì •ë³´</li>
    <li>ì €ì¥í•  Image ì •ë³´(file í˜•ì‹, numpy.ndarray í˜•ì‹ ëª¨ë‘ ìƒê´€ ì—†ìŠµë‹ˆë‹¤.)</li>
  </ol>
</blockquote>

<hr />

<p><strong><em>Color Mapì„ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</em></strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
 
<span class="k">def</span> <span class="nf">make_colormap</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">bit_get</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
       <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
 
   <span class="n">colormap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
   <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
 
   <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))):</span>
       <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
           <span class="n">colormap</span><span class="p">[:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">|=</span> <span class="n">bit_get</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span>
       <span class="n">ind</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span>
 
   <span class="k">return</span> <span class="n">colormap</span>
 
<span class="n">cmap</span> <span class="o">=</span> <span class="n">make_colormap</span><span class="p">(</span><span class="mi">256</span><span class="p">).</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">cmap</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">color</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">palette</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ì½”ë“œëŠ” Color Mapì„ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</p>

<p>Pascal VOCì—ì„œ í•´ë‹¹ ë°©ì‹ìœ¼ë¡œ Color Mapì„ ìƒì„±í•˜ì—¬ [20ê°œ ë¼ë²¨ + background] ê¹Œì§€ í•˜ì—¬ ì´ 21ê°œì˜ ìƒ‰ìƒ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>ìš°ë¦¬ê°€ ì € ì½”ë“œì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ëŠ” <strong>cmap</strong> ê³¼ <strong>palette</strong> ê°€ ìˆìŠµë‹ˆë‹¤.
<strong>cmap</strong> ì€ Imageì— ìƒ‰ì¸ ì •ë³´ë¥¼ ë„£ì–´ì¤„ ë•Œ ì‚¬ìš©í•  ê²ƒì´ê³ , 
<strong>palette</strong> ëŠ” PNG í¬ë§·ìœ¼ë¡œ ì €ì¥í•  ë•Œ ë„£ì–´ì¤„ íŒ”ë ˆíŠ¸ ì •ë³´ì…ë‹ˆë‹¤.</p>

<p>í•´ë‹¹ ì½”ë“œ ë™ì‘ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<blockquote>
  <p>[0, 0, 0, 128, 0, 0, 0, 128, 0, 128, 128, 0, 0, 0, 128, 128, 0, 128, 0, 128, 128, â€¦ ]</p>
</blockquote>

<p>ë³´ì‹œë‹¤ì‹œí”¼ ì•ì—ì„œ 3ê°œì”© ëŠì–´ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, 0ë²ˆ ë¼ë²¨(background)ì˜ ê²½ìš° RGB ê°’ì€ [0, 0, 0]ì´ ë  ê²ƒì´ê³ ,
1ë²ˆ ë¼ë²¨(aeroplane)ì˜ ê²½ìš° RGB ê°’ì€ [128, 0, 0]ì´ ë  ê²ƒì´ë©°, 
2ë²ˆ ë¼ë²¨(bicycle)ì˜ ê²½ìš° RGB ê°’ì€ [0, 128, 0]ì´ ë  ê²ƒì…ë‹ˆë‹¤.</p>

<p>(ì´ëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ê°’ì„ ë„£ì–´ì¤˜ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤. ë³¸ë¬¸ì—ì„œëŠ” Pascal VOC Datasetì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í—˜í•˜ì˜€ê¸° ë•Œë¬¸ì—, Pascal VOC Datasetì˜ Category ì •ë³´ì™€ ìƒ‰ìƒ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.)</p>

<hr />

<p>Color Mapê³¼ Palette ì •ë³´ë¥¼ ìƒì„±í•˜ì˜€ë‹¤ë©´, ì´ë¯¸ì§€ì— ìƒ‰ì¸ ì •ë³´ì™€ Paletteë¥¼ í•¨ê»˜ ë„£ì–´ì£¼ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<p><em><strong>Label Image ìƒì„± ì½”ë“œ</strong></em></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="c1"># Image data to save = image_data(numpy.ndarray)
</span><span class="n">label_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
 
<span class="c1"># if image array has BGR order
</span><span class="n">label_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">label_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<span class="c1"># Create an unsigned-int (8bit) empty numpy.ndarray of the same size (shape)
</span><span class="n">img_png</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">label_img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label_img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
 
<span class="c1"># Assign index to empty ndarray. Finding pixel location using np.where.
# If you don't use np.where, you have to run a double for-loop for each row/column.
</span><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">val_col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmap</span><span class="p">):</span>
    <span class="n">img_png</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">all</span><span class="p">(</span><span class="n">label_img</span> <span class="o">==</span> <span class="n">val_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="n">index</span>
 
<span class="c1"># Convert ndarray with index into Image object (P mode) of PIL package
</span><span class="n">img_png</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_png</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'P'</span><span class="p">)</span>
<span class="c1"># Palette information injection
</span><span class="n">img_png</span><span class="p">.</span><span class="n">putpalette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
<span class="c1"># save image
</span><span class="n">img_png</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="s">'output.png'</span><span class="p">)</span>
</code></pre></div></div>

<p>ìœ„ ì½”ë“œëŠ” ì‹¤ì œë¡œ Label Imageë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.</p>

<p>ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<blockquote>
  <ol>
    <li>image dataë¥¼ numpy.ndarray íƒ€ì…ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.</li>
    <li>BGR ìˆœì„œë¼ë©´ RGB ìˆœì„œë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤.</li>
    <li>ë™ì¼í•œ í¬ê¸°ì˜ unsigned-int (8bit) ndarrayë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
    <li><strong>ê° Color Mapì˜ ìƒ‰ìƒ ì •ë³´ë¥¼ ì°¾ì•„ì„œ, ìƒ‰ì¸í™” ê³¼ì •ì„ í•©ë‹ˆë‹¤.</strong>
(ì´ë¯¸ì§€ì˜ í”½ì…€ì„ ëŒë©° ë¹„êµí•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, Color Mapì˜ 1-Rowì— í•´ë‹¹í•˜ëŠ” ê°’ì„ í•œë²ˆì— ë°”ê¿”ì£¼ëŠ” í˜•ì‹ìœ¼ë¡œ í•©ë‹ˆë‹¤.)</li>
    <li>ìƒ‰ì¸í™” ëœ ì´ë¯¸ì§€ í–‰ë ¬ì„ â€˜Pâ€™ modeë¡œ ì €ì¥í•©ë‹ˆë‹¤.(<strong>P</strong> modeëŠ” <strong>Palette</strong> ëª¨ë“œì…ë‹ˆë‹¤.)</li>
    <li>ìœ„ì—ì„œ ìƒì„±í•œ Paletteë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤.</li>
    <li>png formatìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</li>
  </ol>
</blockquote>

<p>ì´ë ‡ê²Œ í•˜ë©´ Palette ì •ë³´ê°€ ìˆëŠ” ìƒ‰ì¸í™” ëœ ì´ë¯¸ì§€ íŒŒì¼ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë ‡ê²Œ ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼ì€ ë°”ë¡œ Semantic Segmentationì˜ í•™ìŠµì— ì‚¬ìš© ê°€ëŠ¥í•˜ë©°, Predict í•¨ìˆ˜ì—ì„œ ì¶œë ¥ëœ ê²°ê³¼ë¥¼ ì €ì¥í•  ë•Œë„ ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ì €ì¥í•˜ì—¬ ì„±ëŠ¥ ì¸¡ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<hr />

<h2 id="5-result">5. Result</h2>
<ol>
  <li>Semantic Segmentationì˜ Label Image ìƒì„± ì‹œ, ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ì €ì¥ ë°©ì‹ìœ¼ë¡œ ì €ì¥í•˜ë©´ ì•ˆë©ë‹ˆë‹¤.</li>
  <li>Color Mapê³¼ Palette ì •ë³´ê°€ í¬í•¨ëœ, Indexed Imageë¥¼ ì œì‘í•´ì•¼ í•©ë‹ˆë‹¤.</li>
  <li>ê·¸ ì´ìœ ëŠ” Segmentation í•™ìŠµì´ CE Lossë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì—¬ê¸°ì„œ 1-Pixelì— ëŒ€í•´ 1ê°œì˜ ê°’(=label value)ì„ ë¹„êµí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ì‚¬ìš©ìê°€ Augmentation í˜¹ì€ Annotation ì‹œì—, íŠ¹ì • Color Mapì„ ìƒì„± í›„ì— Pixelì˜ Label Valueì— ìƒ‰ì¸í™” ì‹œì¼œì£¼ëŠ” ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤. 
(ìƒë‹¨ ì†ŒìŠ¤ì½”ë“œ ì°¸ì¡°)</li>
</ol>]]></content><author><name>bolero2</name></author><category term="DeepLearning" /><summary type="html"><![CDATA[Semantic Segmentationì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¼ë²¨ë§ ë°ì´í„°ì— ëŒ€í•´ ì•Œì•„ë³´ê³ , ì–´ë–»ê²Œ ì œì‘í•  ìˆ˜ ìˆëŠ”ì§€ ì•Œì•„ë´…ë‹ˆë‹¤.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-segmentation_label.png" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-segmentation_label.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">[Paper] DETR - End-to-End Object Detection with Transformer</title><link href="http://localhost:4000/paper/2022/01/12/Paper-DETR-End-to-End-Object-Detection-with-Transformer/" rel="alternate" type="text/html" title="[Paper] DETR - End-to-End Object Detection with Transformer" /><published>2022-01-12T00:00:00+09:00</published><updated>2022-01-12T00:00:00+09:00</updated><id>http://localhost:4000/paper/2022/01/12/Paper-DETR-End-to-End-Object-Detection-with-Transformer</id><content type="html" xml:base="http://localhost:4000/paper/2022/01/12/Paper-DETR-End-to-End-Object-Detection-with-Transformer/"><![CDATA[<p><span class="tag  is-primary ">
    Paper
</span>
<span class="tag  is-primary ">
    DeepLearning
</span>
<span class="tag  is-primary ">
    Transformer
</span></p>

<h1 id="detr---end-to-end-object-detection-with-transformer">DETR - End-to-End Object Detection with Transformer</h1>

<p>ì´ë²ˆì— ì†Œê°œí•  ë…¼ë¬¸ì€ Facebook AI íŒ€ì—ì„œ ê³µê°œí•œ<br />
Transformer ë°©ì‹ì„ Computer Visionì˜ Object Detection ë¶„ì•¼ì— ì ìš©ì‹œí‚¨ <strong>DETR</strong>ì…ë‹ˆë‹¤.</p>

<p>DETRì€ <strong>DE</strong>tection + <strong>TR</strong>ansformer ì˜ ì¤„ì„ë§ë¡œ, ì´ë¦„ì—ì„œë¶€í„° Transformerê°€ Detection ë°©ì‹ì— ì‚¬ìš©ë¨ì„ ìœ ì¶”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë…¼ë¬¸ ì œëª©ì—ì„œ <strong>End-to-End</strong> ë¼ëŠ” ë§ì˜ ì˜ë¯¸ëŠ”,<br />
(ë’¤ì— ë“±ì¥í•˜ì§€ë§Œ)ê¸°ì¡´ Detection Networkê°€ ê°€ì§€ê³  ìˆëŠ” ì´ˆë§¤ê°œë³€ìˆ˜(<strong>Hyper-Parameter</strong>, ex. NMS, threshold, anchor-box etc.)ë¥¼<br />
Transformerì˜ End-to-End ë°©ì‹ì˜ í•™ìŠµì„ í†µí•´ ì—†ì•´ë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="1-abstract">1. Abstract</h2>

<p>ë…¼ë¬¸ì—ì„œ í¬ê²Œ ì£¼ì¥í•˜ëŠ” í•µì‹¬ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. ì‚¬ìš©ìê°€ ì„¤ì •í•´ì•¼ í•˜ëŠ” ê²ƒ(Hand-designed Components) ì„ ì œê±°  
2. Simpleí•œ Network êµ¬ì„±  
3. ì´ë¶„ë²•ì  ë§¤ì¹­(Bipartite Matching)ê³¼ Transformerì˜ Encoder-Decoder êµ¬ì¡° ì‚¬ìš©  
</code></pre></div></div>
<p>ì¶”ê°€ì ìœ¼ë¡œ, Object Detection ë¶„ì•¼ ë¿ ë§Œ ì•„ë‹ˆë¼<br />
<strong>Panoptic Segmentation(a.k.a Instance Segmentation)</strong> ë¶„ì•¼ì—ì„œë„ ì¢‹ì€ ì„±ëŠ¥ì„ ë³´ì—¬ì¤€ë‹¤ê³  í•©ë‹ˆë‹¤.</p>

<hr />

<h2 id="2-model-architecture">2. Model Architecture</h2>

<p>ë„¤íŠ¸ì›Œí¬ì˜ ì „ì²´ì ì¸ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<p><img src="https://user-images.githubusercontent.com/41134624/105303525-e6fb9400-5bfe-11eb-947c-ef4939938df6.jpg" alt="model1" /></p>

<p>í•´ë‹¹ ë„¤íŠ¸ì›Œí¬ëŠ” í¬ê²Œ ë³¸ë‹¤ë©´</p>
<blockquote>
  <p>1) <strong>C</strong>onvolution <strong>N</strong>eural <strong>N</strong>etwork(ResNet)
2) <strong>Transformer</strong> Encoder
3) <strong>Transformer</strong> Decoder
4) <strong>F</strong>eed-<strong>F</strong>oward <strong>N</strong>etwork(FFN)</p>
</blockquote>

<p>ì´ë ‡ê²Œ 4ë‹¨ê³„ë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DETRì€ ì´ 4ë‹¨ê³„ë¥¼ í†µí•´ ì…ë ¥ ë°ì´í„°ë¥¼ ê³§ë°”ë¡œ ë¶„ë¥˜ ì •ë³´ ë° bbox ì •ë³´ë¥¼ ì¶”ë¡  í•˜ê¸° ë•Œë¬¸ì—,  
NMSì™€ ê°™ì€ ì‚¬ìš©ìì˜ ì…ë ¥ ê°’ì„ ìš”êµ¬í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
</code></pre></div></div>

<h3 id="1-convolution-neural-network">1) Convolution Neural Network</h3>

<p>CNNì˜ ì£¼ ëª©ì ì€ ì…ë ¥ ì˜ìƒ ë°ì´í„°ì˜ <em><strong>íŠ¹ì§• ì¶”ì¶œ</strong></em> ì…ë‹ˆë‹¤.<br />
ë…¼ë¬¸ì—ì„œ ì‚¬ìš©í•œ CNN(=Backbone)ì€ ResNetìœ¼ë¡œ,<br />
<strong>3ch * W * H</strong> ì˜ìƒ ë°ì´í„°ê°€ ì…ë ¥ìœ¼ë¡œ ë“¤ì–´ì˜¨ í›„ &gt; ìµœì¢… <strong>2048ch * W/32 * H/32</strong> í¬ê¸°ì˜ Feature Mapì„ ìƒì„±í•©ë‹ˆë‹¤.</p>

<p><img src="https://user-images.githubusercontent.com/41134624/105318677-262de300-5c07-11eb-983c-c26c68abe782.jpg" alt="resnet" /></p>

<p>ì €ìëŠ” Backbone CNNìœ¼ë¡œ ResNet50 ëª¨ë¸ì„ ì‚¬ìš©í•˜ì˜€ëŠ”ë°,<br />
í•´ë‹¹ ëª¨ë¸ì˜ ë§¨ ë§ˆì§€ë§‰ channel ê¹Šì´ëŠ” <strong>2048</strong>ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="2-transformer-encoder">2) Transformer Encoder</h3>

<p>CNNì„ ê±°ì³ ìƒì„±ëœ Feature Mapì€ 1x1 convolutionì„ í†µí•´ <strong>d ì°¨ì›</strong>(=d ì±„ë„)ìœ¼ë¡œ ì¶•ì†Œë©ë‹ˆë‹¤.</p>
<blockquote>
  <ul>
    <li><em><strong>EncoderëŠ” Sequence Dataë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ê¸° ë•Œë¬¸ì—, Vectorizingí•¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong></em></li>
    <li><em><strong>ë˜í•œ, ì¶•ì†Œ ëœ d ì±„ë„ì€ Spatialí•˜ê²Œ ë¶„ë¦¬í•˜ì—¬ H*W í¬ê¸°ë¡œ êµ¬ì„±ëœ d ê°œì˜ ì¡°ê°ìœ¼ë¡œ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong></em></li>
  </ul>
</blockquote>

<p>2) Transformer Encoder
CNNì„ ê±°ì³ ìƒì„±ëœ Feature Mapì€ 1x1 convolutionì„ í†µí•´ d ì°¨ì›(=d ì±„ë„)ìœ¼ë¡œ ì¶•ì†Œë©ë‹ˆë‹¤.</p>

<p>EncoderëŠ” Sequence Dataë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ê¸° ë•Œë¬¸ì—, Vectorizingí•¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë˜í•œ, ì¶•ì†Œ ëœ d ì±„ë„ì€ Spatialí•˜ê²Œ ë¶„ë¦¬í•˜ì—¬ H*W í¬ê¸°ë¡œ êµ¬ì„±ëœ d ê°œì˜ ì¡°ê°ìœ¼ë¡œ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ê°ê°ì˜ dê°œ ì¡°ê°ì€ Encoder Layerì˜ ì…ë ¥ìœ¼ë¡œ Sequencialí•˜ê²Œ ë“¤ì–´ê°€ë©°, Encoder LayerëŠ” ê¸°ë³¸ì ì¸ êµ¬ì¡°ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
<blockquote>
  <ul>
    <li><em><strong>Encoder LayerëŠ” Multi-head Self-attention moduleë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</strong></em></li>
  </ul>
</blockquote>

<p>Encoderì—ì„œ ì‚´í´ ë³¼ ê²ƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ì›ë˜ TransformerëŠ” ì…ë ¥ ë°ì´í„°ì˜ ìˆœì„œê°€ ì¶œë ¥ ë°ì´í„°ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
* í•˜ì§€ë§Œ Vision ë¬¸ì œì—ì„œëŠ” ë¶„ë¦¬ ëœ dê°œì˜ ì¡°ê°ì— ëŒ€í•œ ìˆœì„œë‹¤ê°€ ì¤‘ìš”í•˜ê¸° ë•Œë¬¸ì— ê°ê°ì˜ Attention Layerë§ˆë‹¤ Position Embeddingì„ ì‹¤ì‹œí•©ë‹ˆë‹¤.
</code></pre></div></div>

<h3 id="3-transformer-decoder">3) Transformer Decoder</h3>

<p>Decoder ì—­ì‹œ Encoderì™€ ë™ì¼í•˜ê²Œ Standardí•œ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.<br />
Encoderì˜ ì¶œë ¥ìœ¼ë¡œ d sizeì˜ N Embeddingì´ ë‚˜ì˜¤ê³ , ì´ëŠ” ê·¸ëŒ€ë¡œ Decoderì˜ ì…ë ¥ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>

<p>Decoderì—ì„œ ì‚´í´ ë³¼ ê²ƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* ì›ë˜ì˜ DecoderëŠ” ë¶„ë¦¬ ëœ d ê°œì˜ ì¡°ê°ì„ í•˜ë‚˜ì˜ Sequenceë¡œ ë³´ê³ , í†µì§¸ë¡œ ì…ë ¥ ë°ì´í„°ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.
* í•˜ì§€ë§Œ DETRì—ì„œëŠ” ê°ê°ì˜ Decoder Layerë§ˆë‹¤ N ê°œì˜ Embedding ê°ì²´ë¥¼ Parallelí•˜ê²Œ Decodingí•©ë‹ˆë‹¤.
* ë˜í•œ, Encoderì²˜ëŸ¼ ê°ê°ì˜ Attention Layerì— Object Queryë¥¼ ì¶”ê°€í•˜ì—¬ Position Embeddingê³¼ ìœ ì‚¬í•œ ì‘ì—…ì„ í•©ë‹ˆë‹¤.
</code></pre></div></div>

<h3 id="4-feed-foward-networkffn">4) Feed-Foward Network(FFN)</h3>

<p>FFN ê°™ì€ ê²½ìš°ëŠ” ë‹¨ìˆœí•œ êµ¬ì¡°ë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤:</p>
<blockquote>
  <ul>
    <li>3 Layerì˜ Perceptronìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
    <li>ê°ê°ì˜ Perceptronì€ ReLU í™œì„±í™” í•¨ìˆ˜ì™€ d ì°¨ì›ì˜ ì€ë‹‰ì¸µ, 1ê°œì˜ Linear Projectionìœ¼ë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
  </ul>
</blockquote>

<p>ë˜í•œ, FFNì„ ê±°ì¹˜ê²Œ ë˜ë©´ Predictí•œ ê°’ì´ ë‚˜ì˜¤ê²Œ ë˜ëŠ”ë°, ì´ ê°’ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>
<blockquote>
  <p>1) Center X (relative)
2) Center Y (relative)
3) Height (relative)
4) Width (relative)</p>
</blockquote>

<p>(Relativeí•œ ì¢Œí‘œëŠ” í”½ì…€ì˜ ê°œìˆ˜ë¥¼ countí•˜ëŠ” ì ˆëŒ€ ì¢Œí‘œê°€ ì•„ë‹Œ, ì´ë¯¸ì§€ ì „ì²´ì˜ H/Wì— ë¹„ë¡€í•˜ëŠ” 0ê³¼ 1ì‚¬ì´ì˜ ì¢Œí‘œ ê°’ì…ë‹ˆë‹¤.)</p>

<p>FFNì€ Softmax í•¨ìˆ˜ë¥¼ í†µí•´ ë¶„ë¥˜ ë¼ë²¨ ë˜í•œ Predict í•©ë‹ˆë‹¤.<br />
Predict í•  ë•Œ, Ground-Truth ê°œìˆ˜ê°€ 5ê°œì´ê³ , Detection ê°ì²´ ê°œìˆ˜ê°€ 7ê°œë¼ë©´<br />
Ground-Truth ìª½ì— 2ê°œì˜ (no object)ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.</p>

<p><img src="https://user-images.githubusercontent.com/41134624/105328912-e5889680-5c13-11eb-8a99-9e9e822a3da2.jpg" alt="label_predict" /></p>

<p>ê·¸ë¦¼ê³¼ ê°™ì´, 4ê°œì˜ ê°ì²´ë¥¼ ê²€ì¶œí–ˆë‹¤ë©´, 2ê°œëŠ” (no object) í•­ëª©ìœ¼ë¡œ í• ë‹¹í•˜ê³  2ê°œëŠ” ì •ë‹µìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ <strong>ì´ë¶„ë²•(bipartite)ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.</strong></p>

<hr />

<h2 id="3-experiments">3. Experiments</h2>

<p>ì‹¤í—˜ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Item</th>
      <th style="text-align: center">Content</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Comparison Network</td>
      <td style="text-align: center">Faster-RCNN</td>
    </tr>
    <tr>
      <td style="text-align: center">Optimizer</td>
      <td style="text-align: center">AdamW</td>
    </tr>
    <tr>
      <td style="text-align: center">Backbone</td>
      <td style="text-align: center">ResNet-50, ResNet-101</td>
    </tr>
    <tr>
      <td style="text-align: center">Epoch</td>
      <td style="text-align: center">300</td>
    </tr>
    <tr>
      <td style="text-align: center">Dataset</td>
      <td style="text-align: center">COCO 2017</td>
    </tr>
  </tbody>
</table>

<p>ì‹¤í—˜ì— ì‚¬ìš©ëœ Datasetì€ <a href="https://cocodataset.org/#home">COCO 2017</a>ì˜ detection + segmentation ë°ì´í„° ì„¸íŠ¸ ì…ë‹ˆë‹¤.<br />
Segmentationì€ Panoptic Segmentationì˜ ì„±ëŠ¥ ì¸¡ì •ì„ ìœ„í•´ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<p><img src="https://user-images.githubusercontent.com/41134624/105329673-bf172b00-5c14-11eb-8ca7-468b4020761e.jpg" alt="exp1" /></p>

<p>ê·¸ë¦¼ì—ì„œ ë³´ëŠ” ê²ƒê³¼ ê°™ì´,</p>
<ol>
  <li>ëŒ€ë¶€ë¶„ì˜ ìƒí™©ì—ì„œ DETRì˜ parameter ê°œìˆ˜ê°€ í˜„ì €íˆ ë‚®ìŒì„ ì•Œ ìˆ˜ ìˆìœ¼ë©°,</li>
  <li>Average Precisionì€ 6 case ì¤‘ 4 caseì—ì„œ Faster-RCNNë³´ë‹¤ ë†’ìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ol>

<p>ì—¬ê¸°ì„œ Faster-RCNNì´ ë†’ì€ ì¼€ì´ìŠ¤ ì¤‘, AP-Small sizeëŠ” Faster-RCNNì´ 27.2ë¡œ 23.7ì˜ DETRë³´ë‹¤ ìš°ì›”í•˜ê²Œ ë†’ìŠµë‹ˆë‹¤.</p>

<p><strong>ì¦‰, DETRì€ ì‘ì€ Objectì— ëŒ€í•´ì„œ ìƒëŒ€ì ìœ¼ë¡œ ì•½í•¨ì„ ë³´ì…ë‹ˆë‹¤.</strong></p>

<hr />

<h2 id="4-source-code">4. Source Code</h2>

<p>ë…¼ë¬¸ì˜ ì €ìëŠ” Paper ë§¨ ë’¤ì— ê°„ë‹¨í•œ êµ¬í˜„ ì½”ë“œë¥¼ ê³µê°œí–ˆìŠµë‹ˆë‹¤.<br />
Abstractì—ì„œ ë§í•œ ê²ƒì²˜ëŸ¼, ì½”ë“œëŠ” ë§¤ìš° ê°„ë‹¨í•œ êµ¬ì¡°ë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤:</p>

<p><img src="https://user-images.githubusercontent.com/41134624/105314318-75711500-5c01-11eb-98b2-90eae749d3d0.jpg" alt="code" /></p>

<p>ì´ ì½”ë“œì—ì„œ ìš°ë¦¬ëŠ” ResNet-50 ëª¨ë¸ì„ ì‚¬ìš©í•œ ê²ƒê³¼, ë‚´ë¶€ í”„ë ˆì„ì›Œí¬ì—ì„œ ì œê³µí•˜ëŠ” ìˆ˜ì¤€ì˜ Transformer í•¨ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œ ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<p><strong>(Paper ReviewëŠ” ì œê°€ ìŠ¤ìŠ¤ë¡œ ì½ê³  ì‘ì„±í•œ ê¸€ì´ë¯€ë¡œ, ì£¼ê´€ì ì¸ ë‚´ìš©ì„ì„ ë°í™ë‹ˆë‹¤.)</strong></p>]]></content><author><name>bolero2</name></author><category term="Paper" /><summary type="html"><![CDATA[Facebook AI íŒ€ì—ì„œ ë°œí‘œí•œ, Transformerë¥¼ Object Detection taskì— ì‚¬ìš©í•œ ë…¼ë¬¸ì…ë‹ˆë‹¤.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://localhost:4000/img/thumbnail-detr.png" /><media:content medium="image" url="http://localhost:4000/img/thumbnail-detr.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>