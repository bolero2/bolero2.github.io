<!DOCTYPE html>




<html
 dir="ltr"
 lang="en"
 class="has-navbar-fixed-lrt">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content=#ffffff>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" type="image/png"
           href="/favicon.png" 
    />
    <script defer src="https://unpkg.com/alpinejs@3.9.0/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-social@1/bin/bulma-social.min.css">
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Android/Java] HttpURLConnection으로 HTTP POST request하기 | bolero2.log</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="[Android/Java] HttpURLConnection으로 HTTP POST request하기" />
<meta name="author" content="bolero2" />
<meta property="og:locale" content="en" />
<meta name="description" content="HttpURLConnection 클래스를 활용하여 HTTP 서버에 POST 요청하는 방법입니다." />
<meta property="og:description" content="HttpURLConnection 클래스를 활용하여 HTTP 서버에 POST 요청하는 방법입니다." />
<link rel="canonical" href="http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/" />
<meta property="og:url" content="http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/" />
<meta property="og:site_name" content="bolero2.log" />
<meta property="og:image" content="http://localhost:4000/img/thumbnail-android_https.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-06T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/img/thumbnail-android_https.png" />
<meta property="twitter:title" content="[Android/Java] HttpURLConnection으로 HTTP POST request하기" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"bolero2"},"dateModified":"2022-04-06T00:00:00+09:00","datePublished":"2022-04-06T00:00:00+09:00","description":"HttpURLConnection 클래스를 활용하여 HTTP 서버에 POST 요청하는 방법입니다.","headline":"[Android/Java] HttpURLConnection으로 HTTP POST request하기","image":"http://localhost:4000/img/thumbnail-android_https.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/"},"url":"http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/"}</script>
<!-- End Jekyll SEO tag -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=3563142385"></script>
<script>
  window['ga-disable-3563142385'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '3563142385');
</script><!-- head scripts --></head>

  <body>
    <nav class="navbar is-primary  is-fixed-lrt " x-data="{ openNav: false }">
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="navbar-item">
                bolero2.log
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu" :class="{ 'is-active': openNav }" x-on:click="openNav = !openNav">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu" :class="{ 'is-active': openNav }">
            <div class="navbar-start">
                <a href="/" class="navbar-item ">Home</a>
                
                
                    
                    <a href="/blog/" class="navbar-item ">Blog</a>
                    
                
                    
                    <div class="navbar-item has-dropdown is-hoverable ">
                        <a href="/" class="navbar-link ">My works</a>
                        <div class="navbar-dropdown">
                            
                            <a href="https://github.com/bolero2/vggnet-torch" class="navbar-item ">vggnet-pytorch</a>
                            
                            <a href="https://github.com/bolero2/deeplab-v3-torch" class="navbar-item ">deeplab-v3-pytorch</a>
                            
                        </div>
                    </div>
                    
                
                    
                    <div class="navbar-item has-dropdown is-hoverable ">
                        <a href="/" class="navbar-link ">Published papers</a>
                        <div class="navbar-dropdown">
                            
                            <a href="https://www.kci.go.kr/kciportal/ci/sereArticleSearch/ciSereArtiView.kci?sereArticleSearchBean.artiId=ART002429571" class="navbar-item ">이중흐름 3차원 합성곱 신경망 구조를 이용한 효율적인 손 제스처 인식 방법</a>
                            
                            <a href="https://github.com/bolero2/bolero2/blob/main/papers/%5BKSC2018%5D%20실시간%20손%20제스처%20인식을%20위한%20덴스넷%20기반%20이중흐름%203차원%20합성곱%20신경망%20구조.pdf" class="navbar-item ">실시간 손 제스처 인식을 위한 덴스넷 기반 이중흐름 3차원 합성곱 신경망 구조</a>
                            
                            <a href="https://www.kci.go.kr/kciportal/ci/sereArticleSearch/ciSereArtiView.kci?sereArticleSearchBean.artiId=ART002529690" class="navbar-item ">Atrous Convolution과 Grad-CAM을 통한 손 끝 탐지</a>
                            
                            <a href="https://www.earticle.net/Article/A379292" class="navbar-item ">실시간 손끝 탐지를 위한 VGGNet 기반 객체 탐지 네트워크</a>
                            
                        </div>
                    </div>
                    
                
                    
                    <a href="https://github.com/bolero2" class="navbar-item ">Github Profile</a>
                    
                
                
            </div>

            <div class="navbar-end">
                
                <a class="navbar-item" href="https://github.com/sponsors/bolero2">
                    <span class="icon gh-sponsor"><i class="fas fa-heart"></i></span>
                    <span>Sponsor</span>
                </a>
                
            </div>

        </div>
    </div>
</nav>

    
        <section class="hero  is-medium  is-bold is-primary" >
    <div class="hero-body ">
        <div class="container">
            <h1 class="title is-2">[Android/Java] HttpURLConnection으로 HTTP POST request하기</h1>
            <p class="subtitle is-3"></p>
            
        </div>
    </div>
</section>
    
    


    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                
                <div class="column is-4-desktop is-4-tablet">
                    
                    

<div class="contents">
    <div class="menu">
        <p class="menu-label">Contents</p>
        <ul class="menu-list">
  <li><a href="#0-intro">0. Intro</a></li>
  <li><a href="#1-before-development">1. Before Development</a></li>
  <li><a href="#2-checking-header-information">2. Checking header information</a></li>
  <li><a href="#3-development">3. Development</a>
    <ul>
      <li><a href="#3-1-pre-setting">3-1. pre-setting</a></li>
      <li><a href="#3-3-networktask">3-3. NetworkTask</a></li>
      <li><a href="#3-4-requesthttpsurlconnection">3-4. RequestHttpsURLConnection</a></li>
    </ul>
  </li>
  <li><a href="#4-finish">4. Finish</a></li>
</ul>
    </div>
</div>



                </div>
                
                <div class="column is-8">
                    
                    
                    
                    
                    <div class="content">

    <p><b>Published:</b> Apr 6, 2022 : by <b>bolero2</b></p>

    
        


<p class="title is-5 is-spaced">Android</p>






    <p class="title is-6"></p>


<ul class="block-list is-small is-outlined">
    
        

        
            <li class="is-highlighted is-dark">
                <p>[Android/Java] HttpURLConnection으로 HTTP POST request하기</p>
            </li>
        

    
</ul>


    

    <p><span class="tag  is-primary ">
    Android
</span>
<span class="tag  is-primary ">
    Java
</span></p>

<h2 id="0-intro">0. Intro</h2>

<p>필자 회사의 추론 서버(Inference Server)로 이미지를 <strong>POST</strong> 요청해서 응답을 받아오는
Android Application을 제작하게 되었다.</p>

<p>나는 Android 개발이란 걸 단 한번도 해본 적이 없었고,
Java 보다는 C++와 Python을 주로 썼었다.</p>

<p>그래서 그런지 굉장히 많은 삽질을 하며 장장 1주일에 걸쳐서 개발을 완료했는데,
나에게는 너무 어렵고 중요했던 정보였기에 블로그 포스팅을 하게 되었다.</p>

<hr />

<h2 id="1-before-development">1. Before Development</h2>

<p>우선, 어떠한 서버가 있고 거기에 AccessKey와 Image를 보내야 한다.
간단하게 Postman 으로 테스트를 해볼 수 있다.</p>

<p><img src="https://velog.velcdn.com/cloudflare/bolero2/2d07c10a-cfd3-49b2-a8ea-251bfe794aa1/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202022-04-06%2006.04.20.png" alt="" /></p>

<p>이렇게 POST method로 https://staging.server.com/api/inference/target 위치로</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accessKey</span> <span class="o">=</span> <span class="s">"abcd12345"</span>
<span class="n">files</span> <span class="o">=</span> <span class="s">"bird.jpg"</span>
</code></pre></div></div>
<p>형식을 보내면 아래와 같이 응답이 온다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"fileName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"어쩌구_저쩌구_파일이름1.jpg"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"width"</span><span class="p">:</span><span class="w"> </span><span class="mi">2560</span><span class="p">,</span><span class="w">
            </span><span class="nl">"height"</span><span class="p">:</span><span class="w"> </span><span class="mi">1696</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"softmax"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9987636804580688</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="nl">"softmax"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0012363195419311523</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>개발 전에, 알아야 할 정보는</p>
<blockquote>
  <ol>
    <li>어떤 Key 값을 보내야 하는가?</li>
    <li>각각의 Key에 매핑되는 Value 타입. (String? Image? Bitmap? 등)</li>
    <li>(당연하지만) POST 요청을 보낼 서버 주소</li>
    <li>헤더 정보</li>
  </ol>
</blockquote>

<p>등이 있다.</p>

<p>헤더 정보는 Request 요청을 보낼 때 어긋나게 되면
<strong>1. 요청이 잘못 가거나</strong> 혹은 <strong>2. 응답이 이상하게 올 수 있기</strong> 때문에 반드시 확인해야 한다.</p>

<p>그럼 헤더 정보는 어떻게 알 수 있을까?</p>

<hr />

<h2 id="2-checking-header-information">2. Checking header information</h2>

<p>사실 코드 작성보다 헤더 확인이라는 부분이 엄청 힘들었다.
나는 네트워크나 서버 개발을 해 본 적이 없어서, 헤더의 중요성을 몰랐는데 이번 기회에 뼈저리게 느꼈다.</p>

<p>Swagger 라든지, DevTools(개발자 도구, 요소 점검) 라든지, 어떠한 방식으로든 웹페이지에서 헤더 정보를 확인할 수 있다.
필자는 개발자 도구를 사용해서 웹페이지에서 직접 헤더를 확인하였다.</p>

<p><img src="https://velog.velcdn.com/cloudflare/bolero2/bd9a5013-08e5-4cf4-bb94-54a8d05c391e/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202022-04-06%2006.18.57.png" alt="회사 제품.jpg" /></p>

<p><strong>이렇게 개발자 도구를 열고, 네트워크 탭 - XHR/Fetch 항목으로 들어가면 [요청, 응답, 요청 데이터] 등을 확인할 수 있다.</strong>
그리고 저기의 Content-Type, Accept-Language 등이 우리가 Connection을 할 때 설정해야 할 헤더 및 Key 정보들이다.</p>

<p>아래로 더 내리면 요청 데이터 항목이 있다.
<img src="https://velog.velcdn.com/cloudflare/bolero2/1b1a7fd0-d4ee-4fe7-9e5d-fb74af163c35/image.png" alt="" /></p>

<p>유형은 <code class="language-plaintext highlighter-rouge">multipart/form-data</code> 이고, boundary는 <code class="language-plaintext highlighter-rouge">----WebKitFormBoundaryAYuewg7muT6zRKkc</code> 이다.</p>

<p>나는 boundary가 뭔지 엄청 헷갈렸는데, 쉽게 생각해서 “구분자” 라고 보면 된다.</p>

<p>POST로 데이터를 보내면, key-value pair가 1개든 10개든 하나의 String 타입으로 보낸다.
그러면 각 key-value pair를 구분할 수 있어야 하는데, boundary가 그 역할을 하게 된다.</p>

<p>개발자 도구에서 요청 데이터를 직접 볼 수 있다.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundaryAYuewg7muT6zRKkc
Content-Disposition: form-data; name="files"; filename="bird.jpg"
Content-Type: image/jpeg


------WebKitFormBoundaryAYuewg7muT6zRKkc--

</code></pre></div></div>
<p>이렇게, <strong>two-hypens</strong>(“–“)과 <strong>줄바꿈</strong>(=crlf, Java에서는 “\r\n”을 쓴다.), <strong>boundary</strong>의 조합으로 볼 수 있다.</p>

<p>1개의 데이터가 아니라 여러 개의 image data를 보냈을 때의 요청 데이터는 어떨까?</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="bird1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="cat1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="deer1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy
Content-Disposition: form-data; name="files"; filename="dog1.jpg"
Content-Type: image/jpeg


------WebKitFormBoundary3d92ZiPrZIV3SDAy--

</code></pre></div></div>
<p>이렇게 나타난다. <strong>우리가 Android 개발 시에 POST 데이터를 보내줄 때, 이러한 형식을 맞춰야 한다.</strong></p>

<p>(보통 boundary는 웹 페이지에서 알아서 보내준다고 한다.
개발자가 임의로 작성해도 된다고 하지만, 필자는 웹페이지의 형식을 복사 붙여넣기 하였다.)</p>

<hr />

<h2 id="3-development">3. Development</h2>

<p>이제 실제 코드부분을 작성해보자.</p>

<h3 id="3-1-pre-setting">3-1. pre-setting</h3>
<p>작동 방식은 다음과 같다:</p>

<ol>
  <li>Load Image 버튼으로 ImageView에 이미지를 띄우고</li>
  <li>Send To Server 버튼으로 해당 이미지를 서버로 전송한다.</li>
</ol>

<p>화면 구성은 다음과 같다:
<img src="https://velog.velcdn.com/cloudflare/bolero2/03bd1748-a0df-43a5-907c-393a27385be9/flow1.jpg" alt="" /></p>

<p>버튼 및 String, ImageView, TextView 관련해서는 이후에 포스팅을 하고,
지금은 Http Request가 목적이므로 생략한다.</p>

<p>우선, STORAGE 및 Network permission을 적어줘야 한다.
<code class="language-plaintext highlighter-rouge">app/manifests/AndroidManifest.xml</code> 위치에 적는다.</p>

<ul>
  <li><strong>AndroidManifest.xml</strong>
```xml</li>
</ul>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.example.demoandroidapp">
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.INTERNET" />
</manifest>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>외부 Class는 사용하는 것이 없기 때문에, `build.gradle` 에는 수정할 것이 없다.

### 3-2. MainActivity

간단하게 MainActivity의 OnCreate 및 OnCreate 하위 buttonLoadImage.setOnClickListener 함수 코드만 보자.

- **MainActivity.class**
```java
import androidx.appcompat.app.AppCompatActivity;
import android.annotation.SuppressLint;
import android.content.Intent;
import android.database.Cursor;
import android.os.AsyncTask;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.BitmapDrawable;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.view.View;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;
import java.io.ByteArrayOutputStream;
import org.json.JSONArray;
import org.json.JSONObject;

public class MainActivity extends AppCompatActivity {
    private static final int RESULT_LOAD_IMAGE = 1;
    private static String output = "";
    private TextView resultTextView = null;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // declaration button
        Button buttonLoadImage = (Button) findViewById(R.id.button);
        Button buttonSendToServer = (Button) findViewById(R.id.detect);
        resultTextView = findViewById(R.id.resultText);

        // permission
        requestPermissions(new String[]{android.Manifest.permission.READ_EXTERNAL_STORAGE}, 1);

        // Declaration TextView, ImageView, initialization resultTextView

        TextView NothingToShowTextView = findViewById(R.id.nothingToShowText);
        ImageView imageView = (ImageView) findViewById(R.id.image);
        resultTextView.setText("");

        buttonLoadImage.setOnClickListener(new View.OnClickListener() {

            @SuppressLint("SetTextI18n")
            @Override
            public void onClick(View arg0) {
                // reset TextView
                NothingToShowTextView.setText("");
                Intent i = new Intent(
                        Intent.ACTION_PICK,
                        MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
                startActivityForResult(i, RESULT_LOAD_IMAGE);
            }
        });
</code></pre></div></div>

<p>그리고 OnCreate 내부에 이어서 <code class="language-plaintext highlighter-rouge">buttonSendToServer.setOnClickListener</code> 를 작성한다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buttonSendToServer</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>

    <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">"SetTextI18n"</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">arg0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Bitmap</span> <span class="n">original_bitmap</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">url_string</span> <span class="o">=</span> <span class="s">"https://staging.server.com/api/inference/target"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">accessKey_string</span> <span class="o">=</span> <span class="s">"abcd12345"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">resultTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Inference in progress..."</span><span class="o">);</span>

            <span class="c1">// Getting the image from the image view</span>
            <span class="c1">// [1] Read the image as Bitmap</span>
            <span class="n">original_bitmap</span> <span class="o">=</span> <span class="o">((</span><span class="nc">BitmapDrawable</span><span class="o">)</span> <span class="n">imageView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">()).</span><span class="na">getBitmap</span><span class="o">();</span>

            <span class="nc">ByteArrayOutputStream</span> <span class="n">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="n">original_bitmap</span><span class="o">.</span><span class="na">compress</span><span class="o">(</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">CompressFormat</span><span class="o">.</span><span class="na">JPEG</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="n">blob</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">imageBytes</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>

            <span class="c1">// [2] http connection</span>
            <span class="nc">NetworkTask</span> <span class="n">networkTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NetworkTask</span><span class="o">(</span><span class="n">url_string</span><span class="o">,</span>
                                                      <span class="n">accessKey_string</span><span class="o">,</span>
                                                      <span class="n">imageBytes</span><span class="o">,</span>
                                                      <span class="n">resultTextView</span><span class="o">);</span>
            <span class="n">networkTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failed to open image file."</span><span class="o">);</span>
            <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">imageView</span><span class="o">.</span><span class="na">setImageDrawable</span><span class="o">(</span><span class="k">new</span> <span class="nc">BitmapDrawable</span><span class="o">(</span><span class="n">getResources</span><span class="o">(),</span> <span class="n">original_bitmap</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">String url_string</code> 에는 Postman에서 봤던 <code class="language-plaintext highlighter-rouge">"https://staging.server.com/api/inference/target"</code> 을 적고, 
<code class="language-plaintext highlighter-rouge">String accessKey_string</code> 에는 <code class="language-plaintext highlighter-rouge">"abcd12345"</code> 를 적어준다.</p>

<p>여기서 핵심은 2가지이다.</p>
<blockquote>
  <ol>
    <li>Bitmap 타입의 이미지를 byte[] 타입으로 변환한다.</li>
    <li>AsyncTask 를 상속받은 NetworkTask를 execute() 한다.</li>
  </ol>
</blockquote>

<p>byte[] 형태로 변환하는 것은, <strong>ImageView에서 이미지를 읽어서(bitmap) &gt; toByteArray();를 적용하는 것</strong>이다.</p>

<h3 id="3-3-networktask">3-3. NetworkTask</h3>

<p>NetworkTask는 다음과 같이 작성했다:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NetworkTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="cm">/**
     * AsyncTask start
     *
     * (single Worker Thread)
     * 1. onPreExecuted()
     * 2. doInBackground()
     *      - publishProgress() -&gt; onProgressUpdate()
     *      - publishProgress() -&gt; onProgressUpdate()
     *      - ...
     * 3. onPostExecuted()
     *
     */</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">url</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">accessKey</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">values</span><span class="o">;</span>
    <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">"StaticFieldLeak"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TextView</span> <span class="n">_resultView</span><span class="o">;</span>

    <span class="c1">// Constructor</span>
    <span class="kd">public</span> <span class="nf">NetworkTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">accessKey</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">values</span><span class="o">,</span> <span class="nc">TextView</span> <span class="n">resultView</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accessKey</span> <span class="o">=</span> <span class="n">accessKey</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">_resultView</span> <span class="o">=</span> <span class="n">resultView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">result</span><span class="o">;</span> <span class="c1">// 요청 결과를 저장할 변수.</span>
        <span class="nc">RequestHttpsURLConnection</span> <span class="n">requestHttpsURLConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RequestHttpsURLConnection</span><span class="o">();</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">requestHttpsURLConnection</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">accessKey</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[doInBackground] output : "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[doInBackground] output is null state."</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressLint</span><span class="o">(</span><span class="s">"SetTextI18n"</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">outputs</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">image</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="kt">double</span> <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="no">F</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">labelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">JSONArray</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">JSONObject</span> <span class="n">tempJsonObject</span> <span class="o">=</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"image"</span><span class="o">);</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"outputs"</span><span class="o">);</span>

                    <span class="nc">JSONArray</span> <span class="n">jsonOutputsArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">outputs</span><span class="o">);</span>

                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="nc">JSONObject</span> <span class="n">tempOutputsJsonObject</span> <span class="o">=</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                        <span class="n">labelName</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"label"</span><span class="o">);</span>
                        <span class="kt">double</span> <span class="n">tempSoftmaxValue</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="s">"softmax"</span><span class="o">);</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">maxSoftmax</span> <span class="o">&lt;</span> <span class="n">tempSoftmaxValue</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="n">tempSoftmaxValue</span><span class="o">;</span>
                            <span class="k">switch</span> <span class="o">(</span><span class="n">labelName</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">case</span> <span class="s">"0"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"bird"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"1"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"cat"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"2"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"deer"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"3"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"dog"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"4"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"frog"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="k">case</span> <span class="s">"5"</span><span class="o">:</span>
                                    <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"horse"</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>

                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[onPostExecute] output is null state."</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">_resultView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Result : ["</span> <span class="o">+</span> <span class="n">maxLabelName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>AsyncTask는 Http Connection을 위해서 <strong>반드시</strong> 상속받아야 된다고 한다.
(Android 실행의 main thread에서 network connection 동작을 하지 않는다고 한다.)</p>

<p>AsyncTask의 동작 방식은</p>
<blockquote>
  <ol>
    <li>AsyncTask start</li>
    <li><strong>onPreExecuted()</strong></li>
    <li><strong>doInBackground()</strong>
      <ul>
        <li>publishProgress() -&gt; onProgressUpdate()</li>
        <li>publishProgress() -&gt; onProgressUpdate()</li>
        <li>…</li>
      </ul>
    </li>
    <li><strong>onPostExecuted()</strong></li>
  </ol>
</blockquote>

<p>순서이다.</p>

<p>doInBackground() 이후에 onPostExecuted() 함수가 수행되는데,</p>

<p>doInBackground 함수의 return type이 <strong>String</strong> 이므로,
onPostExecuted() 함수의 입력 파라미터의 type 역시 <strong>String</strong> 이 된다.</p>

<p>doInBackground 에서 실제 POST request를 날리고, onPostExecuted 에서 POST response String에 대한 후처리가 이루어진다. (화면에 결과값 띄워주기 등)</p>

<p>실제 동작은 <strong>doInBackground()</strong> 함수 내부 중간의</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RequestHttpsURLConnection</span> <span class="n">requestHttpsURLConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RequestHttpsURLConnection</span><span class="o">();</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">requestHttpsURLConnection</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">accessKey</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span> <span class="c1">// 해당 URL로 부터 결과물을 얻어온다.</span>
</code></pre></div></div>
<p>부분에서 POST request를 날리게 된다.
생성자 파라미터는 없고, <code class="language-plaintext highlighter-rouge">request</code> 함수의 파라미터는:</p>
<blockquote>
  <ol>
    <li><strong>url</strong> : API Endpoint</li>
    <li><strong>accessKey</strong> : key[‘accessKey’]</li>
    <li><strong>values</strong> : key[‘files’] (byte[] type.)</li>
  </ol>
</blockquote>

<p>이렇게 3개로 설정하였다.</p>

<p>그러면 이제 핵심 부분인 <code class="language-plaintext highlighter-rouge">RequestHttpsURLConnection</code> class 코드를 보자.</p>

<h3 id="3-4-requesthttpsurlconnection">3-4. RequestHttpsURLConnection</h3>

<ul>
  <li><strong>RequestHttpsURLConnection.class 전체 코드</strong>
```java
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.InputStream;
import java.io.BufferedInputStream;
import java.io.DataOutputStream;
import javax.net.ssl.HttpsURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;</li>
</ul>

<p>public class RequestHttpsURLConnection {
    String strResponse = null;
    public String request(String _url, String accessKey, byte[] imageBytes){</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // HttpURLConnection 참조 변수.
    HttpsURLConnection urlConn = null;

    try{
        String crlf = "\r\n";     // carriage return + line feed
        String twoHyphens = "--";
        String boundary = "----WebKitFormBoundarynuXSuFo6d9f2xtbb";

        URL url = new URL(_url);
        urlConn = (HttpsURLConnection) url.openConnection();

        // [2-1]. urlConn 설정.
        urlConn.setRequestMethod("POST"); // URL 요청에 대한 메소드 설정 : POST.
        urlConn.setRequestProperty("USER-AGENT", "Mozilla/5.0");
        urlConn.setRequestProperty("ACCEPT-LANGUAGE", "en-us,en;0.5");
        urlConn.setDoInput(true);
        urlConn.setDoOutput(true);
        urlConn.setUseCaches(false);

        urlConn.setRequestProperty("Connection", "keep-alive");
        urlConn.setRequestProperty("User-Agent", "CodeJava Agent");
        urlConn.setRequestProperty("Content-Type", "multipart/form-data; boundary=" + boundary);

        // [2-2]. parameter 전달 및 데이터 읽어오기.
        DataOutputStream request = new DataOutputStream(urlConn.getOutputStream());

        // Write key and values
        // 1. Access Key
        request.writeBytes(twoHyphens + boundary + crlf);
        request.writeBytes("Content-Disposition: form-data; name=\"accessKey\"" + crlf);
        request.writeBytes("Content-Type: application/json" + crlf);
        request.writeBytes(crlf);
        request.writeBytes(accessKey + crlf);

        // 2. Image data
        request.writeBytes(twoHyphens + boundary + crlf);
        request.writeBytes("Content-Disposition: form-data; name=\"files\"; filename=\"elephants1.png\"" + crlf);
        request.writeBytes("Content-Type: image/jpeg" + crlf);
        request.writeBytes(crlf);
        request.write(imageBytes);

        request.writeBytes(crlf);
        request.writeBytes(twoHyphens + boundary + twoHyphens + crlf);
        request.flush();
        request.close();

        int response_code = urlConn.getResponseCode();
        System.out.println("Connection response code : [" + response_code + "]");

        // [2-3]. 연결 요청 확인.
        // 실패 시 null을 리턴하고 메서드를 종료.
        if (response_code != HttpsURLConnection.HTTP_OK){
            return "Response Code : " + Integer.toString(response_code);	// response 200
        } else {
            InputStream responseStream = new BufferedInputStream(urlConn.getInputStream());
            BufferedReader responseStreamReader = new BufferedReader(new InputStreamReader(responseStream, StandardCharsets.UTF_8));

            String outputResponse = "";
            StringBuilder stringBuilder = new StringBuilder();

            while ((outputResponse = responseStreamReader.readLine()) != null) {
                stringBuilder.append(outputResponse).append("\n");
            }

            responseStreamReader.close();
            strResponse = stringBuilder.toString();

            return strResponse;
        }
    } catch (IOException e) {   // for URL.
        e.printStackTrace();
    }                           // for openConnection().
    finally {
        if (urlConn != null)
            urlConn.disconnect();
    }
    return null;
} } ```
</code></pre></div></div>

<p>달랑 request 함수 하나만 구현하였다. 이제부터는 각 구성 별 코드 블럭에 대한 설명과 참고사항들이다.</p>

<hr />

<p><em><strong>1. 우리가 아까 헤더 정보 찾기에서 봤었던 boundary와, crlf(줄바꿈), two-hypens 변수를 할당한다.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">crlf</span> <span class="o">=</span> <span class="s">"\r\n"</span><span class="o">;</span>     <span class="c1">// carriage return + line feed</span>
<span class="nc">String</span> <span class="n">twoHyphens</span> <span class="o">=</span> <span class="s">"--"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">boundary</span> <span class="o">=</span> <span class="s">"----WebKitFormBoundarynuXSuFo6d9f2xtbb"</span><span class="o">;</span>
</code></pre></div></div>
<p>boundary는 임의로 설정 가능하다고 하지만, 웹알못인 필자는 잘 몰라서 browser에서 보여준 것을 썼다.</p>

<hr />

<p><em><strong>2. URL 객체를 만들고, Connection을 활성화한다.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">_url</span><span class="o">);</span>
<span class="n">urlConn</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpsURLConnection</span><span class="o">)</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
</code></pre></div></div>

<hr />

<p><em><strong>3. 헤더 정보를 입력한다.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span> <span class="c1">// URL 요청에 대한 메소드 설정 : POST.</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"USER-AGENT"</span><span class="o">,</span> <span class="s">"Mozilla/5.0"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"ACCEPT-LANGUAGE"</span><span class="o">,</span> <span class="s">"en-us,en;0.5"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setDoInput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setUseCaches</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"Connection"</span><span class="o">,</span> <span class="s">"keep-alive"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"User-Agent"</span><span class="o">,</span> <span class="s">"CodeJava Agent"</span><span class="o">);</span>
<span class="n">urlConn</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"multipart/form-data; boundary="</span> <span class="o">+</span> <span class="n">boundary</span><span class="o">);</span>
</code></pre></div></div>
<p>이전에 web-browser에서 살펴 본 헤더 정보들이다. 
Content-Type은 <code class="language-plaintext highlighter-rouge">"multipart/form-data"</code> 형식이고, <code class="language-plaintext highlighter-rouge">;</code> 이후에 boundary 정보를 위와 같이 넣어주면 된다.</p>

<p>또한, POST method이므로 <code class="language-plaintext highlighter-rouge">urlConn.setRequestMethod()</code> 의 파라미터로 _<strong>“POST”</strong>_를 넣어주었다.</p>

<p>이 외에</p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">"USER-AGENT"</code> : web browser에서 확인 가능.
<code class="language-plaintext highlighter-rouge">"ACCEPT-LANGUAGE"</code> : <em><strong>“en-us,en;0.5”</strong></em> 로 고정해줬다.
<code class="language-plaintext highlighter-rouge">"Connection"</code> : web browser에서 확인 가능.
<code class="language-plaintext highlighter-rouge">"User-Agent"</code> : <em><strong>“CodeJava Agent”</strong></em> 로 고정해줬다.</p>

  <p><code class="language-plaintext highlighter-rouge">urlConn.setDoInput(true)</code>
<code class="language-plaintext highlighter-rouge">urlConn.setDoOutput(true)</code>
<code class="language-plaintext highlighter-rouge">urlConn.setUseCaches(false)</code> : 위 3개는 true / true / false 로 고정해주었다.</p>
</blockquote>

<p>등을 적어준다.</p>

<hr />

<p><em><strong>4. form-data를 입력한다.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DataOutputStream</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="n">urlConn</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>

<span class="c1">// Write key and values</span>
<span class="c1">// 1. Access Key</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Disposition: form-data; name=\"accessKey\""</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Type: application/json"</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">accessKey</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>

<span class="c1">// 2. Image data</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Disposition: form-data; name=\"files\"; filename=\"anything.png\""</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"Content-Type: image/jpeg"</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">imageBytes</span><span class="o">);</span>

<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">boundary</span> <span class="o">+</span> <span class="n">twoHyphens</span> <span class="o">+</span> <span class="n">crlf</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="n">request</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>

<p>사실상 이번 개발에서 <strong>가장</strong> 중요한 부분이다.
나는 이런 request를 처음보내서, 3일을 헤맸었다.</p>

<p><strong>실제 request를 보낼 데이터들의 명세서(?)를 적어주는 부분이다.</strong>
아까 요청 데이터 항목에서 봤었던</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundaryAYuewg7muT6zRKkc (+ crlf)
Content-Disposition: form-data; name="files"; filename="bird.jpg" (+ crlf)
Content-Type: image/jpeg (+ crlf)
(+ crlf)
(+ crlf)
------WebKitFormBoundaryAYuewg7muT6zRKkc-- (+ crlf)
(+ crlf)
</code></pre></div></div>
<p>이 부분을 적어주는 것이다.</p>

<ul>
  <li>항상 시작은 twoHypens + boundary + crlf로 시작한다.</li>
  <li>Content-Disposition 을 적어준다. 문자열이므로 웹페이지에서 보이는 그대로 적어주면 된다. <strong>crlf 를 붙인다.</strong></li>
  <li>Content-Type 을 적어준다. <strong>crlf 를 붙인다.</strong></li>
  <li><strong>crlf 를 붙인다.</strong></li>
  <li><em>실제로 보낼(POST) 데이터를 적어준다.</em>
    <ul>
      <li><strong>String 일 경우</strong> : request.writeBytes()</li>
      <li><strong>byte[] (image)일 경우</strong> : request.write()</li>
    </ul>
  </li>
  <li><strong>crlf 를 붙인다.</strong></li>
  <li>항상 마지막은 twoHypens + boundary + twoHypens + crlf 로 마무리한다.</li>
  <li>더 이상 보낼 데이터가 없으면 : <code class="language-plaintext highlighter-rouge">request.flush()</code> 및 <code class="language-plaintext highlighter-rouge">request.close()</code> 로 POST를 종료한다.</li>
</ul>

<p>이렇게 하면 실제 API Endpoint 서버에 POST 동작이 수행된다.</p>

<hr />

<p><em><strong>5. 응답 코드(Response Code) 및 응답 문자열을 확인한다.</strong></em></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">response_code</span> <span class="o">=</span> <span class="n">urlConn</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Connection response code : ["</span> <span class="o">+</span> <span class="n">response_code</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>

<span class="c1">// [2-3]. 연결 요청 확인.</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response_code</span> <span class="o">!=</span> <span class="nc">HttpsURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">){</span>
    <span class="k">return</span> <span class="s">"Response Code : "</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">response_code</span><span class="o">);</span>	<span class="c1">// response 200</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">InputStream</span> <span class="n">responseStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">urlConn</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
    <span class="nc">BufferedReader</span> <span class="n">responseStreamReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">responseStream</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>

    <span class="nc">String</span> <span class="n">outputResponse</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>

    <span class="k">while</span> <span class="o">((</span><span class="n">outputResponse</span> <span class="o">=</span> <span class="n">responseStreamReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">outputResponse</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">responseStreamReader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="n">strResponse</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">strResponse</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>응답은 <code class="language-plaintext highlighter-rouge">InputStream</code> 과 <code class="language-plaintext highlighter-rouge">BufferedReader</code> 클래스에서 수행한다.
<code class="language-plaintext highlighter-rouge">BufferedReader</code> 클래스의 객체가 <code class="language-plaintext highlighter-rouge">InputStream</code> 클래스의 객체를 받는데, 이 <code class="language-plaintext highlighter-rouge">InputStream</code> 의 객체는 <code class="language-plaintext highlighter-rouge">urlConn.getInputStream()</code> 을 파라미터로 받는다.</p>

<p>(사실 response 부분은 아마 전 세계의 android http connection 모든 코드에서 동일하게 적용될 것이다.)</p>

<p>이렇게 해서, endline까지 while문으로 <code class="language-plaintext highlighter-rouge">readline()</code> 을 수행하여 <code class="language-plaintext highlighter-rouge">StringBuilder</code> 객체에 결과 문자열을 저장한다.</p>

<p>이렇게 나온 response 문자열은, 아까 <strong>MainActivity.class</strong> 소스 코드의 NetworkTask 클래스 내부
<code class="language-plaintext highlighter-rouge">result = requestHttpsURLConnection.request(url, accessKey, values);</code>
result 변수에 저장된다.</p>

<hr />

<h2 id="4-finish">4. Finish</h2>

<p>거의 다 왔다.</p>

<p>챕터 3의 <code class="language-plaintext highlighter-rouge">request</code> 함수는 <code class="language-plaintext highlighter-rouge">doInBackground</code>에서 수행되었고,
request 의 결과는 <code class="language-plaintext highlighter-rouge">doInBackground</code> 함수 내부의 <code class="language-plaintext highlighter-rouge">result</code> 변수에 저장되었으며,
해당 <code class="language-plaintext highlighter-rouge">result</code> 변수를 return 하면 <code class="language-plaintext highlighter-rouge">onPostExecuted</code> 함수에서 result 변수의 값을 받아올 수 있다.
(이건 정해진 구조이다.)</p>

<p>그러면 이제 <code class="language-plaintext highlighter-rouge">onPostExecuted()</code> 함수를 다시 살펴보자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">outputs</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">image</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="kt">double</span> <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="no">F</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">labelName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">JSONArray</span> <span class="n">jsonArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">JSONObject</span> <span class="n">tempJsonObject</span> <span class="o">=</span> <span class="n">jsonArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"image"</span><span class="o">);</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">tempJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"outputs"</span><span class="o">);</span>

                <span class="nc">JSONArray</span> <span class="n">jsonOutputsArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">(</span><span class="n">outputs</span><span class="o">);</span>

                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">JSONObject</span> <span class="n">tempOutputsJsonObject</span> <span class="o">=</span> <span class="n">jsonOutputsArray</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                    <span class="n">labelName</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"label"</span><span class="o">);</span>
                    <span class="kt">double</span> <span class="n">tempSoftmaxValue</span> <span class="o">=</span> <span class="n">tempOutputsJsonObject</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="s">"softmax"</span><span class="o">);</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">maxSoftmax</span> <span class="o">&lt;</span> <span class="n">tempSoftmaxValue</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">maxSoftmax</span> <span class="o">=</span> <span class="n">tempSoftmaxValue</span><span class="o">;</span>
                        <span class="k">switch</span> <span class="o">(</span><span class="n">labelName</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">case</span> <span class="s">"0"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"bird"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"1"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"cat"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"2"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"deer"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"3"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"dog"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"4"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"frog"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="s">"5"</span><span class="o">:</span>
                                <span class="n">maxLabelName</span> <span class="o">=</span> <span class="s">"horse"</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[onPostExecute] output is null state."</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">_resultView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Result : ["</span> <span class="o">+</span> <span class="n">maxLabelName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>우리는 맨 처음에 Postman 으로 확인했을 때, json 형태의 응답이 오는 것을 알 수 있다.
그렇기 때문에 android에서 사용 가능한 JSON class를 import 하여 파싱하였다.</p>

<p>[ ] 로 시작하면 JSONArray로 객체를 만들고, { } 로 시작하면 JSONObject로 객체를 만들면 된다.</p>

<p>이렇게 파싱을 하고 나서, TextView 에 추론 결과 category를 적어주면 개발이 끝나게 된다.</p>

<hr />

<blockquote>
  <ul>
    <li>
      <p><strong>버그 1</strong> : AsyncTask로 수행하지 않으면, Android main thread에서 자체적으로 blocking을 한다.</p>
    </li>
    <li>
      <p><strong>버그 2</strong> : 헤더를 잘못 적으면, response string 이 전부 깨져서 올 수 있다. 이럴 경우 
<strong>헤더를 하나씩 소거하며 어떤 헤더를 잘못 적었는지 체크하고, 해당 헤더의 올바른 값을 찾거나 혹은 안써줘도 될 경우 그냥 쓰지말자…</strong></p>
    </li>
    <li><strong>참고 1</strong> : 나의 경우에서는 AccessKey를 넣어주기 때문에 Https 서버여도 POST가 가능했다. (별도 인증이 필요없음.) 
HTTP 통신의 경우 포스팅한 것처럼 하면 된다. 단, 클래스 import는 
<code class="language-plaintext highlighter-rouge">import javax.net.ssl.HttpsURLConnection;</code> 대신 <code class="language-plaintext highlighter-rouge">import java.net.HttpURLConnection;</code> 을 써주고
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HttpURLConnection urlConn = null;
urlConn = (HttpURLConnection) url.openConnection();
</code></pre></div>      </div>
      <p>으로 바꿔주자.</p>
    </li>
    <li>
      <p><strong>참고 2</strong> : Https의 경우 CA(인증서)와 같은 인증 정보가 별도로 필요하다고 한다.</p>
    </li>
    <li>
      <p><strong>참고 3</strong> : AsyncTask는 반드시 상속받아야 한다.</p>
    </li>
    <li><strong>참고 4</strong> : POST가 제대로 이루어지지 않았을 경우(response 400 code처럼) web browser 혹은 API 문서를 보고, 어떤 형태인지, Content-Type, Content-Disposition 등을 <strong>반드시</strong> 확인하자.</li>
  </ul>
</blockquote>


</div>

<div class="tags">
    
</div>


<p><strong>Share</strong></p>
<div class="buttons ">
    <a class="button is-medium is-facebook"
       onclick="window.open('https://www.facebook.com/share.php?u=http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/');">
        <span class="icon"><i class="fab fa-facebook fa-lg"></i></span>
    </a>
    <a class="button is-medium is-twitter"
       onclick="window.open('https://twitter.com/intent/tweet?text=http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/');">
        <span class="icon"><i class="fab fa-twitter fa-lg"></i></span>
    </a>
    <a class="button is-medium is-linkedin"
       onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/&title=%5BAndroid%2FJava%5D+HttpURLConnection%EC%9C%BC%EB%A1%9C+HTTP+POST+request%ED%95%98%EA%B8%B0&summary=&source=');">
        <span class="icon"><i class="fab fa-linkedin fa-lg"></i></span>
    </a>
    <a class="button is-medium is-reddit"
       onclick="window.open('https://reddit.com/submit?url=http://localhost:4000/android/2022/04/06/Android-HttpURLConnection-HTTP-POST-Request/');">
        <span class="icon"><i class="fab fa-reddit fa-lg"></i></span>
    </a>
</div>



  


                </div>
                
            </div>
        </div>
    </section>
    
        <footer class="footer">
    <div class="container">
        
        
        <div class="columns is-multiline">
            
            <div class="column has-text-centered">
                <div>
                    <a href="/" class="link">Home</a>
                </div>
            </div>
            
            <div class="column has-text-centered">
                <div>
                    <a href="/blog/" class="link">Blog</a>
                </div>
            </div>
            
            <div class="column has-text-centered">
                <div>
                    <a href="https://github.com/bolero2" class="link">Github Profile</a>
                </div>
            </div>
            
        </div>
        

        <div class="content is-small has-text-centered">
            <p class="">Contact ME : <a href="sheocjf1025@gmail.com">sheocjf1025@gmail.com</a></p>
        </div>
    </div>
</footer>

    
    <script src="/assets/js/app.js" type="text/javascript"></script><!-- footer scripts --></body>
</html>
